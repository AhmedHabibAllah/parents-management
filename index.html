<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</title>

  <style>
    :root {
      --primary-color: #8d6e63;
      --bg-color: #fdfdfd;
      --text-color: #000000;
      --accent-color: #5d4037;
      --sidebar-width: 350px;
      --col1-width: 60px;
      --col2-width: 110px;
      --col3-width: 300px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      margin: 0;
      min-height: 100vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      direction: rtl;
      font-size: 20px;
      color: #000;
    }

    /* Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª (Centered Boxes) */
    .center-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      background: var(--bg-color);
      transition: all 0.3s;
      overflow: auto;
      padding: 20px;
      box-sizing: border-box;
      max-height: 100vh;
      backdrop-filter: blur(5px);
    }

    .box {
      background: rgba(255, 255, 255, 0.9);
      padding: 40px;
      border-radius: 20px;
      width: 99.5%;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.18);
      text-align: center;
      max-height: calc(100vh - 60px);
      overflow: auto;
    }

    .box-large {
      width: 99.5%;
      height: auto;
      max-width: none;
      max-height: calc(100vh - 60px);
      overflow: auto;
    }

    h2 {
      margin-bottom: 20px;
      color: #000;
      text-shadow: 0 0 2px rgba(0,229,255,0.5);
    }

    .btn {
      width: 100%;
      padding: 0 16px;
      height: 60px;
      margin-bottom: 10px;
      font-size: 22px;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      background: linear-gradient(135deg, #a1887f 0%, #5d4037 100%);
      color: #fff;
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 900;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 15px rgba(93, 64, 55, 0.3), inset 0 2px 2px rgba(255,255,255,0.4);
      backdrop-filter: blur(4px);
    }

    .btn:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 8px 25px rgba(93, 64, 55, 0.5);
    }

    .btn-outline {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid #5d4037;
      color: #5d4037;
      font-weight: 700;
    }

    .btn-outline:hover {
      background: #5d4037;
      color: #fff;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
      color: #000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      margin-bottom: 15px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 20px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.9);
      color: #000;
      transition: 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
      outline: none;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard Layout) */
    #dashboardScreen {
      display: none;
      min-height: 100vh;
      width: 100%;
      position: relative;
      overflow: auto;
    }

    .main-content {
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      transition: margin-left 0.3s;
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.8);
      padding: 15px 20px;
      border-radius: 15px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      flex-wrap: wrap;
      gap: 10px;
    }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-container {
      background: rgba(255, 255, 255, 0.6);
      border-radius: 15px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
      backdrop-filter: blur(5px);
      overflow: auto;
      width: 100%;
      max-height: calc(100vh - 220px); /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© */
      padding-bottom: 15px; /* Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ */
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„ÙŠÙƒÙˆÙ† ÙˆØ§Ø¶Ø­Ø§Ù‹ */
    .table-container::-webkit-scrollbar, textarea::-webkit-scrollbar {
      height: 16px;
      width: 16px;
    }
    .table-container::-webkit-scrollbar-track, textarea::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .table-container::-webkit-scrollbar-thumb, textarea::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 8px;
      border: 3px solid #f1f1f1;
    }
    .table-container::-webkit-scrollbar-thumb:hover, textarea::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1600px;
    }

    thead {
      background: #f0f0f0;
      color: #000;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    th,
    td {
      padding: 20px;
      text-align: right;
      border-bottom: 1px solid #ccc;
      white-space: nowrap;
      color: #000;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.95);
      font-size: 20px;
    }

    .num-cell {
      direction: ltr;
      font-family: 'Segoe UI', sans-serif;
    }

    tr:hover {
      background-color: #f9f9f9;
      cursor: pointer;
    }

    tr.selected {
      background-color: #e0f7fa;
      border-right: 4px solid #00e5ff;
    }

    /* ØªØ«Ø¨ÙŠØª Ø£ÙˆÙ„ 3 Ø£Ø¹Ù…Ø¯Ø© (Sticky Columns) */
    th:nth-child(1), td:nth-child(1) {
      position: sticky;
      right: 0;
      z-index: 2;
      width: var(--col1-width);
      min-width: var(--col1-width);
      max-width: var(--col1-width);
      box-sizing: border-box;
      border-left: 1px solid #ddd;
      background-color: #fff;
    }

    th:nth-child(2), td:nth-child(2) {
      position: sticky;
      right: var(--col1-width);
      z-index: 2;
      width: var(--col2-width);
      min-width: var(--col2-width);
      max-width: var(--col2-width);
      box-sizing: border-box;
      border-left: 1px solid #ddd;
      background-color: #fff;
    }

    th:nth-child(3), td:nth-child(3) {
      position: sticky;
      right: calc(var(--col1-width) + var(--col2-width));
      z-index: 2;
      width: var(--col3-width);
      min-width: var(--col3-width);
      max-width: var(--col3-width);
      box-sizing: border-box;
      border-left: 2px solid #ccc;
      background-color: #fff;
      white-space: normal; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ */
    }

    /* Ø±ÙØ¹ Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø«Ø¨ØªØ© */
    thead th:nth-child(1), 
    thead th:nth-child(2),
    thead th:nth-child(3) {
      z-index: 6;
      background-color: #f0f0f0;
    }

    /* Ù…Ù‚Ø¨Ø¶ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    .resizer {
      position: absolute;
      left: 0;
      top: 0;
      width: 5px;
      height: 100%;
      cursor: col-resize;
      user-select: none;
      touch-action: none;
      z-index: 10;
    }
    .resizer:hover, .resizing {
      background-color: #2979ff;
      width: 7px;
    }
    th {
      position: relative;
    }

    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ… */
    tr.contacted-today,
    tr.contacted-today td {
      background-color: #b9f6ca !important; /* Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± ÙØ³ÙÙˆØ±ÙŠ ÙØ§ØªØ­ */
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: var(--sidebar-width);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 20px;
      background: linear-gradient(135deg, #00e5ff 0%, #2979ff 100%);
      color: #000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ (History) */
    .sidebar-right {
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      width: var(--sidebar-width);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar-right.active {
      transform: translateX(0);
    }

    .sidebar-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .info-group {
      margin-bottom: 15px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
    }

    .sidebar-right .sidebar-header {
      padding: 20px;
      background: linear-gradient(135deg, #00e5ff 0%, #2979ff 100%);
      color: #000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    .info-value {
      font-weight: bold;
      color: #333;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }

    .close-sidebar {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-group {
      margin-bottom: 20px;
      text-align: right;
    }

    .settings-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    textarea.excel-input {
      height: 150px;
      resize: none;
      font-family: monospace;
      font-size: 12px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .excel-preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }

    .excel-preview-table th,
    .excel-preview-table td {
      border: 1px solid #ddd;
      padding: 14px 16px;
      text-align: center;
      border-collapse: collapse;
      font-size: 16px;
    }

    .excel-preview-table th {
      background: linear-gradient(135deg, #00e5ff 0%, #2979ff 100%);
      color: white;
      position: sticky;
      top: 0;
      font-weight: 700;
      font-size: 17px;
    }

    .excel-preview-table tbody tr {
      transition: background-color 0.2s;
    }

    .excel-preview-table tbody tr:hover {
      background-color: #f5f5f5 !important;
    }

    .excel-preview-table tbody tr:nth-child(even) {
      background-color: #fafafa;
    }

    .excel-preview-table td[contenteditable="true"]:focus {
      background: #e3f2fd;
      outline: 2px solid #2979ff;
      z-index: 1;
    }

    .qr-container {
      text-align: center;
      margin-bottom: 20px;
      padding: 10px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - ØªØµÙ…ÙŠÙ… Ø£ÙƒØ¨Ø± ÙˆÙˆØ§Ø¶Ø­ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨ */
    .stat-btn {
      padding: 0 20px;
      height: 60px;
      font-size: 20px;
      border-radius: 10px;
      margin-left: 6px;
      background: linear-gradient(90deg, #d7ccc8, #bcaaa4);
      color: #3e2723;
      border: none;
      box-shadow: 0 6px 18px rgba(141, 110, 99, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .stat-outline {
      background: linear-gradient(90deg, #ffea00, #ff9100);
      color: #fff;
    }

    .stats-box {
      background: #ffffff;
      color: #000;
      font-weight: 700;
    }

    .stats-box h3 {
      font-size: 24px;
      color: #000;
      margin: 6px 0 12px;
    }

    .stats-box .excel-preview-table th,
    .stats-box .excel-preview-table td {
      font-size: 16px;
      padding: 12px;
      font-weight: 700;
    }

    .stats-box .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }

    .stats-box .controls select,
    .stats-box .controls button {
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 8px;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª */
    .chart-type-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      transition: 0.2s;
    }

    .chart-type-btn:hover {
      background: #f0f0f0;
    }

    .chart-type-btn.active {
      background: #2979ff;
      color: #fff;
      border-color: var(--primary-color);
    }

    /* Ù…ØªØ¬Ø§ÙˆØ¨: Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 768px) {
      .box {
        padding: 18px;
        width: 95%;
      }

      .btn {
        padding: 10px;
        font-size: 14px;
      }

      .stat-btn {
        padding: 10px;
        font-size: 14px;
      }

      .excel-preview-table th,
      .excel-preview-table td {
        font-size: 13px;
      }

      table {
        min-width: 600px;
      }
    }

    @media (max-width: 420px) {
      .header-bar {
        flex-direction: column;
        gap: 8px;
      }

      .header-bar h3 {
        font-size: 18px;
      }

      .stat-btn {
        width: 100%;
      }
    }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode {
      --bg-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode .box,
    body.dark-mode .header-bar,
    body.dark-mode .sidebar,
    body.dark-mode .sidebar-right,
    body.dark-mode .table-container,
    body.dark-mode .info-group,
    body.dark-mode .qr-container,
    body.dark-mode .stats-box,
    body.dark-mode .settings-group textarea {
      background: #1e1e1e !important;
      color: #e0e0e0 !important;
      border-color: #333 !important;
      box-shadow: none !important;
    }
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea {
      background: #2d2d2d !important;
      color: #fff !important;
      border-color: #444 !important;
    }
    body.dark-mode th,
    body.dark-mode td {
      background: #1e1e1e !important;
      color: #e0e0e0 !important;
      border-bottom-color: #333 !important;
    }
    body.dark-mode thead th {
      background: #252525 !important;
      color: #fff !important;
    }
    body.dark-mode tr:hover {
      background-color: #333 !important;
    }
    body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4, body.dark-mode h5, body.dark-mode h6 {
      color: #fff !important;
      text-shadow: none !important;
    }
    /* Sticky columns fix for dark mode */
    body.dark-mode th:nth-child(1), body.dark-mode td:nth-child(1),
    body.dark-mode th:nth-child(2), body.dark-mode td:nth-child(2),
    body.dark-mode th:nth-child(3), body.dark-mode td:nth-child(3) {
      background-color: #1e1e1e !important;
      border-left-color: #333 !important;
    }
  </style>
</head>

<body>

  <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù -->
  <div class="center-screen" id="employeeScreen">
    <div class="box" style="max-width: 600px; margin: 0 auto;">
      <h1 style="color:#000; font-size:36px; margin-bottom:5px; font-weight:900; text-shadow: 0 0 5px rgba(0,229,255,0.4);">Ù†Ø¸Ø§Ù… ØªØ­ØµÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h1>
      <h2 style="font-size:32px; color:#000; margin-top:0; margin-bottom:20px; font-weight:800;">Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©</h2>
      <h3 style="font-size:22px; color:#555; margin-top:0;">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h3>
      <p style="color:#666; margin-bottom:20px;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
      <div id="employeeButtons">
        <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ -->
      </div>
      <button class="btn btn-outline" onclick="openSettingsAdmin()" style="margin-top:20px;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</button>
      <div style="margin-top: 20px; font-size: 14px; color: #000;">
        <div style="font-weight: 900;">ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ± Ø§Ø³ØªØ§Ø° Ø§Ø­Ù…Ø¯ Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù„Ù‡</div>
        <a href="mailto:designissue@gmail.com" style="color: #000; text-decoration: none; font-weight: bold;">designissue@gmail.com</a>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard) -->
  <div id="dashboardScreen">

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="main-content" id="mainContent">
      <div class="header-bar" style="flex-direction: column; gap: 15px; align-items: stretch;">
        
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø¹Ù„ÙˆÙŠ: Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù - Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø© - Ø§Ù„Ù…Ø·ÙˆØ± -->
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <h3 id="employeeName" style="margin:0; font-size: 18px;"></h3>
            
            <h1 style="margin:0; font-family:'Traditional Arabic', serif; font-size:42px; color:#3e2723; background-color:#fff3e0; padding:5px 30px; border-radius:15px; font-weight:900; text-align:center; border:2px solid #8d6e63; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ø§Ù„Ø±ÙˆØ§Ø¨ÙŠ</h1>
    
            <div style="text-align: left; margin-left: 5px;">
                <div style="font-weight: 900; color: #000; font-size: 14px;">ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ± Ø§Ø³ØªØ§Ø° Ø§Ø­Ù…Ø¯ Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù„Ù‡</div>
                <a href="mailto:designissue@gmail.com" style="color: #000; text-decoration: none; font-weight: bold; font-size: 14px;">designissue@gmail.com</a>
            </div>
        </div>

        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø³ÙÙ„ÙŠ: Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± -->
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« -->
            <div style="display:flex; gap:10px; align-items:center; background: rgba(255,255,255,0.5); padding: 5px 15px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                <span style="font-weight:bold;">ğŸ” Ø¨Ø­Ø«:</span>
                <select id="searchColumn" onchange="filterTable()" style="margin:0; width:auto; height:40px; padding: 5px 10px;">
                    <option value="all">Ø´Ø§Ù…Ù„</option>
                    <option value="parent_name">Ø§Ù„Ø§Ø³Ù…</option>
                    <option value="parent_code">Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</option>
                    <option value="phone">Ø§Ù„Ø¬ÙˆØ§Ù„</option>
                    <option value="identity_no">Ø§Ù„Ù‡ÙˆÙŠØ©</option>
                    <option value="next_call_date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</option>
                </select>
                <input type="text" id="searchInput" oninput="filterTable()" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..." style="margin:0; height:40px; width:200px; padding: 5px 10px;">
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ -->
            <div style="display:flex; gap:5px; align-items:center;">
                <span style="font-size:14px; font-weight:bold;">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</span>
                <select id="sortCriteria" onchange="applySort()" style="padding:5px; font-size:14px; margin:0; height:40px; width:auto; border-radius:8px;">
                    <option value="serial_no">ğŸ”¢ Ø§Ù„ØªØ³Ù„Ø³Ù„</option>
                    <option value="updated_at">ğŸ“… Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</option>
                    <option value="next_call_date">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</option>
                    <option value="parent_name">abc Ø§Ù„Ø§Ø³Ù…</option>
                    <option value="final_balance">ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯</option>
                    <option value="call_count">ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</option>
                </select>
                <button id="sortDirectionBtn" class="btn btn-outline" onclick="toggleSortDirection()" style="width:40px; height:40px; margin:0; padding:0; display:flex; align-items:center; justify-content:center;" title="ØªØºÙŠÙŠØ± Ø§Ù„ØªØ±ØªÙŠØ¨">â¬‡ï¸</button>
            </div>

            <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
            <div style="display:flex; align-items:center; gap:8px;">
              <button class="stat-btn" onclick="openStats()" style="width:auto; display:inline-flex;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
              <button class="btn btn-outline" onclick="exportToExcel()" title="ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel" style="width:auto; display:inline-flex; background:#e8f5e9; color:#2e7d32; border-color:#2e7d32;">ğŸ“¥ Excel</button>
              <button class="btn btn-outline" onclick="toggleDarkMode()" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" style="width:auto; display:inline-flex;">ğŸŒ™</button>
              <button class="btn btn-outline" onclick="resetView()" title="ØªØ­Ø¯ÙŠØ« ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶" style="width:auto; display:inline-flex;">ğŸ”„</button>
              <button class="btn btn-outline" onclick="openEmployeeSettings()" style="width:auto; display:inline-flex;">âš™ï¸</button>
              <button class="btn" onclick="goBack()" style="width:auto; display:inline-flex; background:#ff1744; color:#000; border:1px solid #d50000;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
      </div>

      <div class="table-container">
        <table id="parentsTable">
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
              <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
              <th>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</th>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ØªØµÙ„</th>
              <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</th>
              <th>Ø±ØµÙŠØ¯ Ù1</th>
              <th>Ø±ØµÙŠØ¯ Ù2</th>
              <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Ø§Ù„ØµÙÙˆÙ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) -->
    <div class="sidebar" id="detailsSidebar">
      <div class="sidebar-header">
        <span id="sidebarTitle">ØªÙØ§ØµÙŠÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</span>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="close-sidebar" onclick="openEmployeeSettings()" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">âš™ï¸</button>
          <button class="close-sidebar" onclick="closeSidebar()">âœ•</button>
        </div>
      </div>

      <div class="sidebar-content">
        <div id="sidebarInfo"></div>

        <!-- QR Code -->
        <div id="qrCodeContainer" class="qr-container"></div>

        <hr style="border:0; border-top:1px solid #eee; margin:20px 0 10px;">
        <h3
          style="color: #2979ff; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
          Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>

        <label class="info-label">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</label>
        <input type="number" id="callCountInput" placeholder="0">

        <label class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="notesInput" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§..."></textarea>

        <label class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</label>
        <select id="callStatusSelect"></select>

        <label class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
        <input type="date" id="nextCallDateInput">

        <!-- ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ -->
        <button class="btn" style="background:linear-gradient(135deg, #ff9100, #ffea00); margin-bottom:10px;" onclick="openPayment()">
          ğŸ’³ Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        </button>

        <div class="action-buttons">
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn" style="background:linear-gradient(135deg, #00e676, #69f0ae); flex: 1; margin-bottom:10px;" onclick="openWhatsApp()">
              ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨
            </button>
            <div
              style="display: flex; align-items: center; background: #f8f9fa; padding: 0 10px; border-radius: 8px; height: 60px; border: 1px solid #ccc; margin-bottom:10px;">
              <input type="checkbox" id="whatsappSentCheckbox" style="width: 20px; height: 20px; margin: 0;">
              <label for="whatsappSentCheckbox"
                style="margin-right: 8px; font-size: 14px; cursor: pointer; white-space: nowrap;">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
            </div>
          </div>
        </div>
        
        <button class="btn" onclick="saveParentInteraction()" style="margin-bottom: 10px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn btn-outline" onclick="openFullParentDetailsModal()">ğŸ“„ ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø©</button>
      </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„) -->
    <div class="sidebar-right" id="historySidebar">
      <div class="sidebar-header">
        <span>Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</span>
        <button class="close-sidebar" onclick="closeSidebar()">âœ•</button>
      </div>
      <div class="sidebar-content" id="historyInfo"></div>
    </div>

  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† (Password masked) -->
  <div class="center-screen" id="adminLoginScreen" style="display:none; z-index:500;">
    <div class="box" style="width:380px; max-width:95%; margin:0 auto; text-align:right;">
      <h2 style="text-align:center;">ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
      <div style="padding:6px 0; text-align:right;">
        <label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù†</label>
        <input type="password" id="admin_login_input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
          style="width:100%; padding:10px; margin-top:6px;">
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn" onclick="submitAdminLogin()">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn btn-secondary" onclick="closeAdminLogin()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <div class="center-screen" id="settingsScreen" style="display:none; z-index:20;">
    <div class="box"
      style="width: 98%; max-width:none; height:98%; display:flex; flex-direction:column; text-align: right;">
      <h2 style="text-align:center;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>

      <div style="flex:1; overflow-y: auto; padding: 5px;">

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± -->
        <div style="display:flex; gap:20px; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
          <div style="flex:1;">
            <label>ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
            <input type="color" id="themeColor" style="height:40px; padding:2px;">
          </div>
          <div style="flex:2;">
            <label>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹</label>
            <input type="text" id="paymentUrlSetting" style="margin-bottom:0;">
          </div>
        </div>

        <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
          <label>ğŸ” ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</label>
          <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
            <input type="text" id="pass_emp1" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 1" style="margin:0;">
            <input type="text" id="pass_emp2" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 2" style="margin:0;">
            <input type="text" id="pass_emp3" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 3" style="margin:0;">
            <input type="text" id="pass_emp4" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 4" style="margin:0;">
          </div>

          <label style="display:block; margin-top:12px;">ğŸ§‘â€ğŸ’¼ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)</label>
          <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:6px;">
            <input type="text" id="name_emp1" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù 1" style="margin:0;">
            <input type="text" id="name_emp2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù 2" style="margin:0;">
            <input type="text" id="name_emp3" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù 3" style="margin:0;">
            <input type="text" id="name_emp4" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù 4" style="margin:0;">
          </div>
        </div>

        <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
          <label>ğŸ“ Ø®ÙŠØ§Ø±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø¶Ø¹ ÙƒÙ„ Ø®ÙŠØ§Ø± ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)</label>
          <textarea id="statusOptionsInput" placeholder="Ù…Ø´ØºÙˆÙ„
Ù„Ù… ÙŠØ±Ø¯
ØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚" style="height:250px; width:75%; margin:10px auto; display:block; padding:12px; box-sizing:border-box; overflow-y:scroll; border:3px solid #ccc; font-size:18px;"></textarea>
        </div>

        <div class="settings-group">
          <label> Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Excel)</label>
          <label
            style="font-size:1.1em; color:#2979ff; border-bottom:2px solid #eee; padding-bottom:5px;">ğŸ“‚
            Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù†Ø³Ø®/Ù„ØµÙ‚ Excel)</label>
          <p style="font-size:12px; color:#666; margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ØŒ Ø«Ù… Ø§Ø¶ØºØ· "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª
            Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.</p>
          <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap;">
            <select id="importEmpSelect"
              style="width:200px; margin:0; font-weight:bold; border:2px solid #2979ff;">
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>
              <option value="emp1">Ù…ÙˆØ¸Ù 1</option>
              <option value="emp2">Ù…ÙˆØ¸Ù 2</option>
              <option value="emp3">Ù…ÙˆØ¸Ù 3</option>
              <option value="emp4">Ù…ÙˆØ¸Ù 4</option>
            </select>
            <button class="btn btn-outline" onclick="loadDataToGrid()" style="width:auto; margin:0;">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
            <button class="btn btn-outline" onclick="togglePasteArea()" style="width:auto; margin:0;">ğŸ“‹ Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª
              Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="btn btn-outline" onclick="deleteEmployeeDataDB()"
              style="width:auto; margin:0; color:red; border-color:red; background:#fff5f5;">âŒ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
              Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
          </div>

          <textarea id="excelPasteArea" class="excel-input" style="display:none; margin-bottom:10px;"
            placeholder="Ø§Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ ÙˆØ§Ù„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§... (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ù… - Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ - Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ù‡ÙˆÙŠØ© - Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„Ù…Ø¯ÙˆØ± - Ù1 - Ù2 - Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)"
            oninput="convertPasteToGrid()">
        </textarea>

          <div id="gridContainer" style="max-height:300px; overflow:auto; border:1px solid #ddd; border-radius:8px;">
            <p style="text-align:center; padding:20px; color:#999;">Ø§Ø®ØªØ± "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ø£Ùˆ "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡
            </p>
          </div>
        </div>

      </div>

      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn" onclick="saveSettingsAndData(false, this)">ğŸ’¾ Ø­ÙØ¸ (Ø¨Ø¯ÙˆÙ† Ø¥ØºÙ„Ø§Ù‚)</button>
        <button class="btn btn-outline" onclick="saveSettingsAndData(true, this)">ğŸšª Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
        <button class="btn btn-outline" onclick="openAdvancedStats()">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</button>
        <button class="btn btn-secondary" onclick="closeSettings()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„) -->
  <div class="center-screen" id="adminScreen" style="display:none; z-index:30;">

    <!-- Ø´Ø§Ø´Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù (ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©) -->
    <div class="center-screen" id="employeeSettingsScreen" style="display:none; z-index:520;">
      <div class="box" style="width:420px; max-width:95%; margin:0 auto; text-align:right;">
        <h2 style="text-align:center;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h2>
        <div id="employeeSettingsTitle" style="text-align:center; font-weight:700; margin-bottom:8px; color:#333;">
        </div>
        <div style="padding:6px 0;">
          <label>ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</label>
          <input type="password" id="emp_pass_input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©">
          <label style="margin-top:10px; display:block;">ğŸ¨ ÙˆØ§Ø¬Ù‡Ø© Ø®Ø§ØµØ©</label>
          <input type="color" id="emp_theme_input" style="height:40px; padding:2px;">
          <div style="margin-top:8px; display:flex; gap:8px; justify-content:center;">
            <button class="btn btn-outline" onclick="resetEmployeeTheme()" style="width:auto;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
            <span style="align-self:center; color:#666; font-size:13px;">(Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ø­Ø³Ø§Ø¨Ùƒ ÙÙ‚Ø·)</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px; justify-content:center;">
          <button class="btn" onclick="saveEmployeeSettings()">Ø­ÙØ¸</button>
          <button class="btn btn-secondary" onclick="closeEmployeeSettings()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
    <div class="box box-large" style="display:flex; flex-direction:column;">
      <h2>ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ (ÙˆØ¶Ø¹ Ø§Ù„Ø¥ÙƒØ³Ù„)</h2>
      <p style="color:#666; font-size:14px;">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ù†Ø§ ÙˆÙ„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø«Ù… Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ ÙˆÙ„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§
        Ù„Ù„Ø­ÙØ¸. <br> <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ
        Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡.</p>

      <textarea id="adminDataInput"
        style="flex:1; white-space:pre; overflow:auto; font-family:monospace; font-size:12px; border:2px solid #2979ff;"
        placeholder="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."></textarea>

      <div style="display:flex; gap:10px; justify-content:center;">
        <button class="btn" onclick="saveAdminDataFull()" style="background:#d32f2f;">ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„</button>
        <button class="btn btn-outline" onclick="loadAdminData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="btn btn-secondary" onclick="closeAdminPanel()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Modal) -->
  <div class="center-screen" id="fullDetailsModal" style="display:none; z-index:600;">
    <div class="box" style="width: 600px; max-width: 95%; text-align: right;">
      <h2 style="color:#2979ff; border-bottom: 2px solid #eee; padding-bottom:10px;">ğŸ“„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h2>
      <div id="fullDetailsContent" style="max-height: 60vh; overflow-y: auto; padding: 10px;">
        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
      </div>
      <div style="margin-top:20px; text-align:center;">
        <button class="btn btn-secondary" onclick="document.getElementById('fullDetailsModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Drill-down) -->
  <div class="center-screen" id="statsDrillDownModal" style="display:none; z-index:650;">
    <div class="box box-large">
      <h2 id="drillDownTitle" style="color:#2979ff;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</h2>
      <div id="drillDownContent" style="max-height: 70vh; overflow: auto;"></div>
      <button class="btn btn-secondary" onclick="document.getElementById('statsDrillDownModal').style.display='none'" style="margin-top:15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://emrsfzmaqmfavehrdppw.supabase.co',
      'sb_publishable_dmZ-1l-BmDzIteU1IaSjnw_3TMkHMhw'
    );

    // ===== Usage tracking =====
    const pushUsageEvent = async (evt) => {
      try {
        await supabase.from('employee_usage').insert(evt);
      } catch (e) {
        console.debug('Supabase insert for usage event failed:', e?.message || e);
      }
    };

    const sessionStartTimes = {};

    const recordLogin = (employee) => {
      const now = Date.now();
      sessionStartTimes[employee] = now;
      pushUsageEvent({ employee, type: 'login', ts: new Date().toISOString() });
    };

    const recordLogout = (employee) => {
      try {
        const start = sessionStartTimes[employee];
        if (start) {
          const end = Date.now();
          const duration = Math.max(0, end - start);
          pushUsageEvent({
            employee,
            type: 'session',
            start: new Date(start).toISOString(),
            end: new Date(end).toISOString(),
            duration_ms: duration
          });
          delete sessionStartTimes[employee];
        } else {
          pushUsageEvent({ employee, type: 'logout', ts: new Date().toISOString() });
        }
      } catch (e) { console.error(e); }
    };

    let currentEmployee = "";
    let currentParentId = null;
    let currentParentCode = "";
    let currentParentPhone = "";
    let currentParentIdentity = "";

    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    let appConfig = {
      theme: '#00e5ff',
      paymentUrl: 'https://google.com',
      passwords: { emp1: '', emp2: '', emp3: '', emp4: '' },
      employeeNames: { emp1: 'Ù…ÙˆØ¸Ù 1', emp2: 'Ù…ÙˆØ¸Ù 2', emp3: 'Ù…ÙˆØ¸Ù 3', emp4: 'Ù…ÙˆØ¸Ù 4' },
      employeeThemes: {},
      statusOptions: "Ù…Ø´ØºÙˆÙ„\nÙ„Ù… ÙŠØ±Ø¯\nÙ…Ø¹ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯\nÙ…Ø¹ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…\nØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯"
    };

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function saveConfigToDB() {
      try {
        const { error } = await supabase.from('app_config').upsert({
          id: 1,
          config: appConfig,
          updated_at: new Date().toISOString()
        });
        if (error) {
          console.error('Error saving settings to DB:', error);
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù†Ø´Ø¦Ù‡
          if (error.message.includes('does not exist')) {
            await createTablesIfNotExist();
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
            await saveConfigToDB();
          }
        }
      } catch (e) {
        console.error('Failed to save config:', e);
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    async function createTablesIfNotExist() {
      try {
        console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©...');

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ app_config Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const { error: configError } = await supabase.rpc('create_tables_if_not_exist');

        if (configError) {
          console.log('RPC ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… SQL Ù…Ø¨Ø§Ø´Ø±Ø©...');
          // Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ÙØ±Ø¯ÙŠØ©
        }
      } catch (e) {
        console.error('Error in createTablesIfNotExist:', e);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadSettings() {
      try {
        const { data, error } = await supabase.from('app_config').select('config').eq('id', 1).single();

        if (error) {
          console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:', error.message);
          // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          await saveConfigToDB();
        } else if (data && data.config) {
          const parsed = data.config;
          appConfig = Object.assign({}, appConfig, parsed);

          // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          appConfig.passwords = Object.assign({ emp1: '', emp2: '', emp3: '', emp4: '' }, appConfig.passwords || {});
          appConfig.employeeNames = Object.assign({
            emp1: 'Ù…ÙˆØ¸Ù 1',
            emp2: 'Ù…ÙˆØ¸Ù 2',
            emp3: 'Ù…ÙˆØ¸Ù 3',
            emp4: 'Ù…ÙˆØ¸Ù 4'
          }, appConfig.employeeNames || {});
          appConfig.employeeThemes = Object.assign({}, appConfig.employeeThemes || {});

          console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', appConfig);
        }
      } catch (e) {
        console.error('Failed to load appConfig from DB:', e);
      }

      applyTheme();
      renderEmployeeButtons();
      
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    }

    function applyTheme() {
      const empTheme = (currentEmployee && appConfig.employeeThemes && appConfig.employeeThemes[currentEmployee]);
      document.documentElement.style.setProperty('--primary-color', empTheme || appConfig.theme);
    }

    function getEmployeeLabel(emp) {
      return (appConfig.employeeNames && appConfig.employeeNames[emp]) || emp;
    }

    function renderEmployeeButtons() {
      const container = document.getElementById('employeeButtons');
      container.innerHTML = '';
      ['emp1', 'emp2', 'emp3', 'emp4'].forEach((emp) => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.innerText = `ğŸ‘¤ ${getEmployeeLabel(emp)}`;
        btn.onclick = () => checkPasswordAndLogin(emp);
        container.appendChild(btn);
      });
    }

    window.checkPasswordAndLogin = (emp) => {
      const pass = appConfig.passwords[emp];
      if (pass && pass.trim() !== "") {
        const input = prompt("ğŸ”’ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
        if (input !== pass) {
          alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
          return;
        }
      }
      showDataForEmployee(emp);
      try { recordLogin(emp); } catch (e) { console.error(e); }
    };

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ±ØªÙŠØ¨
    window.currentEmployeeData = [];
    let currentSort = { field: 'serial_no', dir: 'asc' };

    window.applySort = () => {
      currentSort.field = document.getElementById('sortCriteria').value;
      sortAndRender();
      sortAndRender(); // This will sort and then call filterTable
    };

    window.toggleSortDirection = () => {
      currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      document.getElementById('sortDirectionBtn').innerText = currentSort.dir === 'asc' ? 'â¬‡ï¸' : 'â¬†ï¸';
      sortAndRender();
    };

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
    window.filterTable = () => {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const col = document.getElementById('searchColumn').value;
        
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø±ØªØ¨Ø© Ø¨Ø§Ù„ÙØ¹Ù„)
        const filtered = window.currentEmployeeData.filter(row => {
            if (!query) return true;
            if (col === 'all') {
                return [row.parent_name, row.parent_code, row.phone, row.identity_no]
                    .some(val => String(val || '').toLowerCase().includes(query));
            }
            return String(row[col] || '').toLowerCase().includes(query);
        });
        
        window.currentFilteredData = filtered;
        renderParentsTable(filtered);
    };

    window.sortAndRender = () => {
      if (!window.currentEmployeeData || window.currentEmployeeData.length === 0) return;
      
      const { field, dir } = currentSort;
      
      window.currentEmployeeData.sort((a, b) => {
        let valA = a[field];
        let valB = b[field];

        if (field === 'updated_at' || field === 'next_call_date') {
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ© ØªØ¹ØªØ¨Ø± Ù‚Ø¯ÙŠÙ…Ø© Ø¬Ø¯Ø§Ù‹)
            valA = valA ? new Date(valA).getTime() : 0;
            valB = valB ? new Date(valB).getTime() : 0;
        } else if (field === 'serial_no' || field === 'final_balance' || field === 'call_count') {
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            valA = Number(valA) || 0;
            valB = Number(valB) || 0;
        } else {
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ
            valA = (valA || '').toString().toLowerCase();
            valB = (valB || '').toString().toLowerCase();
        }

        if (valA < valB) return dir === 'asc' ? -1 : 1;
        if (valA > valB) return dir === 'asc' ? 1 : -1;
        return 0;
      });

      renderParentsTable(window.currentEmployeeData);
      // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± (Ø¥Ø°Ø§ ÙˆØ¬Ø¯) Ø«Ù… Ø§Ù„Ø¹Ø±Ø¶
      filterTable();
    };

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù - Ù…Ø¹Ø¯Ù„ Ø¨Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
    window.showDataForEmployee = async (employee) => {
      console.log(`Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆØ¸Ù: ${employee}`);
      currentEmployee = employee;
      applyTheme();

      document.getElementById("employeeName").innerText = "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… - " + getEmployeeLabel(employee);

      try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const { data, error } = await supabase
          .from("parents")
          .select("*")
          .eq("employee", employee)
          .order("serial_no");

        console.log("Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ù…ÙˆØ¸Ù", employee, ":", { data, error });

        if (error) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);

          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù†Ø´Ø¦ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
          if (error.message.includes('does not exist') || error.message.includes('relation') || error.code === '42P01') {
            await createSampleData(employee);
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await showDataForEmployee(employee);
            return;
          }

          const tbody = document.getElementById("tableBody");
          tbody.innerHTML = `<tr><td colspan='9' style='text-align:center; color:red;'>
          Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}
          <br><button onclick="showDataForEmployee('${employee}')" style="margin-top:10px; padding:5px 15px; background:#1976d2; color:white; border:none; border-radius:5px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </td></tr>`;
          return;
        }

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan='9' style='text-align:center; color:orange;'>
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆØ¸Ù ${getEmployeeLabel(employee)}. 
          <br>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.
        </td></tr>`;
        } else {
          // Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
          let interactions = [];

          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ù„Ø¬Ù„Ø¨ ØªÙØ§Ø¹Ù„Ø§ØªÙ‡Ù… Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…ÙˆØ¸Ù (Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„)
          const parentCodes = data.map(p => p.parent_code).filter(c => c);

          if (parentCodes.length > 0) {
            const { data: intData, error: intError } = await supabase
              .from('interactions')
              .select('*')
              .in('parent_code', parentCodes)
              .order('updated_at', { ascending: false })
              .range(0, 4999);

            if (!intError && intData) {
              interactions = intData;
            }
          }

          const intMap = {};
          interactions.forEach(i => {
            // Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø© ØªØ¸Ù‡Ø± Ù„ÙƒÙ„ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„
            if (!intMap[i.parent_code]) {
              intMap[i.parent_code] = i;
            }
          });

          // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­ÙØ¸Ù‡Ø§
          window.currentEmployeeData = data.map(p => {
            const interaction = intMap[p.parent_code]; // can be undefined
            const merged = { ...p, ...interaction };
            // If there was no interaction, the `updated_at` from the parent record is used, which is wrong.
            // It reflects data import time, not contact time. We nullify it to fix the "contacted today" check.
            if (!interaction) {
              merged.updated_at = null;
            }
            return merged;
          });

          // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø±ØªØ¨Ø§Ù‹
          sortAndRender();
        }

        document.getElementById("employeeScreen").style.display = "none";
        document.getElementById("dashboardScreen").style.display = "block";

      } catch (e) {
        console.error("Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", e);
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = `<tr><td colspan='9' style='text-align:center; color:red;'>
        Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${e.message}
        <br><button onclick="showDataForEmployee('${employee}')" style="margin-top:10px; padding:5px 15px; background:#1976d2; color:white; border:none; border-radius:5px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
      </td></tr>`;
      }
    };

    window.renderParentsTable = (dataList) => {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); // ØªØµÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª Ù„Ø­Ø³Ø§Ø¨ ÙØ±Ù‚ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø¯Ù‚Ø©

        dataList.forEach(p => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„ Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ
            let rowClass = "";
            let statusBadge = "";

            if (p.updated_at) {
              const lastCallDate = new Date(p.updated_at);
              lastCallDate.setHours(0, 0, 0, 0); // ØªØµÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª

              const diffTime = todayDate - lastCallDate;
              const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

              if (diffDays === 0) {
                rowClass = "contacted-today";
                statusBadge = ' âœ…';
              } else if (diffDays > 0) {
                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¨Ø§Ù„Ø£Ø­Ù…Ø± Ø¥Ø°Ø§ Ù…Ø± Ø£ÙƒØ«Ø± Ù…Ù† 30 ÙŠÙˆÙ…
                const badgeColor = diffDays > 30 ? '#d32f2f' : '#607d8b';
                // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙˆØªÙ†Ø³ÙŠÙ‚Ù‡
                statusBadge = ` <span style="display:inline-block; background:${badgeColor}; color:white; padding:4px 12px; border-radius:8px; font-size:16px; margin-right:5px; font-weight:bold; min-width:30px; text-align:center;" title="ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…">${diffDays}</span>`;
              }
            }

            let nextCallStyle = "";
            if (p.next_call_date) {
                const parts = p.next_call_date.split('-');
                if (parts.length === 3) {
                    const nextDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    if (nextDate < todayDate) {
                        nextCallStyle = "background-color:#ffcdd2; color:#b71c1c; font-weight:bold;";
                    }
                }
            }

            const tr = document.createElement("tr");
            if (rowClass) tr.className = rowClass;
            tr.onclick = () => selectParent(tr, p);
            tr.innerHTML = `
            <td>${p.serial_no || '-'}</td>
            <td>${p.parent_code || '-'}</td>
            <td><strong>${p.parent_name || '-'}${statusBadge}</strong></td>
            <td>${p.identity_no || '-'}</td>
            <td class="num-cell" style="text-align:right;">${p.phone || '-'}</td>
            <td class="num-cell" style="text-align:center; direction:ltr;">${p.updated_at ? new Date(p.updated_at).toLocaleDateString('en-GB') : '-'}</td>
            <td class="num-cell" style="text-align:center; direction:ltr; ${nextCallStyle}">${p.next_call_date || '-'}</td>
            <td>${p.employee ? getEmployeeLabel(p.employee) : '-'}</td>
            <td class="num-cell">${(p.carried_balance || 0).toLocaleString('en-US')}</td>
            <td class="num-cell">${(p.term1_balance || 0).toLocaleString('en-US')}</td>
            <td class="num-cell">${(p.term2_balance || 0).toLocaleString('en-US')}</td>
            <td class="num-cell" style="color:${(p.final_balance || 0) > 0 ? 'red' : 'green'}">${(p.final_balance || 0).toLocaleString('en-US')}</td>
          `;
            tbody.appendChild(tr);
        });
    };

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    async function createSampleData(employee) {
      console.log(`Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…ÙˆØ¸Ù: ${employee}`);

      const sampleData = {
        emp1: [
          { parent_code: 'EMP1_001', parent_name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', identity_no: '1234567890', phone: '0501234567', serial_no: 1, carried_balance: 1000, term1_balance: 500, term2_balance: 300, final_balance: 1800 },
          { parent_code: 'EMP1_002', parent_name: 'Ø³Ø§Ù„Ù… Ø¹Ù„ÙŠ', identity_no: '2345678901', phone: '0512345678', serial_no: 2, carried_balance: 2000, term1_balance: 1000, term2_balance: 500, final_balance: 3500 }
        ],
        emp2: [
          { parent_code: 'EMP2_001', parent_name: 'Ù…Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯', identity_no: '3456789012', phone: '0523456789', serial_no: 1, carried_balance: 1500, term1_balance: 750, term2_balance: 250, final_balance: 2500 },
          { parent_code: 'EMP2_002', parent_name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø³Ø¹ÙŠØ¯', identity_no: '4567890123', phone: '0534567890', serial_no: 2, carried_balance: 3000, term1_balance: 1500, term2_balance: 800, final_balance: 5300 }
        ],
        emp3: [
          { parent_code: 'EMP3_001', parent_name: 'Ø®Ø§Ù„Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†', identity_no: '5678901234', phone: '0545678901', serial_no: 1, carried_balance: 1200, term1_balance: 600, term2_balance: 300, final_balance: 2100 }
        ],
        emp4: [
          { parent_code: 'EMP4_001', parent_name: 'Ù†Ø§ØµØ± ÙÙ‡Ø¯', identity_no: '6789012345', phone: '0556789012', serial_no: 1, carried_balance: 2500, term1_balance: 1200, term2_balance: 600, final_balance: 4300 }
        ]
      };

      const data = sampleData[employee] || [];

      if (data.length > 0) {
        try {
          // Ø¥Ø¶Ø§ÙØ© employee Ø¥Ù„Ù‰ ÙƒÙ„ Ø³Ø¬Ù„
          const records = data.map(item => ({ ...item, employee }));

          const { error } = await supabase
            .from('parents')
            .insert(records);

          if (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©:', error);
          } else {
            console.log(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${data.length} Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù ${employee}`);
          }
        } catch (e) {
          console.error('Ø®Ø·Ø£ ÙÙŠ createSampleData:', e);
        }
      }
    }

    // Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ„ÙŠ Ø£Ù…Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    window.selectParent = (tr, data) => {
      // Highlight row
      document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
      tr.classList.add('selected');

      // Set Data
      currentParentId = data.id;
      currentParentCode = data.parent_code;
      currentParentPhone = data.phone;
      currentParentIdentity = data.identity_no;
      window.currentParentData = data; // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„

      // Generate QR Code
      const qrContainer = document.getElementById('qrCodeContainer');
      if (currentParentPhone) {
        const cleanPhone = currentParentPhone.replace(/\D/g, '');
        qrContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=tel:${cleanPhone}" alt="QR Call" style="display:block; margin:0 auto;"><span style="font-size:11px; color:#666;">Ø§Ù…Ø³Ø­ Ù„Ù„Ø§ØªØµØ§Ù„</span>`;
      } else {
        qrContainer.innerHTML = '';
      }

      // Populate Sidebar
      const infoDiv = document.getElementById('sidebarInfo');
      const formatLtr = (val) => `<span class="num-cell">${val}</span>`;
      const formatDate = (dateStr) => {
        if (!dateStr) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        try {
          return new Date(dateStr).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
        } catch (e) { return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­'; }
      };

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ Ø§ØªØµØ§Ù„ Ø³Ø§Ø¨Ù‚
      const hasHistory = (data.last_call_status && data.last_call_status.trim() !== "") ||
        (data.call_count > 0) ||
        (data.notes && data.notes.trim() !== "");

      // Check if the last interaction was by another employee
      const isOtherEmployee = hasHistory && data.employee && data.employee !== currentEmployee;
      const otherEmployeeStyle = isOtherEmployee ? 'style="background-color: #fffde7; border-left: 3px solid #fbc02d;"' : '';

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„)
      const historyDiv = document.getElementById('historyInfo');
      historyDiv.innerHTML = `
      <h3 style="color: #2979ff; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</h3>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø£Ø¬Ø±Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„</div><div class="info-value">${(hasHistory && data.employee) ? getEmployeeLabel(data.employee) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</div><div class="info-value">${hasHistory ? formatDate(data.updated_at) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</div><div class="info-value" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto; background:#f9f9f9; padding:8px; border-radius:4px;">${(hasHistory && data.notes) ? data.notes : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</div><div class="info-value" style="color: #2979ff;">${(hasHistory && data.last_call_status) ? data.last_call_status : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡</div><div class="info-value">${(hasHistory && data.next_call_date) ? data.next_call_date : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø³Ø§Ø¨Ù‚Ø§Ù‹</div><div class="info-value">${(hasHistory && data.whatsapp_sent) ? 'Ù†Ø¹Ù… âœ…' : 'Ù„Ø§ âŒ'}</div></div>
    `;

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ (Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±)
      infoDiv.innerHTML = `
      <h3 style="color: #2979ff; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h3>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø§Ø³Ù…</div><div class="info-value">${data.parent_name || '-'}</div></div>
      <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</div><div class="info-value">${formatLtr(data.identity_no || '-')}</div></div>
      <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div><div class="info-value">${formatLtr(data.phone || '-')}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="info-value" style="color:red; font-size: 1.2em;">${formatLtr((data.final_balance || 0).toLocaleString('en-US'))}</div></div>
      <div class="info-group"><div class="info-label">Ø±ØµÙŠØ¯ Ù1</div><div class="info-value">${formatLtr((data.term1_balance || 0).toLocaleString('en-US'))}</div></div>
      <div class="info-group"><div class="info-label">Ø±ØµÙŠØ¯ Ù2</div><div class="info-value">${formatLtr((data.term2_balance || 0).toLocaleString('en-US'))}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</div><div class="info-value">${formatLtr((data.carried_balance || 0).toLocaleString('en-US'))}</div></div>
    `;

      // Set Inputs
      document.getElementById('callCountInput').value = data.call_count || 0;
      document.getElementById('notesInput').value = data.notes || "";

      // Populate Status Dropdown
      const statusSelect = document.getElementById('callStatusSelect');
      statusSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© --</option>';
      const options = appConfig.statusOptions.split(/\r?\n|,/).map(s => s.trim()).filter(Boolean);
      options.forEach(opt => { statusSelect.innerHTML += `<option value="${opt}">${opt}</option>`; });
      statusSelect.value = data.last_call_status || "";

      // Date
      document.getElementById('nextCallDateInput').value = data.next_call_date || "";
      document.getElementById('whatsappSentCheckbox').checked = data.whatsapp_sent || false;

      // Show Sidebar
      document.getElementById('detailsSidebar').classList.add('active');
      document.getElementById('historySidebar').classList.add('active');
    };

    window.closeSidebar = () => {
      document.getElementById('detailsSidebar').classList.remove('active');
      document.getElementById('historySidebar').classList.remove('active');
      document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
    };

    window.saveParentInteraction = async () => {
      if (!currentParentCode) return alert("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±");

      try {
        const callsInput = document.getElementById('callCountInput').value;
        const calls = callsInput ? parseInt(callsInput) : 0;
        const notes = document.getElementById('notesInput').value;
        const status = document.getElementById('callStatusSelect').value;
        const nextDate = document.getElementById('nextCallDateInput').value;
        const whatsappSent = document.getElementById('whatsappSentCheckbox').checked;

        const { error } = await supabase
          .from('interactions')
          .upsert({
            parent_code: currentParentCode,
            employee: currentEmployee,
            call_count: calls,
            notes: notes,
            last_call_status: status,
            next_call_date: nextDate || null,
            whatsapp_sent: whatsappSent,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'parent_code,employee'
          });

        if (error) {
          console.error('Error saving interaction:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message);
        } else {
          alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
          closeSidebar();
          showDataForEmployee(currentEmployee);
        }
      } catch (e) {
        console.error("Network/Fetch error:", e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + e.message);
      }
    };

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    window.openFullParentDetailsModal = () => {
      if (!window.currentParentData) return;
      const d = window.currentParentData;
      const content = document.getElementById('fullDetailsContent');
      
      const formatVal = (v) => (v === null || v === undefined || v === '') ? '---' : v;
      const formatMoney = (v) => Number(v || 0).toLocaleString('en-US');

      content.innerHTML = `
        <table class="excel-preview-table" style="width:100%; text-align:right;">
          <tr><th colspan="2" style="background:#eee; color:#333;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</th></tr>
          <tr><td>Ø§Ù„Ø§Ø³Ù…</td><td>${formatVal(d.parent_name)}</td></tr>
          <tr><td>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ (Code)</td><td>${formatVal(d.parent_code)}</td></tr>
          <tr><td>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</td><td>${formatVal(d.identity_no)}</td></tr>
          <tr><td>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</td><td>${formatVal(d.phone)}</td></tr>
          
          <tr><th colspan="2" style="background:#eee; color:#333;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</th></tr>
          <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</td><td>${formatMoney(d.carried_balance)}</td></tr>
          <tr><td>Ø±ØµÙŠØ¯ Ø§Ù„ÙØµÙ„ 1</td><td>${formatMoney(d.term1_balance)}</td></tr>
          <tr><td>Ø±ØµÙŠØ¯ Ø§Ù„ÙØµÙ„ 2</td><td>${formatMoney(d.term2_balance)}</td></tr>
          <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</td><td style="font-weight:bold; color:${d.final_balance > 0 ? 'red' : 'green'}">${formatMoney(d.final_balance)}</td></tr>

          <tr><th colspan="2" style="background:#eee; color:#333;">Ø³Ø¬Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</th></tr>
          <tr><td>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</td><td>${formatVal(d.call_count)}</td></tr>
          <tr><td>Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</td><td>${formatVal(d.last_call_status)}</td></tr>
          <tr><td>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</td><td>${d.updated_at ? new Date(d.updated_at).toLocaleString('ar-EG') : '---'}</td></tr>
          <tr><td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</td><td>${formatVal(d.next_call_date)}</td></tr>
          <tr><td>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</td><td>${d.whatsapp_sent ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td></tr>
          <tr><td>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</td><td style="white-space:pre-wrap;">${formatVal(d.notes)}</td></tr>
        </table>
      `;
      document.getElementById('fullDetailsModal').style.display = 'flex';
    };

    window.goBack = () => {
      closeSidebar();
      document.getElementById("dashboardScreen").style.display = "none";
      document.getElementById("employeeScreen").style.display = "flex";
      try { recordLogout(currentEmployee); } catch (e) { console.error(e); }
    };

    window.openSettingsAdmin = () => {
      document.getElementById('admin_login_input').value = '';
      document.getElementById('adminLoginScreen').style.display = 'flex';
      setTimeout(() => { try { document.getElementById('admin_login_input').focus(); } catch (e) { } }, 50);
    };

    window.submitAdminLogin = () => {
      const pass = document.getElementById('admin_login_input').value;
      if (pass === 'admin123') {
        document.getElementById('adminLoginScreen').style.display = 'none';
        // Populate fields
        document.getElementById('themeColor').value = appConfig.theme;
        document.getElementById('paymentUrlSetting').value = appConfig.paymentUrl;
        document.getElementById('pass_emp1').value = appConfig.passwords.emp1 || '';
        document.getElementById('pass_emp2').value = appConfig.passwords.emp2 || '';
        document.getElementById('pass_emp3').value = appConfig.passwords.emp3 || '';
        document.getElementById('pass_emp4').value = appConfig.passwords.emp4 || '';
        document.getElementById('statusOptionsInput').value = appConfig.statusOptions;
        document.getElementById('name_emp1').value = appConfig.employeeNames.emp1 || 'Ù…ÙˆØ¸Ù 1';
        document.getElementById('name_emp2').value = appConfig.employeeNames.emp2 || 'Ù…ÙˆØ¸Ù 2';
        document.getElementById('name_emp3').value = appConfig.employeeNames.emp3 || 'Ù…ÙˆØ¸Ù 3';
        document.getElementById('name_emp4').value = appConfig.employeeNames.emp4 || 'Ù…ÙˆØ¸Ù 4';

        document.getElementById("settingsScreen").style.display = "flex";
      } else {
        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ');
      }
    };

    window.closeAdminLogin = () => { document.getElementById('adminLoginScreen').style.display = 'none'; };

    window.closeSettings = () => {
      document.getElementById("settingsScreen").style.display = "none";
    };

    window.saveAppSettings = async () => {
      appConfig.theme = document.getElementById('themeColor').value;
      appConfig.paymentUrl = document.getElementById('paymentUrlSetting').value;
      appConfig.passwords.emp1 = document.getElementById('pass_emp1').value;
      appConfig.passwords.emp2 = document.getElementById('pass_emp2').value;
      appConfig.passwords.emp3 = document.getElementById('pass_emp3').value;
      appConfig.passwords.emp4 = document.getElementById('pass_emp4').value;
      appConfig.statusOptions = document.getElementById('statusOptionsInput').value;
      appConfig.employeeNames = {
        emp1: document.getElementById('name_emp1').value || 'Ù…ÙˆØ¸Ù 1',
        emp2: document.getElementById('name_emp2').value || 'Ù…ÙˆØ¸Ù 2',
        emp3: document.getElementById('name_emp3').value || 'Ù…ÙˆØ¸Ù 3',
        emp4: document.getElementById('name_emp4').value || 'Ù…ÙˆØ¸Ù 4'
      };

      await saveConfigToDB();
      applyTheme();
      renderEmployeeButtons();
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    };

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
    window.openEmployeeSettings = () => {
      if (!currentEmployee) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      document.getElementById('employeeSettingsTitle').innerText = getEmployeeLabel(currentEmployee);
      document.getElementById('emp_pass_input').value = appConfig.passwords[currentEmployee] || '';
      document.getElementById('emp_theme_input').value = (appConfig.employeeThemes && appConfig.employeeThemes[currentEmployee]) || appConfig.theme;
      document.getElementById('employeeSettingsScreen').style.display = 'flex';
    };

    window.saveEmployeeSettings = async () => {
      if (!currentEmployee) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      const pass = document.getElementById('emp_pass_input').value;
      const theme = document.getElementById('emp_theme_input').value;
      appConfig.passwords[currentEmployee] = pass;
      appConfig.employeeThemes = appConfig.employeeThemes || {};
      appConfig.employeeThemes[currentEmployee] = theme;
      await saveConfigToDB();
      applyTheme();
      alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù');
      document.getElementById('employeeSettingsScreen').style.display = 'none';
    };

    window.resetEmployeeTheme = async () => {
      if (!currentEmployee) return;
      if (appConfig.employeeThemes) delete appConfig.employeeThemes[currentEmployee];
      document.getElementById('emp_theme_input').value = appConfig.theme;
      await saveConfigToDB();
      applyTheme();
      alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ');
    };

    window.closeEmployeeSettings = () => { document.getElementById('employeeSettingsScreen').style.display = 'none'; };

    window.openWhatsApp = () => {
      if (!currentParentPhone) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„");
      let phone = currentParentPhone.replace(/\D/g, '');
      window.open(`https://wa.me/${phone}`, '_blank');
    };

    window.openPayment = () => {
      if (!currentParentIdentity) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±");
      window.open(`https://ncle-sms.com/Payment/?id=${currentParentIdentity}`, '_blank');
    };

    // ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =====
    function formatCurrency(v) {
      return Number(v || 0).toLocaleString('en-US');
    }

    window.openStats = async () => {
      try {
        const { data, error } = await supabase.from('parents').select('*');
        if (error) {
          alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ' + error.message);
          console.error(error);
          return;
        }

        // Ø¯Ù…Ø¬ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        const { data: interactions } = await supabase.from('interactions').select('*');
        let mergedData = data || [];

        if (interactions) {
          const intMap = {};
          interactions.forEach(i => intMap[i.parent_code] = i);
          mergedData = mergedData.map(p => {
            const i = intMap[p.parent_code];
            if (i) {
              return { ...p, ...i };
            }
            return p;
          });
        }

        const byEmp = {};
        const knownEmps = Object.keys(appConfig.employeeNames || {});
        knownEmps.forEach(e => {
          byEmp[e] = { count: 0, sum_final: 0, sum_carried: 0, debtors: 0, total_calls: 0, responded: 0 };
        });

        mergedData.forEach(r => {
          const emp = r.employee || 'emp1';
          if (!byEmp[emp]) byEmp[emp] = { count: 0, sum_final: 0, sum_carried: 0, debtors: 0, total_calls: 0, responded: 0 };
          byEmp[emp].count += 1;
          byEmp[emp].sum_final += Number(r.final_balance || 0);
          byEmp[emp].sum_carried += Number(r.carried_balance || 0);
          if ((r.final_balance || 0) > 0) byEmp[emp].debtors += 1;
          byEmp[emp].total_calls += Number(r.call_count || 0);
          if (r.last_call_status && r.last_call_status.trim() !== '') byEmp[emp].responded += 1;
        });

        const html = ['<div style="padding:10px; max-height:70vh; overflow:auto;">',
          '<h3 style="text-align:center;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ù…Ù„Ø®Øµ</h3>',
          '<div class="controls" style="justify-content:center;">',
          '<select id="statsMetric" onchange="renderStatsTable()" style="margin-left:5px;">',
          '<option value="sum_final">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</option>',
          '<option value="sum_carried">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</option>',
          '<option value="count">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</option>',
          '<option value="debtors">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†</option>',
          '<option value="total_calls">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</option>',
          '<option value="responded">Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯</option>',
          '</select>',
          '<select id="statsChartType" onchange="renderStatsTable()"><option value="bar">Ø£Ø¹Ù…Ø¯Ø©</option><option value="pie">Ø¯Ø§Ø¦Ø±ÙŠ</option><option value="doughnut">Ø¯ÙˆÙ†Ø§Øª</option><option value="line">Ø®Ø·ÙŠ</option></select>',
          '<button onclick="renderStatsTable()" class="btn">ØªØ­Ø¯ÙŠØ«</button>',
          '<button class="btn" onclick="saveStatsPDF(\'statsScreen\')">Ø­ÙØ¸ ÙƒÙ€ PDF</button>',
          '</div>',
          '<canvas id="statsChart" style="max-width:100%; height:300px;"></canvas>',
          '<div id="statsTable" style="margin-top:10px;"></div>',
          '<div style="text-align:center; margin-top:10px;"><button class="btn btn-secondary" onclick="closeStats()">Ø¥ØºÙ„Ø§Ù‚</button></div>',
          '</div>'].join('');

        const screen = document.createElement('div');
        screen.className = 'center-screen';
        screen.id = 'statsScreen';
        screen.style.zIndex = 520;
        screen.innerHTML = `<div class="box box-large stats-box">${html}</div>`;
        document.body.appendChild(screen);

        window.renderStatsTable = () => {
          const metric = document.getElementById('statsMetric')?.value || 'sum_final';
          const metricLabels = {
             'sum_final': 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ',
             'sum_carried': 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±',
             'count': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª',
             'debtors': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†',
             'total_calls': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª',
             'responded': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯'
          };

          const labelsIds = Object.keys(byEmp);
          const labels = labelsIds.map(id => getEmployeeLabel(id));
          const dataValues = labelsIds.map(k => byEmp[k][metric]);

          const tableHtml = ['<table class="excel-preview-table"><thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙˆØ±</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯</th></tr></thead><tbody>'];
          labelsIds.forEach(k => {
            tableHtml.push(`<tr><td>${getEmployeeLabel(k)}</td><td>${byEmp[k].count}</td><td>${formatCurrency(byEmp[k].sum_final)}</td><td>${formatCurrency(byEmp[k].sum_carried)}</td><td>${byEmp[k].debtors}</td><td>${byEmp[k].total_calls}</td><td>${byEmp[k].responded}</td></tr>`);
          });
          tableHtml.push('</tbody></table>');
          document.getElementById('statsTable').innerHTML = tableHtml.join('');

          // Chart
          try {
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (window._statsChart) window._statsChart.destroy();
            const selectedType = document.getElementById('statsChartType')?.value || 'bar';
            window._statsChart = new Chart(ctx, {
              type: selectedType,
              data: { labels, datasets: [{ label: metricLabels[metric], data: dataValues, backgroundColor: ['#1976d2', '#43a047', '#fbc02d', '#e64a19'] }] },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: selectedType === 'pie' || selectedType === 'doughnut' },
                  title: { display: true, text: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨: ' + metricLabels[metric], font: { size: 18, weight: '600' }, color: '#333' }
                },
                scales: selectedType === 'pie' || selectedType === 'doughnut' ? {} : {
                  y: { beginAtZero: true, ticks: { font: { size: 14 }, color: '#333' } },
                  x: { ticks: { font: { size: 14 }, color: '#333' } }
                }
              }
            });
          } catch (e) { console.error('Chart render failed', e); }
        };

        renderStatsTable();
      } catch (e) {
        console.error('Error in openStats:', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ' + e.message);
      }
    };

    window.closeStats = () => {
      const s = document.getElementById('statsScreen');
      if (s) s.remove();
    };

    window.saveStatsPDF = (elementId) => {
      const el = document.getElementById(elementId);
      if (!el) return;
      const box = el.querySelector('.box');
      html2canvas(box).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("stats.pdf");
      });
    };

    window.openAdvancedStats = async () => {
      // Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      const loadingId = 'loading-' + Date.now();
      const loadingHTML = `<div id="${loadingId}" class="center-screen" style="z-index:9999"><div class="box" style="width:auto"><h3>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3></div></div>`;
      document.body.insertAdjacentHTML('beforeend', loadingHTML);

      try {
        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data: parents, error: err1 } = await supabase.from('parents').select('employee, final_balance');
        const { data: interactions, error: err2 } = await supabase.from('interactions').select('employee, call_count, whatsapp_sent, updated_at, parent_code');
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
        let usage = [];
        try {
            const { data: u } = await supabase.from('employee_usage').select('employee, type, ts, start');
            if (u) usage = u;
        } catch(e) { console.log('Usage table info not available'); }

        if (err1) throw err1; // Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¢Ø¨Ø§Ø¡
        if (err2) throw err2; // Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        window.filterAndRenderStats = () => {
            const period = document.getElementById('advPeriodSelect').value;
            const dateFrom = document.getElementById('advDateFrom').value;
            const dateTo = document.getElementById('advDateTo').value;
            const headerLabel = document.getElementById('advDateHeaderLabel');

            let startDate = new Date(0); // 1970
            let endDate = new Date(8640000000000000); // Far future

            const now = new Date();
            now.setHours(0,0,0,0);
            
            let labelText = "ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª";

            if (period === 'today') {
                startDate = new Date(now);
                endDate = new Date(now); endDate.setHours(23,59,59,999);
                labelText = `Ø§Ù„ÙŠÙˆÙ…: ${now.toLocaleDateString('ar-EG')}`;
            } else if (period === 'week') {
                const day = now.getDay();
                const diff = now.getDate() - day + (day == 0 ? -6:1); // adjust when day is sunday
                startDate = new Date(now.setDate(diff));
                endDate = new Date(now); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23,59,59,999);
                labelText = `Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${startDate.toLocaleDateString('ar-EG')} - ${endDate.toLocaleDateString('ar-EG')}`;
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                labelText = `Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ${startDate.toLocaleDateString('ar-EG', {month:'long', year:'numeric'})}`;
            } else if (period === 'year') {
                startDate = new Date(now.getFullYear(), 0, 1);
                endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                labelText = `Ø³Ù†Ø©: ${now.getFullYear()}`;
            } else if (period === 'custom') {
                if(dateFrom) startDate = new Date(dateFrom);
                if(dateTo) { endDate = new Date(dateTo); endDate.setHours(23,59,59,999); }
                labelText = `ÙØªØ±Ø© Ù…Ø®ØµØµØ©: ${startDate.toLocaleDateString('ar-EG')} Ø¥Ù„Ù‰ ${endDate.toLocaleDateString('ar-EG')}`;
            }

            headerLabel.innerText = labelText;

            // ØªØµÙÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
            const filteredInteractions = (interactions || []).filter(i => {
                if (!i.updated_at) return false;
                const d = new Date(i.updated_at);
                return d >= startDate && d <= endDate;
            });

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const stats = {};
            const empKeys = Object.keys(appConfig.employeeNames || {emp1:'', emp2:'', emp3:'', emp4:''});
            empKeys.forEach(k => {
                stats[k] = { parents: 0, debt: 0, calls: 0, whatsapp: 0, logins: 0, contacted_parents_codes: [] };
            });

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø«Ø§Ø¨Øª Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø£Ù†Ù‡ Ø±ØµÙŠØ¯ Ø­Ø§Ù„ÙŠ)
            // Ù„ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø·Ù„Ø¨: "ØªØ¸Ù‡Ø± ÙƒÙ„ Ø§Ø³Ù…Ø§Ø¡ Ø§ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø§Ù…ÙˆØ± Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø¯Ù‡ Ø§Ù„ØªÙŠ Ø§Ø®ØªØ±ØªÙ‡Ø§"
            // Ù„Ø°Ø§ Ø³Ù†Ø±Ø¨Ø· Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø¨Ù…Ù† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù… ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„Ø© Drill-downØŒ Ø£Ù…Ø§ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ÙÙ‡ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
            (parents || []).forEach(p => {
                const e = p.employee || 'emp1';
                if (!stats[e]) stats[e] = { parents: 0, debt: 0, calls: 0, whatsapp: 0, logins: 0, contacted_parents_codes: [] };
                stats[e].parents++;
                stats[e].debt += (Number(p.final_balance) || 0);
            });

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (ØªØªØ£Ø«Ø± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®)
            filteredInteractions.forEach(i => {
                const e = i.employee || 'emp1';
                if (!stats[e]) stats[e] = { parents: 0, debt: 0, calls: 0, whatsapp: 0, logins: 0, contacted_parents_codes: [] };
                stats[e].calls += 1; // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ (Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡Ù…) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¬Ù…Ø¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ
                // Ø§Ù„Ø£Ø¯Ù‚: Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©
                if (i.whatsapp_sent) stats[e].whatsapp++;
                if (i.parent_code) stats[e].contacted_parents_codes.push(i.parent_code);
            });

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªØªØ£Ø«Ø± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ timestamp)
            // Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ `employee_usage` ÙŠØ­ØªÙˆÙŠ `ts` Ø£Ùˆ `start`.
            usage.forEach(u => {
                const e = u.employee || 'emp1';
                const timeStr = u.ts || u.start;
                if (timeStr) {
                    const d = new Date(timeStr);
                    if (d >= startDate && d <= endDate) {
                        if (!stats[e]) stats[e] = { parents: 0, debt: 0, calls: 0, whatsapp: 0, logins: 0, contacted_parents_codes: [] };
                        if (u.type === 'login') stats[e].logins++;
                    }
                }
            });

            window.currentStatsData = stats; // Ø­ÙØ¸ Ù„Ù„Ø±Ø³Ù…
            window.renderAdvChartAndTable();
        };

        // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const html = `
          <div style="padding:10px; height:100%; overflow:auto;">
            <h2 style="text-align:center; color:#2979ff;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø© ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
            
            <!-- Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
            <div style="background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #bbdefb;">
                <h3 id="advDateHeaderLabel" style="text-align:center; margin:0 0 10px 0; color:#1565c0;">ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª</h3>
                <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center;">
                    <select id="advPeriodSelect" onchange="toggleCustomDate(); filterAndRenderStats()" style="padding:8px; border-radius:5px;">
                        <option value="all">ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</option>
                        <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                        <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                        <option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                        <option value="year">Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</option>
                        <option value="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</option>
                    </select>
                    <span id="customDateSpan" style="display:none;">
                        Ù…Ù†: <input type="date" id="advDateFrom" onchange="filterAndRenderStats()">
                        Ø¥Ù„Ù‰: <input type="date" id="advDateTo" onchange="filterAndRenderStats()">
                    </span>
                    <button class="btn" style="width:auto; height:38px; font-size:14px;" onclick="filterAndRenderStats()">ØªØ­Ø¯ÙŠØ«</button>
                </div>
            </div>

            <div style="display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-bottom:20px; background:#f5f5f5; padding:15px; border-radius:10px;">
                <div style="flex:1; min-width:200px;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©:</label>
                    <select id="advMetricSelect" onchange="renderAdvChartAndTable()" style="width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;">
                        <option value="calls">ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù…</option>
                        <option value="logins">ğŸ” Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
                        <option value="whatsapp">ğŸ’¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</option>
                        <option value="parents">ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±)</option>
                        <option value="debt">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</option>
                    </select>
                </div>
                <div style="flex:1; min-width:200px;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø´ÙƒÙ„ Ø§Ù„Ù…Ø®Ø·Ø·:</label>
                    <select id="advTypeSelect" onchange="renderAdvChartAndTable()" style="width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;">
                        <option value="bar">ğŸ“Š Ø£Ø¹Ù…Ø¯Ø© (Bar)</option>
                        <option value="pie">ğŸ¥§ Ø¯Ø§Ø¦Ø±ÙŠ (Pie)</option>
                        <option value="doughnut">ğŸ© Ø­Ù„Ù‚ÙŠ (Doughnut)</option>
                        <option value="line">ğŸ“ˆ Ø®Ø·ÙŠ (Line)</option>
                        <option value="polarArea">â„ï¸ Ù‚Ø·Ø¨ÙŠ (Polar Area)</option>
                    </select>
                </div>
            </div>

            <div style="background:#fff; padding:10px; border-radius:10px; border:1px solid #eee; height:400px; position:relative;">
                <canvas id="advMainChart"></canvas>
            </div>

            <h3 style="margin-top:20px; border-bottom:2px solid #eee; padding-bottom:10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</h3>
            <div id="advStatsTableContainer" style="overflow-x:auto;"></div>

            <div style="text-align:center; margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn" onclick="saveStatsPDF('advStatsScreen')" style="width:auto; display:inline-block;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
                <button class="btn btn-secondary" onclick="document.getElementById('advStatsScreen').remove()" style="width:auto; display:inline-block;">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </div>
        `;

        const screen = document.createElement('div');
        screen.className = 'center-screen';
        screen.id = 'advStatsScreen';
        screen.style.zIndex = 600;
        screen.innerHTML = `<div class="box box-large" style="max-width:900px;">${html}</div>`;
        document.body.appendChild(screen);

        window.toggleCustomDate = () => {
            const val = document.getElementById('advPeriodSelect').value;
            document.getElementById('customDateSpan').style.display = (val === 'custom') ? 'inline-block' : 'none';
        };

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù (Drill-down)
        window.showEmpDrillDown = async (emp) => {
            const codes = window.currentStatsData[emp].contacted_parents_codes || [];
            if (codes.length === 0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.');

            // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙÙŠ parents)
            // Ù„ÙƒÙ† parents ØªØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰ employee, final_balance ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£ØµÙ„ÙŠ.
            // Ù†Ø­ØªØ§Ø¬ Ù„Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ø¢Ø¨Ø§Ø¡.
            
            const { data: fullParents, error } = await supabase.from('parents').select('*').in('parent_code', codes);
            
            if (error || !fullParents) return alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„');

            let html = `<table class="excel-preview-table"><thead><tr><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</th></tr></thead><tbody>`;
            fullParents.forEach((p, idx) => {
                html += `<tr><td>${idx+1}</td><td>${p.parent_name}</td><td>${p.phone}</td><td>${formatCurrency(p.final_balance)}</td><td>ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«</td></tr>`;
            });
            html += `</tbody></table>`;
            
            document.getElementById('drillDownTitle').innerText = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª: ${getEmployeeLabel(emp)}`;
            document.getElementById('drillDownContent').innerHTML = html;
            document.getElementById('statsDrillDownModal').style.display = 'flex';
        };

        // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        window.renderAdvChartAndTable = () => {
            const stats = window.currentStatsData;
            const metric = document.getElementById('advMetricSelect').value;
            const type = document.getElementById('advTypeSelect').value;
            const ctx = document.getElementById('advMainChart').getContext('2d');
            
            if (window._advChart) window._advChart.destroy();

            const labels = Object.keys(stats).map(e => getEmployeeLabel(e));
            const data = Object.keys(stats).map(e => stats[e][metric]);
            
            const labelMap = {
                'parents': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨',
                'calls': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù…',
                'whatsapp': 'Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨',
                'logins': 'Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„',
                'debt': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©'
            };

            const bgColors = ['rgba(25, 118, 210, 0.7)', 'rgba(67, 160, 71, 0.7)', 'rgba(251, 192, 45, 0.7)', 'rgba(230, 74, 25, 0.7)', 'rgba(156, 39, 176, 0.7)', 'rgba(0, 172, 193, 0.7)'];
            const borderColors = ['rgba(25, 118, 210, 1)', 'rgba(67, 160, 71, 1)', 'rgba(251, 192, 45, 1)', 'rgba(230, 74, 25, 1)', 'rgba(156, 39, 176, 1)', 'rgba(0, 172, 193, 1)'];

            window._advChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelMap[metric],
                        data: data,
                        backgroundColor: type === 'line' ? bgColors[0] : bgColors,
                        borderColor: type === 'line' ? borderColors[0] : borderColors,
                        borderWidth: 1,
                        fill: type !== 'line',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type !== 'bar' && type !== 'line', position: 'bottom' },
                        title: { display: true, text: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨: ' + labelMap[metric], font: { size: 18 } }
                    },
                    scales: (type === 'bar' || type === 'line') ? { y: { beginAtZero: true } } : {}
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const tableHtml = `
                <table class="excel-preview-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th>Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù…</th>
                            <th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                            <th>Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(stats).map(emp => `
                            <tr style="cursor:pointer;" onclick="showEmpDrillDown('${emp}')" title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©">
                                <td style="color:#2979ff; text-decoration:underline;">${getEmployeeLabel(emp)}</td>
                                <td>${stats[emp].calls}</td>
                                <td>${stats[emp].logins}</td>
                                <td>${stats[emp].whatsapp}</td>
                                <td>${stats[emp].parents}</td>
                                <td>${formatCurrency(stats[emp].debt)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="text-align:center; font-size:12px; color:#666; margin-top:5px;">* Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡Ù… ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>
            `;
            document.getElementById('advStatsTableContainer').innerHTML = tableHtml;
        };

        // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
        window.filterAndRenderStats();

      } catch (e) { 
        alert('Ø®Ø·Ø£: ' + e.message); 
      } finally {
        const l = document.getElementById(loadingId);
        if(l) l.remove();
      }
    };

    window.togglePasteArea = () => {
      const area = document.getElementById('excelPasteArea');
      area.style.display = area.style.display === 'none' ? 'block' : 'none';
      if (area.style.display === 'block') area.focus();
    };

    window.deleteEmployeeDataDB = async () => {
      const emp = document.getElementById('importEmpSelect').value;
      const empName = getEmployeeLabel(emp);

      if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ (${empName}) Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) return;

      const { error } = await supabase.from('parents').delete().eq('employee', emp);

      if (error) {
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message);
      } else {
        alert(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª ${empName} Ø¨Ù†Ø¬Ø§Ø­.`);
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:red;">ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
        document.getElementById('excelPasteArea').value = '';
      }
    };

    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø±Ù‚Ù… Ø¹Ø±Ø¨ÙŠ/ÙØ§Ø±Ø³ÙŠ/Ù„ØºÙˆÙŠ Ø¥Ù„Ù‰ Ø±Ù‚Ù… JS ØµØ§Ù„Ø­
    const cleanNumber = (input) => {
      if (input === null || input === undefined) return 0;
      let s = input.toString().trim();

      const map = {
        'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4', 'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9',
        'Û°': '0', 'Û±': '1', 'Û²': '2', 'Û³': '3', 'Û´': '4', 'Ûµ': '5', 'Û¶': '6', 'Û·': '7', 'Û¸': '8', 'Û¹': '9'
      };
      s = s.replace(/[Ù -Ù©Û°-Û¹]/g, d => map[d] || d);

      s = s.replace(/[\u200B\u200C\u200E\u200F\u202F\s\u00A0]/g, '');
      s = s.replace(/[\u066C\u060C]/g, '');
      s = s.replace(/\u066B/g, '.');

      if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
        if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
          s = s.replace(/\./g, '');
          s = s.replace(/,/g, '.');
        } else {
          s = s.replace(/,/g, '');
        }
      } else if (s.indexOf(',') !== -1 && s.indexOf('.') === -1) {
        s = s.replace(/,/g, '.');
      } else {
        s = s.replace(/,/g, '');
      }

      s = s.replace(/[^0-9.\-]/g, '');

      const num = parseFloat(s);
      return isNaN(num) ? 0 : num;
    };

    window.loadDataToGrid = async () => {
      const emp = document.getElementById('importEmpSelect').value;
      if (!emp) {
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>';
        return;
      }
      document.getElementById('excelPasteArea').value = '';
      document.getElementById('gridContainer').innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

      const { data, error } = await supabase.from("parents").select("*").eq("employee", emp).order("serial_no");

      if (error) {
        console.error('Error loading data:', error);
        document.getElementById('gridContainer').innerHTML = `<p style="text-align:center; color:red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${error.message}</p>`;
        return;
      }
      renderGrid(data);
      document.getElementById('excelPasteArea').style.display = 'none';
    };

    window.convertPasteToGrid = () => {
      const text = document.getElementById('excelPasteArea').value;
      const rows = text.split("\n");
      const data = [];

      rows.forEach(row => {
        if (!row.trim()) return;
        const c = row.split("\t");
        if (isNaN(parseInt(c[0]))) return;

        data.push({
          serial_no: c[0],
          parent_code: c[1],
          parent_name: c[2],
          identity_no: c[3],
          phone: c[4],
          carried_balance: cleanNumber(c[5]),
          term1_balance: cleanNumber(c[6]),
          term2_balance: cleanNumber(c[7]),
          final_balance: cleanNumber(c[8])
        });
      });
      renderGrid(data);
    };

    function renderGrid(data) {
      if (!data || data.length === 0) {
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>';
        return;
      }

      let html = `<table class="excel-preview-table">
      <thead>
        <tr>
          <th>Ø­Ø°Ù</th><th>Ù…</th><th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
          <th>Ø§Ù„Ù…Ø¯ÙˆØ±</th><th>Ù1</th><th>Ù2</th><th>Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
        </tr>
      </thead><tbody>`;

      data.forEach((row, index) => {
        html += `<tr>
        <td><button onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;cursor:pointer;">âœ–</button></td>
        <td contenteditable="true">${row.serial_no || ''}</td>
        <td contenteditable="true">${row.parent_code || ''}</td>
        <td contenteditable="true">${row.parent_name || ''}</td>
        <td contenteditable="true">${row.identity_no || ''}</td>
        <td contenteditable="true">${row.phone || ''}</td>
        <td contenteditable="true">${row.carried_balance || 0}</td>
        <td contenteditable="true">${row.term1_balance || 0}</td>
        <td contenteditable="true">${row.term2_balance || 0}</td>
        <td contenteditable="true" style="font-weight:bold;">${row.final_balance || 0}</td>
      </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('gridContainer').innerHTML = html;
    }

    window.exportToExcel = () => {
      const data = window.currentFilteredData || window.currentEmployeeData;
      if (!data || data.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");

      const exportData = data.map(row => ({
        "Ù…": row.serial_no,
        "Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ": row.parent_code,
        "Ø§Ù„Ø§Ø³Ù…": row.parent_name,
        "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©": row.identity_no,
        "Ø§Ù„Ø¬ÙˆØ§Ù„": row.phone,
        "ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„": row.updated_at ? new Date(row.updated_at).toLocaleDateString('en-GB') : '',
        "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…": row.next_call_date || '',
        "Ø§Ù„Ù…ÙˆØ¸Ù": row.employee ? getEmployeeLabel(row.employee) : '',
        "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±": row.carried_balance,
        "Ø±ØµÙŠØ¯ Ù1": row.term1_balance,
        "Ø±ØµÙŠØ¯ Ù2": row.term2_balance,
        "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ": row.final_balance,
        "Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª": row.call_count || 0,
        "Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø§ØªØµØ§Ù„": row.last_call_status || '',
        "Ù…Ù„Ø§Ø­Ø¸Ø§Øª": row.notes || ''
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Parents");
      XLSX.writeFile(wb, "Parents_Data.xlsx");
    };

    window.saveSettingsAndData = async (shouldClose, btnElement) => {
      // 1. Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
      await saveAppSettings();

      // 2. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const emp = document.getElementById('importEmpSelect').value;
      const table = document.querySelector('#gridContainer table tbody');

      // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const newRecords = [];
      if (table && table.querySelectorAll('tr').length > 0) {
        const rows = table.querySelectorAll('tr');
        rows.forEach(tr => {
          const cells = tr.querySelectorAll('td');
          if (cells.length > 1) {
            newRecords.push({
              employee: emp,
              serial_no: parseInt(cells[1].innerText) || 0,
              parent_code: cells[2].innerText,
              parent_name: cells[3].innerText,
              identity_no: cells[4].innerText,
              phone: cells[5].innerText,
              carried_balance: cleanNumber(cells[6].innerText),
              term1_balance: cleanNumber(cells[7].innerText),
              term2_balance: cleanNumber(cells[8].innerText),
              final_balance: cleanNumber(cells[9].innerText)
            });
          }
        });
      }

      // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      const { error: delError } = await supabase.from('parents').delete().eq('employee', emp);

      if (delError) {
        console.error(delError);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ' + delError.message);
        return;
      }

      // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      if (newRecords.length > 0) {
        const { error: insError } = await supabase.from('parents').insert(newRecords);
        if (insError) {
          console.error(insError);
          alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ' + insError.message);
          return;
        }
      }

      if (shouldClose) {
        closeSettings();
      } else {
        if (btnElement) {
          const originalText = btnElement.innerText;
          const originalBg = btnElement.style.background;
          btnElement.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…";
          btnElement.style.background = "#4caf50";
          setTimeout(() => {
            btnElement.innerText = originalText;
            btnElement.style.background = originalBg;
          }, 1500);
        }
        await loadDataToGrid();
      }
    };

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù†
    window.openAdminPanel = () => {
      const pass = prompt("ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
      if (pass === "admin123") {
        document.getElementById("adminScreen").style.display = "flex";
        loadAdminData();
      } else if (pass !== null) {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");
      }
    };

    window.closeAdminPanel = () => {
      document.getElementById("adminScreen").style.display = "none";
    };

    window.loadAdminData = async () => {
      const textarea = document.getElementById("adminDataInput");
      textarea.value = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

      const { data, error } = await supabase
        .from("parents")
        .select("*")
        .order("employee")
        .order("serial_no");

      if (error) {
        textarea.value = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + error.message;
        console.error(error);
        return;
      }

      let text = "Ø§Ù„Ù…ÙˆØ¸Ù\tÙ…\tØ±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±\tØ§Ù„Ø§Ø³Ù…\tØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©\tØ§Ù„Ø¬ÙˆØ§Ù„\tØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±\tØ±ØµÙŠØ¯ Ù1\tØ±ØµÙŠØ¯ Ù2\tØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ\n";

      data.forEach(row => {
        text += `${row.employee || ''}\t${row.serial_no || ''}\t${row.parent_code || ''}\t${row.parent_name || ''}\t${row.identity_no || ''}\t${row.phone || ''}\t${row.carried_balance || 0}\t${row.term1_balance || 0}\t${row.term2_balance || 0}\t${row.final_balance || 0}\n`;
      });

      textarea.value = text;
    };

    window.saveAdminDataFull = async () => {
      if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹!")) return;

      const rawText = document.getElementById("adminDataInput").value;
      const rows = rawText.split("\n");
      const newRecords = [];

      const parseNum = (str) => {
        return cleanNumber(str);
      };

      for (let i = 0; i < rows.length; i++) {
        const line = rows[i].trim();
        if (!line) continue;

        const cols = line.split("\t");
        if (isNaN(parseInt(cols[1]))) continue;

        newRecords.push({
          employee: cols[0]?.trim() || 'emp1',
          serial_no: parseInt(cols[1]) || 0,
          parent_code: cols[2] || "",
          parent_name: cols[3] || "",
          identity_no: cols[4] || "",
          phone: cols[5] || "",
          carried_balance: parseNum(cols[6]),
          term1_balance: parseNum(cols[7]),
          term2_balance: parseNum(cols[8]),
          final_balance: parseNum(cols[9])
        });
      }

      const { error: delError } = await supabase.from("parents").delete().neq('id', -1);

      if (delError) {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©! Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£Ù„ØºÙŠØª.");
        console.error(delError);
        return;
      }

      if (newRecords.length > 0) {
        const { error: insError } = await supabase.from("parents").insert(newRecords);
        if (insError) {
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!");
          console.error(insError);
        } else {
          alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! (${newRecords.length} Ø³Ø¬Ù„) âœ…`);
          closeAdminPanel();
        }
      } else {
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ§Ø±Øº).");
        closeAdminPanel();
      }
    };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¸Ù
    document.getElementById('importEmpSelect').addEventListener('change', () => {
      loadDataToGrid();
    });

    // ØªÙØ¹ÙŠÙ„ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    function enableColumnResizing() {
      const table = document.getElementById('parentsTable');
      const headers = table.querySelectorAll('th');
      
      headers.forEach((th, index) => {
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        th.appendChild(resizer);
        
        let startX, startWidth;
        
        resizer.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          startWidth = th.offsetWidth;
          resizer.classList.add('resizing');
          
          const onMouseMove = (e) => {
            const dx = startX - e.clientX; // RTL: Moving left increases width
            const newWidth = Math.max(50, startWidth + dx);
            
            if (index === 0) document.documentElement.style.setProperty('--col1-width', `${newWidth}px`);
            else if (index === 1) document.documentElement.style.setProperty('--col2-width', `${newWidth}px`);
            else if (index === 2) document.documentElement.style.setProperty('--col3-width', `${newWidth}px`);
            else {
              th.style.width = `${newWidth}px`;
              th.style.minWidth = `${newWidth}px`;
            }
          };
          
          const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            resizer.classList.remove('resizing');
          };
          
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    window.resetView = () => {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª CSS Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø«Ø¨ØªØ©
      document.documentElement.style.removeProperty('--col1-width');
      document.documentElement.style.removeProperty('--col2-width');
      document.documentElement.style.removeProperty('--col3-width');

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø±Ø¶ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      document.querySelectorAll('#parentsTable th').forEach(th => {
        th.style.width = '';
        th.style.minWidth = '';
      });
      document.getElementById('searchInput').value = '';
      document.getElementById('searchColumn').value = 'all';

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (currentEmployee) showDataForEmployee(currentEmployee);
    };

    window.toggleDarkMode = () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    };

    // Init
    loadSettings();
    enableColumnResizing();
  </script>

</body>

</html>