<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</title>

  <style>
    :root {
      --primary-color: #1976d2;
      --bg-color: #f4f6f8;
      --text-color: #333;
      --sidebar-width: 350px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      margin: 0;
      height: 100vh;
      overflow: hidden;
      direction: rtl;
    }

    /* Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª (Centered Boxes) */
    .center-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      background: var(--bg-color);
      transition: all 0.3s;
    }

    .box {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 400px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      text-align: center;
    }

    .box-large {
      width: 90%;
      height: 90%;
      max-width: 1200px;
    }

    h2 {
      margin-bottom: 20px;
      color: var(--primary-color);
    }

    .btn {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: var(--primary-color);
      color: white;
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
    }

    .btn-secondary {
      background: #777;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      box-sizing: border-box;
      font-family: inherit;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard Layout) */
    #dashboardScreen {
      display: none;
      height: 100vh;
      width: 100vw;
      position: relative;
    }

    .main-content {
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      transition: margin-left 0.3s;
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow-x: auto; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ */
      max-height: calc(100vh - 150px); /* ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ø¬Ø¯ÙˆÙ„ */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    thead {
      background: var(--primary-color);
      color: white;
      position: sticky; /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø£Ø³ */
      top: 0;
      z-index: 5;
    }

    th, td {
      padding: 15px;
      text-align: right;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ù„ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
    .num-cell {
      direction: ltr;
      font-family: 'Segoe UI', sans-serif;
    }

    tr:hover {
      background-color: #f9f9f9;
      cursor: pointer;
    }

    tr.selected {
      background-color: #e3f2fd;
      border-right: 4px solid var(--primary-color);
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: var(--sidebar-width);
      background: white;
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      transform: translateX(-100%); /* Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 20px;
      background: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .info-group {
      margin-bottom: 15px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
    }

    .info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    .info-value {
      font-weight: bold;
      color: #333;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    .close-sidebar {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-group {
      margin-bottom: 20px;
      text-align: right;
    }
    .settings-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    textarea.excel-input {
      height: 150px;
      resize: none;
      font-family: monospace;
      font-size: 12px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .excel-preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }
    .excel-preview-table th, .excel-preview-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      border-collapse: collapse;
    }
    .excel-preview-table th {
      background: #e0e0e0;
      position: sticky;
      top: 0;
    }
    .excel-preview-table td[contenteditable="true"]:focus {
      background: #e3f2fd;
      outline: 2px solid var(--primary-color);
      z-index: 1;
    }

    .qr-container {
      text-align: center;
      margin-bottom: 20px;
      padding: 10px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
    }
  </style>
</head>

<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù -->
<div class="center-screen" id="employeeScreen">
  <div class="box">
    <h2>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
    <p style="color:#666; margin-bottom:20px;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
    <div id="employeeButtons">
      <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ -->
    </div>
    <button class="btn btn-secondary" onclick="openAdminPanel()" style="margin-top:10px;">ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Admin)</button>
    <button class="btn btn-outline" onclick="openSettings()" style="margin-top:20px;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</button>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard) -->
<div id="dashboardScreen">
  
  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div class="main-content" id="mainContent">
    <div class="header-bar">
      <h3 id="employeeName" style="margin:0;"></h3>
      <div>
        <button class="btn btn-secondary" onclick="goBack()" style="width:auto; display:inline-block;">Ø®Ø±ÙˆØ¬</button>
        <button class="btn btn-outline" onclick="openSettings()" style="width:auto; display:inline-block;">âš™ï¸</button>
      </div>
    </div>

    <div class="table-container">
      <table id="parentsTable">
        <thead>
          <tr>
            <th>Ù…</th>
            <th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
            <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</th>
            <th>Ø±ØµÙŠØ¯ Ù1</th>
            <th>Ø±ØµÙŠØ¯ Ù2</th>
            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Ø§Ù„ØµÙÙˆÙ -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) -->
  <div class="sidebar" id="detailsSidebar">
    <div class="sidebar-header">
      <span id="sidebarTitle">ØªÙØ§ØµÙŠÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</span>
      <button class="close-sidebar" onclick="closeSidebar()">âœ•</button>
    </div>
    
    <div class="sidebar-content">
      <div id="sidebarInfo"></div>
      
      <!-- QR Code -->
      <div id="qrCodeContainer" class="qr-container"></div>

      <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

      <label class="info-label">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</label>
      <input type="number" id="callCountInput" placeholder="0">

      <label class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notesInput" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§..."></textarea>

      <label class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</label>
      <select id="callStatusSelect"></select>

      <label class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
      <input type="date" id="nextCallDateInput">

      <button class="btn" onclick="saveParentInteraction()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>

      <div class="action-buttons">
        <button class="btn" style="background:#25D366;" onclick="openWhatsApp()">
          ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨
        </button>
        <button class="btn" style="background:#ff9800;" onclick="openPayment()">
          ğŸ’³ Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        </button>
      </div>
    </div>
  </div>

</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div class="center-screen" id="settingsScreen" style="display:none; z-index:20;">
  <div class="box" style="width: 900px; max-width:95%; height:90%; display:flex; flex-direction:column; text-align: right;">
    <h2 style="text-align:center;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
    
    <div style="flex:1; overflow-y: auto; padding: 5px;">
      
      <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± (Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ Ø£Ùˆ Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) -->
      <div style="display:flex; gap:20px; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
        <div style="flex:1;">
          <label>ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
          <input type="color" id="themeColor" style="height:40px; padding:2px;">
        </div>
        <div style="flex:2;">
          <label>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹</label>
          <input type="text" id="paymentUrlSetting" style="margin-bottom:0;">
        </div>
      </div>

      <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
        <label>ğŸ” ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</label>
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
          <input type="text" id="pass_emp1" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 1" style="margin:0;">
          <input type="text" id="pass_emp2" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 2" style="margin:0;">
          <input type="text" id="pass_emp3" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 3" style="margin:0;">
          <input type="text" id="pass_emp4" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 4" style="margin:0;">
        </div>
      </div>

      <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
        <label>ğŸ“ Ø®ÙŠØ§Ø±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©)</label>
        <input type="text" id="statusOptionsInput" placeholder="Ù…Ø´ØºÙˆÙ„, Ù„Ù… ÙŠØ±Ø¯, ØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚, ...">
      </div>

      <div class="settings-group">
        <label> Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Excel)</label>
        <label style="font-size:1.1em; color:var(--primary-color); border-bottom:2px solid #eee; padding-bottom:5px;">ğŸ“‚ Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù†Ø³Ø®/Ù„ØµÙ‚ Excel)</label>
        <p style="font-size:12px; color:#666; margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ØŒ Ø«Ù… Ø§Ø¶ØºØ· "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.</p>
        <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
          <select id="importEmpSelect" style="width:200px; margin:0; font-weight:bold; border:2px solid var(--primary-color);">
            <option value="emp1">Ù…ÙˆØ¸Ù 1</option>
            <option value="emp2">Ù…ÙˆØ¸Ù 2</option>
            <option value="emp3">Ù…ÙˆØ¸Ù 3</option>
            <option value="emp4">Ù…ÙˆØ¸Ù 4</option>
          </select>
          <button class="btn btn-outline" onclick="loadDataToGrid()" style="width:auto; margin:0;">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
          <button class="btn btn-outline" onclick="togglePasteArea()" style="width:auto; margin:0;">ğŸ“‹ Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>

        <textarea id="excelPasteArea" class="excel-input" style="display:none; margin-bottom:10px;"
          placeholder="Ø§Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ ÙˆØ§Ù„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§... (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ù… - Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ - Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ù‡ÙˆÙŠØ© - Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„Ù…Ø¯ÙˆØ± - Ù1 - Ù2 - Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)" oninput="convertPasteToGrid()">
        </textarea>
        
        <div id="gridContainer" style="max-height:300px; overflow:auto; border:1px solid #ddd; border-radius:8px;">
          <p style="text-align:center; padding:20px; color:#999;">Ø§Ø®ØªØ± "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ø£Ùˆ "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡</p>
        </div>
      </div>

    </div>

    <div style="display:flex; gap:10px; margin-top:15px;">
      <button class="btn" onclick="saveAllSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒÙ„ (Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</button>
      <button class="btn btn-secondary" onclick="closeSettings()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„) -->
<div class="center-screen" id="adminScreen" style="display:none; z-index:30;">
  <div class="box box-large" style="display:flex; flex-direction:column;">
    <h2>ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ (ÙˆØ¶Ø¹ Ø§Ù„Ø¥ÙƒØ³Ù„)</h2>
    <p style="color:#666; font-size:14px;">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ù†Ø§ ÙˆÙ„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø«Ù… Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ ÙˆÙ„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§ Ù„Ù„Ø­ÙØ¸. <br> <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡.</p>
    
    <textarea id="adminDataInput" style="flex:1; white-space:pre; overflow:auto; font-family:monospace; font-size:12px; border:2px solid var(--primary-color);" 
      placeholder="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."></textarea>
    
    <div style="display:flex; gap:10px; justify-content:center;">
      <button class="btn" onclick="saveAdminDataFull()" style="background:#d32f2f;">ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„</button>
      <button class="btn btn-outline" onclick="loadAdminData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button class="btn btn-secondary" onclick="closeAdminPanel()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://emrsfzmaqmfavehrdppw.supabase.co',
    'sb_publishable_dmZ-1l-BmDzIteU1IaSjnw_3TMkHMhw'
  );

  let currentEmployee = "";
  let currentParentId = null; // ID of selected parent in DB
  let currentParentPhone = "";

  // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  let appConfig = {
    theme: '#1976d2',
    paymentUrl: 'https://google.com',
    passwords: { emp1: '', emp2: '', emp3: '', emp4: '' },
    statusOptions: "Ù…Ø´ØºÙˆÙ„,Ù„Ù… ÙŠØ±Ø¯,Ù…Ø¹ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯,Ù…Ø¹ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…,ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯"
  };

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
  function loadSettings() {
    const saved = localStorage.getItem('appConfig');
    if (saved) {
      appConfig = JSON.parse(saved);
    }
    applyTheme();
    renderEmployeeButtons();
  }

  function applyTheme() {
    document.documentElement.style.setProperty('--primary-color', appConfig.theme);
  }

  function renderEmployeeButtons() {
    const container = document.getElementById('employeeButtons');
    container.innerHTML = '';
    ['emp1', 'emp2', 'emp3', 'emp4'].forEach((emp, index) => {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.innerText = `ğŸ‘¤ Ù…ÙˆØ¸Ù ${index + 1}`;
      btn.onclick = () => checkPasswordAndLogin(emp);
      container.appendChild(btn);
    });
  }

  window.checkPasswordAndLogin = (emp) => {
    const pass = appConfig.passwords[emp];
    if (pass && pass.trim() !== "") {
      const input = prompt("ğŸ”’ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
      if (input !== pass) {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
        return;
      }
    }
    showDataForEmployee(emp);
  };

  // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
  window.showDataForEmployee = async (employee) => {
    currentEmployee = employee;
    document.getElementById("employeeName").innerText =
      "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… - " + (employee === 'emp1' ? 'Ù…ÙˆØ¸Ù 1' : employee);

    const { data, error } = await supabase
      .from("parents")
      .select("*")
      .eq("employee", employee)
      .order("serial_no");

    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    if (error) {
      alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      console.error(error);
      return;
    }

    if (data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='9' style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
    }

    data.forEach(p => {
      const tr = document.createElement("tr");
      tr.onclick = () => selectParent(tr, p);
      tr.innerHTML = `
        <td>${p.serial_no || '-'}</td>
        <td>${p.parent_code || '-'}</td>
        <td><strong>${p.parent_name || '-'}</strong></td>
        <td>${p.identity_no || '-'}</td>
        <td class="num-cell" style="text-align:right;">${p.phone || '-'}</td>
        <td class="num-cell">${(p.carried_balance || 0).toLocaleString('en-US')}</td>
        <td class="num-cell">${(p.term1_balance || 0).toLocaleString('en-US')}</td>
        <td class="num-cell">${(p.term2_balance || 0).toLocaleString('en-US')}</td>
        <td class="num-cell" style="color:${(p.final_balance || 0) > 0 ? 'red' : 'green'}">${(p.final_balance || 0).toLocaleString('en-US')}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("employeeScreen").style.display = "none";
    document.getElementById("dashboardScreen").style.display = "block";
  };

  // Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ„ÙŠ Ø£Ù…Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
  window.selectParent = (tr, data) => {
    // Highlight row
    document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
    tr.classList.add('selected');

    // Set Data
    currentParentId = data.id; // Assuming Supabase has an 'id' column automatically or we use another unique key
    currentParentPhone = data.phone;

    // Generate QR Code (Using a public API for simplicity)
    const qrContainer = document.getElementById('qrCodeContainer');
    if (currentParentPhone) {
      const cleanPhone = currentParentPhone.replace(/\D/g, '');
      qrContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=tel:${cleanPhone}" alt="QR Call" style="display:block; margin:0 auto;"><span style="font-size:11px; color:#666;">Ø§Ù…Ø³Ø­ Ù„Ù„Ø§ØªØµØ§Ù„</span>`;
    } else {
      qrContainer.innerHTML = '';
    }
    
    // Populate Sidebar
    const infoDiv = document.getElementById('sidebarInfo');
    infoDiv.innerHTML = `
      <div class="info-group"><div class="info-label">Ø§Ù„Ø§Ø³Ù…</div><div class="info-value">${data.parent_name}</div></div>
      <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div><div class="info-value">${data.phone}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="info-value" style="color:red">${data.final_balance}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</div><div class="info-value">${data.carried_balance || 0}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="info-value" style="color:red">${(data.final_balance || 0).toLocaleString()}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</div><div class="info-value">${(data.carried_balance || 0).toLocaleString()}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="info-value" style="color:red; direction:ltr;">${(data.final_balance || 0).toLocaleString('en-US')}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</div><div class="info-value" style="direction:ltr;">${(data.carried_balance || 0).toLocaleString('en-US')}</div></div>
    `;

    // Set Inputs (Assuming columns exist, if not they will be null/undefined)
    // Note: You need to ensure 'call_count' and 'notes' columns exist in your Supabase table.
    document.getElementById('callCountInput').value = data.call_count || 0;
    document.getElementById('notesInput').value = data.notes || "";
    
    // Populate Status Dropdown
    const statusSelect = document.getElementById('callStatusSelect');
    statusSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© --</option>';
    const options = appConfig.statusOptions.split(',');
    options.forEach(opt => {
      const cleanOpt = opt.trim();
      if(cleanOpt) statusSelect.innerHTML += `<option value="${cleanOpt}">${cleanOpt}</option>`;
    });
    statusSelect.value = data.last_call_status || "";

    // Date
    document.getElementById('nextCallDateInput').value = data.next_call_date || "";

    // Show Sidebar
    document.getElementById('detailsSidebar').classList.add('active');
  };

  window.closeSidebar = () => {
    document.getElementById('detailsSidebar').classList.remove('active');
    document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
  };

  window.saveParentInteraction = async () => {
    if (!currentParentId) return;

    const calls = document.getElementById('callCountInput').value;
    const notes = document.getElementById('notesInput').value;
    const status = document.getElementById('callStatusSelect').value;
    const nextDate = document.getElementById('nextCallDateInput').value;

    const { error } = await supabase
      .from('parents')
      .update({ 
        call_count: calls, 
        notes: notes,
        last_call_status: status,
        next_call_date: nextDate || null
      })
      .eq('id', currentParentId); // Using internal ID is safer

    if (error) {
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
      console.error(error);
    } else {
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
      // Refresh data to keep UI in sync? Or just update local object if needed.
      // For simplicity, we keep as is.
    }
  };

  window.goBack = () => {
    closeSidebar();
    document.getElementById("dashboardScreen").style.display = "none";
    document.getElementById("employeeScreen").style.display = "flex";
  };

  window.openSettings = () => {
    // Populate fields
    document.getElementById('themeColor').value = appConfig.theme;
    document.getElementById('paymentUrlSetting').value = appConfig.paymentUrl;
    document.getElementById('pass_emp1').value = appConfig.passwords.emp1;
    document.getElementById('pass_emp2').value = appConfig.passwords.emp2;
    document.getElementById('pass_emp3').value = appConfig.passwords.emp3;
    document.getElementById('pass_emp4').value = appConfig.passwords.emp4;
    document.getElementById('statusOptionsInput').value = appConfig.statusOptions;

    document.getElementById("settingsScreen").style.display = "flex";
  };

  window.closeSettings = () => {
    document.getElementById("settingsScreen").style.display = "none";
  };

  window.saveAppSettings = () => {
    appConfig.theme = document.getElementById('themeColor').value;
    appConfig.paymentUrl = document.getElementById('paymentUrlSetting').value;
    appConfig.passwords.emp1 = document.getElementById('pass_emp1').value;
    appConfig.passwords.emp2 = document.getElementById('pass_emp2').value;
    appConfig.passwords.emp3 = document.getElementById('pass_emp3').value;
    appConfig.passwords.emp4 = document.getElementById('pass_emp4').value;
    appConfig.statusOptions = document.getElementById('statusOptionsInput').value;

    localStorage.setItem('appConfig', JSON.stringify(appConfig));
    applyTheme();
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    closeSettings();
  };

  window.openWhatsApp = () => {
    if (!currentParentPhone) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„");
    // Clean phone number
    let phone = currentParentPhone.replace(/\D/g, ''); 
    // Add country code if missing (Assuming SA for example, or just open as is)
    window.open(`https://wa.me/${phone}`, '_blank');
  };

  window.openPayment = () => {
    window.open(appConfig.paymentUrl, '_blank');
  };

  // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---

  window.togglePasteArea = () => {
    const area = document.getElementById('excelPasteArea');
    area.style.display = area.style.display === 'none' ? 'block' : 'none';
    if(area.style.display === 'block') area.focus();
  };

  // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø±Ù‚Ù… Ø¹Ø±Ø¨ÙŠ/ÙØ§Ø±Ø³ÙŠ/Ù„ØºÙˆÙŠ Ø¥Ù„Ù‰ Ø±Ù‚Ù… JS ØµØ§Ù„Ø­
  const cleanNumber = (input) => {
    if (input === null || input === undefined) return 0;
    let s = input.toString().trim();

    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/Ø§Ù„ÙØ§Ø±Ø³ÙŠØ© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    const map = {
      'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9',
      'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'
    };
    s = s.replace(/[Ù -Ù©Û°-Û¹]/g, d => map[d] || d);

    // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ© ÙˆÙ…Ø³Ø§ÙØ§Øª Ø®Ø§ØµØ©
    s = s.replace(/[\u200B\u200C\u200E\u200F\u202F\s\u00A0]/g, '');

    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø­Ø§Ø±Ù Ø§Ù„ÙØ§ØµÙ„/Ø£Ù„ÙÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
    s = s.replace(/[\u066C\u060C]/g, ''); // Ø£Ù„ÙÙŠØ© Ø¹Ø±Ø¨ÙŠØ© Ùˆ0C (ØŒ)
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø¹Ø´Ø±ÙŠ Ø§Ù„Ø¹Ø±Ø¨ÙŠ (U+066B) ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù†Ù‚Ø·Ø©
    s = s.replace(/\u066B/g, '.');

    // Ù„Ùˆ Ø§Ù„Ù†Øµ ÙŠØ­ØªÙˆÙŠ ÙƒÙ„Ø§Ù‹ Ù…Ù† '.' Ùˆ','ØŒ Ù†Ù‚Ø±Ø± Ø£ÙŠÙ‡Ù…Ø§ ÙØ§ØµÙ„ Ø¹Ø´Ø±ÙŠ Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±
    if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
      if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
        // Ù†Ù…Ø·: 1.234,56 -> Ø§Ø­Ø°Ù Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ù„Ù ÙˆØ§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨Ø¹Ø´Ø±ÙŠØ©
        s = s.replace(/\./g, '');
        s = s.replace(/,/g, '.');
      } else {
        // Ù†Ù…Ø·: 1,234.56 -> Ø§Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØµÙ„
        s = s.replace(/,/g, '');
      }
    } else if (s.indexOf(',') !== -1 && s.indexOf('.') === -1) {
      // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø·Ø© Ù„ÙƒÙ† ØªÙˆØ¬Ø¯ ÙØ§ØµÙ„Ø© => Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ ÙØ§ØµÙ„ Ø¹Ø´Ø±ÙŠ
      s = s.replace(/,/g, '.');
    } else {
      // Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØµÙ„Ø© Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ø¶Ø­Ø©ØŒ Ø£Ø­Ø°Ù Ø£ÙŠ ÙÙˆØ§ØµÙ„ Ø¢Ù„Ø§Ù Ù…Ø­ØªÙ…Ù„Ø©
      s = s.replace(/,/g, '');
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø­Ø§Ø±Ù ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ© Ø£Ùˆ Ù†Ù‚Ø·Ø© Ø£Ùˆ Ø³Ø§Ù„Ø¨
    s = s.replace(/[^0-9.\-]/g, '');

    const num = parseFloat(s);
    return isNaN(num) ? 0 : num;
  };

  window.loadDataToGrid = async () => {
    const emp = document.getElementById('importEmpSelect').value;
    document.getElementById('gridContainer').innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
    
    const { data, error } = await supabase.from("parents").select("*").eq("employee", emp).order("serial_no");
    
    if(error) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"); return; }
    renderGrid(data);
    document.getElementById('excelPasteArea').style.display = 'none';
  };

  window.convertPasteToGrid = () => {
    const text = document.getElementById('excelPasteArea').value;
    const rows = text.split("\n");
    const data = [];

    rows.forEach(row => {
      if (!row.trim()) return;
      const c = row.split("\t");
      if (isNaN(parseInt(c[0]))) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†

      data.push({
        serial_no: c[0],
        parent_code: c[1],
        parent_name: c[2],
        identity_no: c[3],
        phone: c[4],
        carried_balance: cleanNumber(c[5]),
        term1_balance: cleanNumber(c[6]),
        term2_balance: cleanNumber(c[7]),
        final_balance: cleanNumber(c[8])
      });
    });
    renderGrid(data);
  };

  function renderGrid(data) {
    let html = `<table class="excel-preview-table">
      <thead>
        <tr>
          <th>Ø­Ø°Ù</th><th>Ù…</th><th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
          <th>Ø§Ù„Ù…Ø¯ÙˆØ±</th><th>Ù1</th><th>Ù2</th><th>Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
        </tr>
      </thead><tbody>`;
    
    data.forEach((row, index) => {
      html += `<tr>
        <td><button onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;cursor:pointer;">âœ–</button></td>
        <td contenteditable="true">${row.serial_no || ''}</td>
        <td contenteditable="true">${row.parent_code || ''}</td>
        <td contenteditable="true">${row.parent_name || ''}</td>
        <td contenteditable="true">${row.identity_no || ''}</td>
        <td contenteditable="true">${row.phone || ''}</td>
        <td contenteditable="true">${row.carried_balance || 0}</td>
        <td contenteditable="true">${row.term1_balance || 0}</td>
        <td contenteditable="true">${row.term2_balance || 0}</td>
        <td contenteditable="true" style="font-weight:bold;">${row.final_balance || 0}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('gridContainer').innerHTML = html;
  }

  window.saveAllSettings = async () => {
    // 1. Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    saveAppSettings();

    // 2. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø­Ø¯Ø¯)
    const emp = document.getElementById('importEmpSelect').value;
    const table = document.querySelector('.excel-preview-table tbody');
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¥Ù† ÙˆØ¬Ø¯)
    const newRecords = [];
    if (table && table.querySelectorAll('tr').length > 0) {
      const rows = table.querySelectorAll('tr');
      rows.forEach(tr => {
        const cells = tr.querySelectorAll('td');
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª
        if (cells.length > 1) {
            newRecords.push({
            employee: emp,
            serial_no: parseInt(cells[1].innerText) || 0,
            parent_code: cells[2].innerText,
            parent_name: cells[3].innerText,
            identity_no: cells[4].innerText,
            phone: cells[5].innerText,
            carried_balance: cleanNumber(cells[6].innerText),
            term1_balance: cleanNumber(cells[7].innerText),
            term2_balance: cleanNumber(cells[8].innerText),
            final_balance: cleanNumber(cells[9].innerText)
            });
        }
      });
    }

    if(!confirm(`Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª (${emp}).\nØ¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${newRecords.length}\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) return;
    if(!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…:\nØ£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª (${emp}).\n- Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù.\n- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ${newRecords.length} Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ`)) return;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª)
    const { data: existingRows, error: fetchError } = await supabase
      .from('parents')
      .select('id')
      .eq('employee', emp);

    if (fetchError) {
      alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆØ¸Ù: ' + fetchError.message);
      console.error(fetchError);
      return;
    }

    const existingCount = (existingRows && existingRows.length) || 0;

    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙÙ‚Ø· Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©
    if (existingCount === 0) {
      if (newRecords.length === 0) {
        alert(`Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ù€ ${emp}ØŒ ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ÙØ¸.`);
        await loadDataToGrid();
        return;
      }
      // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ø­Ø°ÙØŒ Ù†Ù†ØªÙ‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„
    } else {
      // Ù‚Ù… Ø¨Ø§Ù„Ø­Ø°Ù ÙˆØ§Ø·Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù„Ù„ØªØ£ÙƒØ¯
      // Ø£ÙˆÙ„Ø§Ù‹: Ø¬Ù„Ø¨ Ù…Ø²ÙŠØ¯ Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªØ´Ø®ÙŠØµ
      const { data: sampleRows, error: sampleError } = await supabase
        .from('parents')
        .select('id, employee, parent_name, serial_no')
        .eq('employee', emp)
        .limit(10);

      if (sampleError) console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¹ÙŠÙ†Ø© Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙˆØ¸Ù:', sampleError);
      else console.log('Ø¹ÙŠÙ†Ø© Ù…Ù† ØµÙÙˆÙ Ø§Ù„Ù…ÙˆØ¸Ù Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù:', sampleRows);

      const { data: deletedRows, error: delError } = await supabase
        .from('parents')
        .delete()
        .eq('employee', emp)
        .select('*');

      if (delError) {
        alert('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©! Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.\nØ§Ù„Ø®Ø·Ø£: ' + delError.message);
        console.error(delError);
        return;
      }

      // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø£ÙŠ ØµÙÙˆÙ Ø±ØºÙ… Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„Ø§ØªØŒ Ù†Ø¬Ø±Ø¨ Ø­Ø°ÙÙ‡Ø§ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù‘ÙØ§Øª ÙƒØ®Ø·Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      if (!deletedRows || deletedRows.length === 0) {
        console.warn('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø¨ÙˆØ§Ø³Ø·Ø© employee Ù„Ù… ØªØ²Ù„ Ø³Ø¬Ù„Ø§ØªØŒ Ù†Ø¬Ø±Ø¨ Ø­Ø°ÙÙ‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª (ids).', { existingCount, sampleRows, deletedRows });

        // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª (ids) Ù…Ù† Ø§Ù„Ø¹ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„
        const { data: allRows, error: allError } = await supabase
          .from('parents')
          .select('id')
          .eq('employee', emp);

        if (allError) {
          alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ù„Ù„Ø­Ø°Ù Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: ' + allError.message);
          console.error(allError);
          await loadDataToGrid();
          return;
        }

        const ids = (allRows || []).map(r => r.id).filter(Boolean);
        if (ids.length === 0) {
          alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø­Ø°Ù (Ù…Ø­ØªÙ…Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù‚ÙŠÙ…Ø© "employee" Ø£Ùˆ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„).');
          await loadDataToGrid();
          return;
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø°Ù Ø¨ÙˆØ§Ø³Ø·Ø© ids
        const { data: deletedByIds, error: delByIdsError } = await supabase
          .from('parents')
          .delete()
          .in('id', ids)
          .select('*');

        if (delByIdsError) {
          alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø¨Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª: ' + delByIdsError.message + '\nÙ‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙˆØ¯ ÙˆØµÙˆÙ„ (RLS) Ø£Ùˆ Ù…ÙØ§ØªÙŠØ­ ØºÙŠØ± ØµØ§Ù„Ø­Ø©.');
          console.error(delByIdsError);
          await loadDataToGrid();
          return;
        }

        if (!deletedByIds || deletedByIds.length === 0) {
          alert('ØªØ­Ø°ÙŠØ±: Ø­Ø§ÙˆÙ„Ù†Ø§ Ø§Ù„Ø­Ø°Ù Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø© Ù„ÙƒÙ† Ù„Ù… ØªØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª. Ø±Ø§Ø¬Ø¹ Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ Supabase (RLS) Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙØªØ§Ø­ Ø®Ø¯Ù…Ø© Ø¢Ù…Ù† Ù„Ù„Ø®Ø§Ø¯Ù… Ù„Ù„Ø­Ø°Ù.');
          console.warn('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª.', { ids, deletedByIds });
          await loadDataToGrid();
          return;
        }

        // Ø¥Ø°Ø§ Ù†Ø¬Ø­Øª Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        console.log('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ Ø¨ÙˆØ§Ø³Ø·Ø© ids:', deletedByIds.length);
      }
    }

    // Ø§Ù„Ø¢Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)
    if (newRecords.length > 0) {
      const { error } = await supabase.from('parents').insert(newRecords);
      if (error) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        console.error(error);
      } else {
        alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ${emp} Ø¨Ù†Ø¬Ø§Ø­ (${newRecords.length} Ø³Ø¬Ù„) âœ…`);
        document.getElementById('gridContainer').innerHTML = '';
      }
    } else if (existingCount > 0) {
      // ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆÙ„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ø¯ÙŠØ¯
      alert(`ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª ${emp} Ø¨Ù†Ø¬Ø§Ø­ (Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº) âœ…`);
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ¹ÙƒØ³ Ø­Ø§Ù„Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù†
    await loadDataToGrid();
  };

  // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ---

  window.openAdminPanel = () => {
    const pass = prompt("ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
    if (pass === "admin123") {
      document.getElementById("adminScreen").style.display = "flex";
      loadAdminData();
    } else if (pass !== null) {
      alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");
    }
  };

  window.closeAdminPanel = () => {
    document.getElementById("adminScreen").style.display = "none";
  };

  window.loadAdminData = async () => {
    const textarea = document.getElementById("adminDataInput");
    textarea.value = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

    const { data, error } = await supabase
      .from("parents")
      .select("*")
      .order("employee")
      .order("serial_no");

    if (error) {
      textarea.value = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„!";
      console.error(error);
      return;
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù†Øµ (TSV)
    // Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…ÙˆØ¸Ù - Ù… - Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ - Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ù‡ÙˆÙŠØ© - Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„Ù…Ø¯ÙˆØ± - Ù1 - Ù2 - Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    let text = "Ø§Ù„Ù…ÙˆØ¸Ù\tÙ…\tØ±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±\tØ§Ù„Ø§Ø³Ù…\tØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©\tØ§Ù„Ø¬ÙˆØ§Ù„\tØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±\tØ±ØµÙŠØ¯ Ù1\tØ±ØµÙŠØ¯ Ù2\tØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ\n";
    
    data.forEach(row => {
      text += `${row.employee || ''}\t${row.serial_no || ''}\t${row.parent_code || ''}\t${row.parent_name || ''}\t${row.identity_no || ''}\t${row.phone || ''}\t${row.carried_balance || 0}\t${row.term1_balance || 0}\t${row.term2_balance || 0}\t${row.final_balance || 0}\n`;
    });

    textarea.value = text;
  };

  window.saveAdminDataFull = async () => {
    if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹!")) return;

    const rawText = document.getElementById("adminDataInput").value;
    const rows = rawText.split("\n");
    const newRecords = [];

    // Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© (ØªØ¹Ø§Ø¯Ù„ÙŠØ© Ù…Ø¹ cleanNumber)
    const parseNum = (str) => {
      return cleanNumber(str);
    };

    for (let i = 0; i < rows.length; i++) {
      const line = rows[i].trim();
      if (!line) continue;
      
      const cols = line.split("\t");
      // ØªØ®Ø·ÙŠ Ø³Ø·Ø± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„ÙŠØ³ Ø±Ù‚Ù…Ø§Ù‹)
      if (isNaN(parseInt(cols[1]))) continue;

      newRecords.push({
        employee: cols[0]?.trim() || 'emp1', // Ø§ÙØªØ±Ø§Ø¶ÙŠ
        serial_no: parseInt(cols[1]) || 0,
        parent_code: cols[2] || "",
        parent_name: cols[3] || "",
        identity_no: cols[4] || "",
        phone: cols[5] || "",
        carried_balance: parseNum(cols[6]),
        term1_balance: parseNum(cols[7]),
        term2_balance: parseNum(cols[8]),
        final_balance: parseNum(cols[9])
      });
    }

    // 1. Ø­Ø°Ù Ø§Ù„ÙƒÙ„
    const { error: delError } = await supabase.from("parents").delete().neq('id', -1); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø´Ø±Ø· ØµØ­ÙŠØ­ Ù„Ù„Ø­Ø°Ù
    
    if (delError) {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©! Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£Ù„ØºÙŠØª.");
      console.error(delError);
      return;
    }

    // 2. Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    if (newRecords.length > 0) {
      const { error: insError } = await supabase.from("parents").insert(newRecords);
      if (insError) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!");
        console.error(insError);
      } else {
        alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! (${newRecords.length} Ø³Ø¬Ù„) âœ…`);
        closeAdminPanel();
      }
    } else {
      alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ§Ø±Øº).");
      closeAdminPanel();
    }
  };

  // Init
  loadSettings();
</script>

</body>
</html>
