<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #1565C0; /* Ø£Ø²Ø±Ù‚ Ù…Ù„ÙƒÙŠ Ø¹ØµØ±ÙŠ */
      --secondary-color: #00838f; /* ØªØ±ÙƒÙˆØ§Ø² ØºØ§Ù…Ù‚ */
      --bg-color: #f0f2f5; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø®Ù„ÙÙŠØ© */
      --text-color: #1a1a1a;
      --accent-color: #ff6f00; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø­ÙŠÙˆÙŠ Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
      --sidebar-width: 350px;
      --sidebar-width: 400px;
      --col1-width: 80px;
      --col2-width: 150px;
      --col3-width: 400px;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-border: 1px solid rgba(255, 255, 255, 0.3);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      /* Ø®Ù„ÙÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù‡Ø§Ø¯Ø¦Ø© */
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      background: #f8f9fa;
      margin: 0;
      min-height: 100vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      direction: rtl;
      font-size: 20px;
      color: var(--text-color);
      font-weight: 600;
    }

    /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© Ø¬Ù…ÙŠÙ„Ø© */
    body::before {
      display: none;
    }

    /* Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª (Centered Boxes) */
    .center-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      background: var(--bg-color);
      transition: all 0.3s;
      overflow: auto;
      padding: 20px;
      box-sizing: border-box;
      max-height: 100vh;
      backdrop-filter: blur(5px);
      background: rgba(255, 255, 255, 0.1); /* Ø´ÙØ§ÙÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© */
      backdrop-filter: blur(10px);
    }

    /* ØªØ®ØµÙŠØµ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
    #employeeScreen .box {
      width: 100%;
      height: 100vh;
      max-height: 100vh;
      border-radius: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 0;
      border: none;
    }

    .box {
      background: var(--glass-bg);
      padding: 40px;
      border-radius: 12px;
      width: 98%;
      box-shadow: var(--glass-shadow);
      border: var(--glass-border);
      text-align: center;
      max-height: 98vh;
      overflow: auto;
      max-width: none !important; /* ÙØ±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ */
    }

    .box-large {
      width: 99.5%;
      height: auto;
      max-width: none;
      max-height: calc(100vh - 60px);
      overflow: auto;
    }

    h2 {
      margin-bottom: 20px;
      color: #000;
      text-shadow: none;
    }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© */
    .btn {
      width: 100%;
      padding: 20px;
      min-height: 100px;
      height: auto;
      margin-bottom: 15px;
      font-size: 28px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      background: linear-gradient(135deg, #ffffff, #f5f5f5);
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 900;
      white-space: normal;
      line-height: 1.5;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }

    .btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: #fff;
    }

    /* ØªØµÙ…ÙŠÙ… Ø´Ø¨ÙƒØ© Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    .main-dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 40px;
      width: 100%;
      max-width: 1600px;
      margin: 40px auto;
      padding: 0 40px;
      box-sizing: border-box;
    }

    .dash-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      padding: 50px 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(255,255,255,0.8);
      box-shadow: 0 15px 35px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 320px;
      position: relative;
      overflow: hidden;
    }

    .dash-card:hover {
      transform: translateY(-15px);
      box-shadow: 0 25px 50px rgba(0,0,0,0.1);
      background: #ffffff;
    }

    .dash-card .icon {
      font-size: 80px;
      margin-bottom: 25px;
      display: block;
      transition: transform 0.3s;
    }

    .dash-card:hover .icon {
      transform: scale(1.1) rotate(5deg);
    }

    .dash-card h3 {
      font-size: 32px;
      font-weight: 900;
      color: #000;
      margin: 0 0 15px 0;
    }

    .dash-card p {
      font-size: 20px;
      color: #555;
      margin: 0;
      font-weight: 600;
    }

    /* Ø£Ù„ÙˆØ§Ù† Ù…Ù…ÙŠØ²Ø© Ù„Ù„ÙƒØ±ÙˆØª */
    .card-employees { border-bottom: 10px solid #2196F3; }
    .card-employees .icon { color: #2196F3; }
    .card-stages { border-bottom: 10px solid #009688; }
    .card-stages .icon { color: #009688; }
    .card-admin { border-bottom: 10px solid #D32F2F; background: linear-gradient(145deg, #fff, #fff5f5); }
    .card-admin .icon { color: #D32F2F; }
    .card-settings { border-bottom: 10px solid #FF9800; background: linear-gradient(145deg, #fff, #fff8e1); }
    .card-settings .icon { color: #FF9800; }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ±ÙˆØª (Cards) Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„ */
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-top: 20px;
      padding: 10px;
      justify-content: center;
    }

    .emp-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 160px;
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      opacity: 0;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .emp-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 6px;
      background: var(--primary-color);
      opacity: 1;
    }

    .emp-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 30px rgba(0, 100, 255, 0.15);
      background: #ffffff;
    }

    .emp-card .icon {
      font-size: 48px;
      margin-bottom: 15px;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
    }

    .emp-card .title {
      font-size: 40px;
      font-weight: 800;
      color: #333;
    }

    .emp-card .subtitle {
      font-size: 22px;
      font-weight: 600;
      color: #555;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 900;
      box-shadow: none;
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: #fff;
      box-shadow: 0 5px 15px rgba(21, 101, 192, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
      color: #000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      background: rgba(200, 200, 200, 0.3);
      color: #333;
      border: 1px solid rgba(0,0,0,0.1);
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      margin-bottom: 15px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 22px;
      font-weight: 700;
      background: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.5);
      color: #000;
      transition: 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 10px rgba(21, 101, 192, 0.2);
      outline: none;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard Layout) */
    #dashboardScreen {
      display: none;
      min-height: 100vh;
      width: 100%;
      position: relative;
      overflow: auto;
    }

    .main-content {
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      transition: margin-left 0.3s;
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: #ffffff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: var(--glass-shadow);
      border: 1px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-container {
      background: rgba(255, 255, 255, 0.6);
      background: #ffffff;
      border-radius: 12px;
      box-shadow: var(--glass-shadow);
      overflow: auto; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ÙŠÙ† */
      width: 100%;
      max-height: calc(100vh - 180px); /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© */
      padding-bottom: 15px; /* Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ */
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„ÙŠÙƒÙˆÙ† ÙˆØ§Ø¶Ø­Ø§Ù‹ */
    ::-webkit-scrollbar {
      height: 16px;
      width: 16px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 8px;
      border: 3px solid #f1f1f1;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø£Ø®Ø° Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ */
      min-width: max-content; /* Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ ÙƒØ«Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡ÙŠØ¯Ø± */
    thead {
      background: var(--primary-color);
      color: #ffffff;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    th,
    td {
      padding: 20px;
      text-align: right;
      border-bottom: 1px solid #ccc;
      white-space: nowrap;
      color: #000;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 600;
      background: #ffffff;
      font-size: 18px;
      min-width: 100px; /* Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¹Ø±Ø¶ */
    }

    .num-cell {
      direction: ltr;
      font-family: 'Segoe UI', sans-serif;
    }

    tr:hover {
      background-color: #f9f9f9;
      background-color: #f1f5f9 !important;
      cursor: pointer;
    }

    tr.selected {
      background-color: #e2e8f0;
      border-right: 5px solid var(--primary-color);
    }

    /* ØªØ«Ø¨ÙŠØª Ø£ÙˆÙ„ 3 Ø£Ø¹Ù…Ø¯Ø© (Sticky Columns) */
    th:nth-child(1), td:nth-child(1) {
      position: sticky;
      right: 0;
      z-index: 50;
      width: var(--col1-width);
      min-width: var(--col1-width);
      max-width: var(--col1-width);
      box-sizing: border-box;
      border-left: 1px solid #ddd;
      background-color: #ffffff;
    }

    th:nth-child(2), td:nth-child(2) {
      position: sticky;
      right: var(--col1-width);
      z-index: 50;
      width: var(--col2-width);
      min-width: var(--col2-width);
      max-width: var(--col2-width);
      box-sizing: border-box;
      border-left: 1px solid #ddd;
      background-color: #ffffff;
    }

    th:nth-child(3), td:nth-child(3) {
      position: sticky;
      right: calc(var(--col1-width) + var(--col2-width));
      z-index: 50;
      width: var(--col3-width);
      min-width: var(--col3-width);
      box-sizing: border-box;
      border-left: 2px solid #ccc;
      background-color: #ffffff;
      white-space: nowrap;
    }

    /* Ø±ÙØ¹ Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø«Ø¨ØªØ© */
    thead th:nth-child(1), 
    thead th:nth-child(2),
    thead th:nth-child(3) {
      background-color: var(--primary-color) !important;
      color: #ffffff;
    }

    /* Ù…Ù‚Ø¨Ø¶ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    .resizer {
      position: absolute;
      left: 0;
      top: 0;
      width: 8px; /* Ø¹Ø±Ø¶ Ø£ÙƒØ¨Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ */
      height: 100%;
      cursor: col-resize;
      user-select: none;
      touch-action: none;
      z-index: 10;
      opacity: 0; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
      transition: opacity 0.2s;
    }
    th:hover .resizer, .resizer:hover, .resizing {
      background-color: #2979ff;
      width: 7px;
      opacity: 1; /* ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
    }
    th {
      position: relative;
    }
    /* Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± Ø§Ù„Ù…Ø«Ø¨ØªØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø¯Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */

    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ… */
    tr.contacted-today,
    tr.contacted-today td {
      background-color: #b9f6ca !important; /* Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± ÙØ³ÙÙˆØ±ÙŠ ÙØ§ØªØ­ */
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: var(--sidebar-width);
      background: #ffffff;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 20px;
      background: var(--primary-color);
      color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ (History) */
    .sidebar-right {
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      width: var(--sidebar-width);
      background: #ffffff;
      box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar-right.active {
      transform: translateX(0);
    }

    .sidebar-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .info-group {
      margin-bottom: 15px;
      background: #f1f5f9;
      padding: 10px;
      border-radius: 8px;
    }

    .sidebar-right .sidebar-header {
      padding: 20px;
      background: var(--primary-color);
      color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }

    .info-value {
      font-weight: bold;
      color: #333;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }

    .close-sidebar {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-group {
      margin-bottom: 20px;
      text-align: right;
    }

    .settings-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    textarea.excel-input {
      height: 150px;
      resize: none;
      font-family: monospace;
      font-size: 12px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .excel-preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
      table-layout: auto;
      min-width: max-content; /* Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
    }

    .excel-preview-table th,
    .excel-preview-table td {
      border: 1px solid #ddd;
      padding: 14px 16px;
      text-align: center;
      border-collapse: collapse;
      font-size: 16px;
      white-space: nowrap;
    }

    .excel-preview-table th {
      background: var(--primary-color);
      color: #ffffff;
      position: sticky;
      top: 0;
      font-weight: 700;
      font-size: 17px;
    }

    .excel-preview-table tbody tr {
      transition: background-color 0.2s;
    }

    .excel-preview-table tbody tr:hover {
      background-color: #f5f5f5 !important;
    }

    .excel-preview-table tbody tr:nth-child(even) {
      background-color: #fafafa;
    }

    .excel-preview-table td[contenteditable="true"]:focus {
      background: #e3f2fd;
      outline: 2px solid #2979ff;
      z-index: 1;
    }

    .qr-container {
      text-align: center;
      margin-bottom: 20px;
      padding: 10px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - ØªØµÙ…ÙŠÙ… Ø£ÙƒØ¨Ø± ÙˆÙˆØ§Ø¶Ø­ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨ */
    .stat-btn {
      padding: 0 20px;
      height: 60px;
      font-size: 20px;
      border-radius: 10px;
      margin-left: 6px;
      background: #fff;
      color: var(--primary-color);
      font-weight: 900;
      border: 2px solid #e0e0e0;
      box-shadow: 0 6px 18px rgba(141, 110, 99, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .stat-outline {
      background: linear-gradient(90deg, #ffea00, #ff9100);
      color: #fff;
    }

    .stats-box {
      background: #ffffff;
      color: #000;
      font-weight: 700;
    }

    .stats-box h3 {
      font-size: 24px;
      color: #000;
      margin: 6px 0 12px;
    }

    .stats-box .excel-preview-table th,
    .stats-box .excel-preview-table td {
      font-size: 16px;
      padding: 12px;
      font-weight: 700;
    }

    .stats-box .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }

    .stats-box .controls select,
    .stats-box .controls button {
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 8px;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª */
    .chart-type-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      transition: 0.2s;
    }

    .chart-type-btn:hover {
      background: #f0f0f0;
    }

    .chart-type-btn.active {
      background: #2979ff;
      color: #fff;
      border-color: var(--primary-color);
    }

    /* Ù…ØªØ¬Ø§ÙˆØ¨: Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 768px) {
      .box {
        padding: 10px;
        width: 95%;
      }

      .btn {
        padding: 10px;
        font-size: 14px;
      }

      .stat-btn {
        padding: 10px;
        font-size: 14px;
      }

      .excel-preview-table th,
      .excel-preview-table td {
        font-size: 13px;
      }

      table {
        min-width: 600px;
      }
    }

    @media (max-width: 420px) {
      .header-bar {
        flex-direction: column;
        gap: 8px;
      }

      .header-bar h3 {
        font-size: 18px;
      }

      .stat-btn {
        width: 100%;
      }
    }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode {
      --bg-color: #121212;
      color: #e0e0e0;
      background: #121212; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„ÙØ§ØªØ­ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    }
    body.dark-mode .box,
    body.dark-mode .header-bar,
    body.dark-mode .sidebar,
    body.dark-mode .sidebar-right,
    body.dark-mode .table-container,
    body.dark-mode .info-group,
    body.dark-mode .qr-container,
    body.dark-mode .stats-box,
    body.dark-mode .settings-group textarea {
      background: #1e1e1e !important;
      color: #e0e0e0 !important;
      border-color: #333 !important;
      box-shadow: none !important;
    }
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea {
      background: #2d2d2d !important;
      color: #fff !important;
      border-color: #444 !important;
    }
    body.dark-mode th,
    body.dark-mode td {
      background: #1e1e1e !important;
      color: #e0e0e0 !important;
      border-bottom-color: #333 !important;
    }
    body.dark-mode thead th {
      background: #252525 !important;
      color: #fff !important;
    }
    body.dark-mode tr:hover {
      background-color: #333 !important;
    }
    body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4, body.dark-mode h5, body.dark-mode h6 {
      color: #fff !important;
      text-shadow: none !important;
    }
    /* Sticky columns fix for dark mode */
    body.dark-mode th:nth-child(1), body.dark-mode td:nth-child(1),
    body.dark-mode th:nth-child(2), body.dark-mode td:nth-child(2),
    body.dark-mode th:nth-child(3), body.dark-mode td:nth-child(3) {
      background-color: #1e1e1e !important;
      border-left-color: #333 !important;
    }
    body.dark-mode .emp-card {
      background: rgba(50, 50, 50, 0.7);
      border-color: #444;
      color: #fff;
    }
    body.dark-mode .emp-card .title { color: #fff; }

    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .settings-row input { margin-bottom: 0; flex: 1; }
    .btn-sm { height: 50px; padding: 0 15px; font-size: 16px; width: auto; }
    .btn-danger { background: #ffcdd2; color: #c62828; border: 1px solid #c62828; }
    .btn-add { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; margin-top: 10px; }

    /* Ø´Ø¨ÙƒØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
      padding: 30px;
      justify-content: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    th.draggable { cursor: move; user-select: none; }
    th.dragging { opacity: 0.5; background: #ccc; }
    th.drag-over { border-left: 4px solid #ff9800; }

    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
    .admin-dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #ffffff;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      text-align: center;
      transition: transform 0.3s;
      border: 1px solid #f0f0f0;
      position: relative;
      overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
    .stat-card h3 { font-size: 42px; margin: 10px 0; color: var(--primary-color); font-weight: 900; }
    .stat-card p { font-size: 18px; color: #666; margin: 0; font-weight: 600; }
    .stat-card .icon { font-size: 50px; opacity: 0.1; position: absolute; top: 10px; left: 10px; }
    
    .chart-container-box {
      background: #fff;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
  </style>
</head>

<body>

  <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù -->
  <div class="center-screen" id="employeeScreen">
    <div class="box">
      <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:25px;">
        <div style="display:flex; flex-direction: row; align-items:center; justify-content:center; gap:20px; margin-bottom:15px; flex-wrap: wrap;">
            <img src="logo3.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" style="height:160px; width:auto; display:block; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));">
            <h1 style="color:#1a237e; font-size:55px; margin:0; font-weight:900; letter-spacing: -1px; text-align:center; text-shadow: 2px 2px 0px rgba(255,255,255,0.5);">Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ø§Ù„Ø±ÙˆØ§Ø¨ÙŠ</h1>
        </div>
        <h2 style="font-size:28px; color:#455a64; margin:0; font-weight:700;">Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h2>
      </div>
      <h3 style="font-size:22px; color:#333; margin-top:0;">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h3>
      <p style="color:#666; margin-bottom:30px; font-size: 18px;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
      <div id="employeeButtons" style="width: 100%;">
        <!-- Ø³ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ø¨Ø± Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
        <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ -->
      </div>
      <div style="margin-top: 20px; font-size: 14px; color: #000;">
        <div style="font-weight: 900;">ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ± Ø§Ø³ØªØ§Ø° Ø§Ø­Ù…Ø¯ Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù„Ù‡</div>
        <a href="mailto:designissue@gmail.com" style="color: #000; text-decoration: none; font-weight: bold;">designissue@gmail.com</a>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard) -->
  <div id="dashboardScreen">

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="main-content" id="mainContent">
      <div class="header-bar" style="flex-direction: column; gap: 15px; align-items: stretch;">
        
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø¹Ù„ÙˆÙŠ: Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù - Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø© - Ø§Ù„Ù…Ø·ÙˆØ± -->
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <h3 id="employeeName" style="margin:0; font-size: 18px;"></h3>
            
            <h1 style="margin:0; font-family:'Traditional Arabic', serif; font-size:42px; color:#000; background-color:rgba(255,255,255,0.8); padding:5px 30px; border-radius:15px; font-weight:900; text-align:center; border:1px solid rgba(0,0,0,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ø§Ù„Ø±ÙˆØ§Ø¨ÙŠ</h1>
    
            <div style="text-align: left; margin-left: 5px;">
                <div style="font-weight: 900; color: #000; font-size: 14px;">ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ± Ø§Ø³ØªØ§Ø° Ø§Ø­Ù…Ø¯ Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù„Ù‡</div>
                <a href="mailto:designissue@gmail.com" style="color: #000; text-decoration: none; font-weight: bold; font-size: 14px;">designissue@gmail.com</a>
            </div>
        </div>

        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø³ÙÙ„ÙŠ: Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± -->
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« -->
            <div style="display:flex; gap:10px; align-items:center; background: rgba(255,255,255,0.5); padding: 5px 15px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                <span style="font-weight:bold;">ğŸ” Ø¨Ø­Ø«:</span>
                <select id="searchColumn" onchange="filterTable()" style="margin:0; width:auto; height:40px; padding: 5px 10px;">
                    <option value="all">Ø´Ø§Ù…Ù„</option>
                    <option value="parent_name">Ø§Ù„Ø§Ø³Ù…</option>
                    <option value="parent_code">Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</option>
                    <option value="phone">Ø§Ù„Ø¬ÙˆØ§Ù„</option>
                    <option value="identity_no">Ø§Ù„Ù‡ÙˆÙŠØ©</option>
                    <option value="next_call_date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</option>
                </select>
                <input type="text" id="searchInput" oninput="filterTable()" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..." style="margin:0; height:40px; width:200px; padding: 5px 10px;">
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ -->
            <div style="display:flex; gap:5px; align-items:center;">
                <span style="font-size:14px; font-weight:bold;">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</span>
                <select id="sortCriteria" onchange="applySort()" style="padding:5px; font-size:14px; margin:0; height:40px; width:auto; border-radius:8px;">
                    <option value="serial_no">ğŸ”¢ Ø§Ù„ØªØ³Ù„Ø³Ù„</option>
                    <option value="updated_at">ğŸ“… Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</option>
                    <option value="next_call_date">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</option>
                    <option value="parent_name">abc Ø§Ù„Ø§Ø³Ù…</option>
                    <option value="final_balance">ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯</option>
                    <option value="call_count">ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</option>
                </select>
                <button id="sortDirectionBtn" class="btn btn-outline" onclick="toggleSortDirection()" style="width:40px; height:40px; margin:0; padding:0; display:flex; align-items:center; justify-content:center;" title="ØªØºÙŠÙŠØ± Ø§Ù„ØªØ±ØªÙŠØ¨">â¬‡ï¸</button>
            </div>

            <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
            <div style="display:flex; align-items:center; gap:8px;">
              <button class="stat-btn" onclick="openStats()" style="width:auto; display:inline-flex;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
              <button class="btn btn-outline" onclick="openDebtStats()" title="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©" style="width:auto; display:inline-flex;">ğŸ’° Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</button>
              <button class="btn btn-outline" onclick="exportToExcel()" title="ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel" style="width:auto; display:inline-flex; background:#fff; color:#000; border-color:#000;">ğŸ“¥ Excel</button>
              <button class="btn btn-outline" onclick="toggleDarkMode()" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" style="width:auto; display:inline-flex;">ğŸŒ™</button>
              <button class="btn btn-outline" onclick="resetView()" title="ØªØ­Ø¯ÙŠØ« ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶" style="width:auto; display:inline-flex;">ğŸ”„</button>
              <button class="btn btn-outline" onclick="openEmployeeSettings()" style="width:auto; display:inline-flex;">âš™ï¸</button>
              <button class="btn" onclick="goBack()" style="width:auto; display:inline-flex; background:#ffebee; color:#000; border:2px solid #d32f2f;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
      </div>

      <div class="table-container">
        <table id="parentsTable">
          <thead>
            <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
          </thead>
          <tbody id="tableBody">
            <!-- Ø§Ù„ØµÙÙˆÙ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) -->
    <div class="sidebar" id="detailsSidebar">
      <div class="sidebar-header">
        <span id="sidebarTitle">ØªÙØ§ØµÙŠÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</span>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="close-sidebar" onclick="openEmployeeSettings()" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">âš™ï¸</button>
          <button class="close-sidebar" onclick="closeSidebar()">âœ•</button>
        </div>
      </div>

      <div class="sidebar-content">
        <div id="sidebarInfo"></div>

        <!-- QR Code -->
        <div id="qrCodeContainer" class="qr-container"></div>

        <hr style="border:0; border-top:1px solid #eee; margin:20px 0 10px;">
        <h3
          style="color: #2979ff; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
          Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>

        <label class="info-label">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</label>
        <input type="number" id="callCountInput" placeholder="0">

        <label class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="notesInput" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§..."></textarea>

        <label class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</label>
        <select id="callStatusSelect"></select>

        <label class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
        <input type="date" id="nextCallDateInput">

        <!-- ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ -->
        <button class="btn" style="background:linear-gradient(135deg, #ff9100, #ffea00); margin-bottom:10px;" onclick="openPayment()">
          ğŸ’³ Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        </button>

        <div class="action-buttons">
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn" style="background:linear-gradient(135deg, #00e676, #69f0ae); flex: 1; margin-bottom:10px;" onclick="openWhatsApp()">
              ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨
            </button>
            <div
              style="display: flex; align-items: center; background: #f8f9fa; padding: 0 10px; border-radius: 8px; height: 60px; border: 1px solid #ccc; margin-bottom:10px;">
              <input type="checkbox" id="whatsappSentCheckbox" style="width: 20px; height: 20px; margin: 0;">
              <label for="whatsappSentCheckbox"
                style="margin-right: 8px; font-size: 14px; cursor: pointer; white-space: nowrap;">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
            </div>
          </div>
        </div>
        
        <button class="btn" onclick="saveParentInteraction()" style="margin-bottom: 10px; background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; border: none;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn btn-outline" onclick="openFullParentDetailsModal()">ğŸ“„ ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø©</button>
      </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„) -->
    <div class="sidebar-right" id="historySidebar">
      <div class="sidebar-header">
        <span>Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</span>
        <button class="close-sidebar" onclick="closeSidebar()">âœ•</button>
      </div>
      <div class="sidebar-content" id="historyInfo"></div>
    </div>

  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† (Password masked) -->
  <div class="center-screen" id="adminLoginScreen" style="display:none; z-index:500;">
    <div class="box" style="width:95%; margin:0 auto; text-align:right;">
      <h2 style="text-align:center;">ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
      <div style="padding:6px 0; text-align:right;">
        <label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù†</label>
        <input type="password" id="admin_login_input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
          style="width:100%; padding:10px; margin-top:6px;">
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn" onclick="submitAdminLogin()">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn btn-secondary" onclick="closeAdminLogin()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Password masked) -->
  <div class="center-screen" id="generalAdminLoginModal" style="display:none; z-index:950;">
    <div class="box" style="width:95%; margin:0 auto; text-align:right;">
      <h2 style="text-align:center;">ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
      <div style="padding:6px 0; text-align:right;">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="general_admin_pass_input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
          style="width:100%; padding:10px; margin-top:6px;">
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn" onclick="submitGeneralAdminLogin()">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn btn-secondary" onclick="closeGeneralAdminLogin()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <div class="center-screen" id="settingsScreen" style="display:none; z-index:20;">
    <div class="box"
      style="width: 98%; max-width:none; height:98%; display:flex; flex-direction:column; text-align: right;">
      <h2 style="text-align:center; font-size: 32px; font-weight: 900;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>

      <div style="flex:1; overflow-y: auto; padding: 5px;">

        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div id="settingsMenu" class="settings-menu-grid">
           <button class="btn" onclick="showSettingsSection('general')">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© (Ø§Ù„Ù„ÙˆÙ† - Ø§Ù„Ø±Ø§Ø¨Ø·)</button>
           <button class="btn" onclick="openAdvancedStats()">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†)</button>
           <button class="btn" onclick="showSettingsSection('employees')">ğŸ‘¥ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„</button>
           <button class="btn" onclick="openTargetStats()">ğŸ¯ Ù†Ø³Ø¨Ø© ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</button>
           <button class="btn" onclick="openDebtStats()">ğŸ’° Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</button>
           <button class="btn" onclick="showSettingsSection('data')">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ÙˆØ§Ù„Ø¨Ø­Ø«</button>
           <button class="btn" onclick="openAllParentsReport()" style="background:linear-gradient(135deg, #009688, #4db6ac); color:white;">ğŸ“‹ Ø¹Ø±Ø¶ ÙƒÙ„ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± (ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„)</button>
           <button class="btn btn-secondary" onclick="closeSettings()" style="background:#ffebee; border-color:#ef5350; color:#c62828;">ğŸšª Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
        <div id="settingsGeneral" style="display:none;">
        <button class="btn btn-outline" onclick="backToSettingsMenu()" style="margin-bottom:20px;">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <h3 style="border-bottom: 2px solid #ccc; padding-bottom: 10px;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± -->
        <div style="display:flex; gap:20px; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
          <div style="flex:1;">
            <label style="font-size: 20px;">ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
            <input type="color" id="themeColor" style="height:40px; padding:2px;">
            <label style="font-size: 20px;">Ø§Ù„Ù„ÙˆÙ†</label>
            <input type="color" id="themeColor" style="height:40px; padding:2px;" oninput="document.documentElement.style.setProperty('--primary-color', this.value)">
          </div>
          <div style="flex:2;">
            <label style="font-size: 20px;">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹</label>
            <label style="font-size: 20px;">Ø§Ù„Ø±Ø§Ø¨Ø·</label>
            <input type="text" id="paymentUrlSetting" style="margin-bottom:0;">
          </div>
        </div>
        <div style="margin-top:20px;">
            <button class="btn" onclick="saveSettingsAndData(false, this)">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</button>
        </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="settingsEmployees" style="display:none;">
        <button class="btn btn-outline" onclick="backToSettingsMenu()" style="margin-bottom:20px;">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <h3 style="border-bottom: 2px solid #ccc; padding-bottom: 10px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„</h3>
        <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
          <label style="font-size: 22px; color: #1565c0; font-weight:900;">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</label>
          <p style="font-size:12px; color:#666; margin-top:0;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†. Ø§Ù„Ù…ÙØªØ§Ø­ (Key) ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
          <div id="receptionSettingsContainer"></div>
          <button class="btn btn-add btn-sm" onclick="addReceptionEmployeeRow()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
          <label style="font-size: 22px; color: #2e7d32; font-weight:900;">ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
          <p style="font-size:12px; color:#666; margin-top:0;">Ø£Ø¶Ù Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙŠ Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ø²Ø± "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„".</p>
          <div id="stagesSettingsContainer"></div>
          <button class="btn btn-add btn-sm" onclick="addStageRow()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
        <div style="margin-top:20px;">
            <button class="btn" onclick="saveSettingsAndData(false, this)">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„</button>
        </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« -->
        <div id="settingsData" style="display:none;">
        <button class="btn btn-outline" onclick="backToSettingsMenu()" style="margin-bottom:20px;">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <h3 style="border-bottom: 2px solid #ccc; padding-bottom: 10px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø«</h3>
        <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
          <label style="font-size: 22px; color: #6a1b9a; font-weight:900;">ğŸ” Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
          <p style="font-size:12px; color:#666; margin-top:0;">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø·Ø§Ù„Ø¨ Ø£Ùˆ ÙˆÙ„ÙŠ Ø£Ù…Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯ Ø¥Ù„ÙŠÙ‡.</p>
          <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
            <select id="globalSearchCol" style="width:150px; margin-bottom:0;">
              <option value="parent_name">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</option>
              <option value="parent_code">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</option>
              <option value="student_name">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</option>
              <option value="student_code">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</option>
              <option value="phone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</option>
              <option value="identity_no">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</option>
            </select>
            <input type="text" id="globalSearchInput" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..." style="margin-bottom:0; flex:1;">
            <div style="display:flex; align-items:center; background:#f5f5f5; padding:0 10px; border-radius:12px; border:2px solid #e0e0e0; height:54px;">
                <input type="checkbox" id="globalSearchExact" style="width:20px; height:20px; margin:0;">
                <label for="globalSearchExact" style="margin-right:8px; font-size:14px; cursor:pointer; white-space:nowrap;">Ù…Ø·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹</label>
            </div>
            <button class="btn" onclick="searchGlobalDB()" style="width:auto; margin-bottom:0; background:#6a1b9a; color:white;">Ø¨Ø­Ø«</button>
          </div>
          <div id="globalSearchResults" style="margin-top:15px; overflow:auto; max-height:300px; border:1px solid #eee; border-radius:8px;"></div>
        </div>

        <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
          <label style="font-size: 20px;">ğŸ“ Ø®ÙŠØ§Ø±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø¶Ø¹ ÙƒÙ„ Ø®ÙŠØ§Ø± ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)</label>
          <textarea id="statusOptionsInput" placeholder="Ù…Ø´ØºÙˆÙ„
Ù„Ù… ÙŠØ±Ø¯
ØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚" style="height:250px; width:75%; margin:10px auto; display:block; padding:12px; box-sizing:border-box; overflow-y:scroll; border:3px solid #ccc; font-size:18px;"></textarea>
        </div>

        <div class="settings-group">
          <label
            style="font-size:22px; color:#2979ff; border-bottom:2px solid #eee; padding-bottom:5px; font-weight:900;">ğŸ“‚
            Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù†Ø³Ø®/Ù„ØµÙ‚ Excel)</label>
          <p style="font-size:12px; color:#666; margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ØŒ Ø«Ù… Ø§Ø¶ØºØ· "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª
            Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.</p>
          <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap;">
            <select id="importEmpSelect"
              style="width:200px; margin:0; font-weight:bold; border:2px solid #2979ff;">
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>
              <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
              <option value="global_update">Ø§Ù„Ù„ØµÙ‚ Ù‡Ù†Ø§ (ØªØ­Ø¯ÙŠØ« Ø´Ø§Ù…Ù„)</option>
            </select>
            <button class="btn btn-outline" onclick="loadDataToGrid()" style="width:auto; margin:0;">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
            <button class="btn btn-outline" onclick="togglePasteArea()" style="width:auto; margin:0;">ğŸ“‹ Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª
              Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="btn btn-outline" onclick="clearPasteAreaAndGrid()"
              style="width:auto; margin:0; color:#ff5722; border-color:#ff5722;">ğŸ§¹ Ù…Ø³Ø­</button>
            <button class="btn btn-outline" onclick="deleteEmployeeDataDB()"
              style="width:auto; margin:0; color:red; border-color:red; background:#fff5f5;">âŒ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
              Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
          </div>

          <textarea id="excelPasteArea" class="excel-input" style="display:none; margin-bottom:10px;"
            placeholder="Ø§Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ ÙˆØ§Ù„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§... (Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø±Ù‚Ù… - Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ - Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ - Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ - Ø§Ø³Ù… Ø§Ù„ÙˆÙ„ÙŠ - Ø§Ù„Ù‡ÙˆÙŠØ© - Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„Ù…Ø¯ÙˆØ± - Ù1 - Ù2 - Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)"
            oninput="convertPasteToGrid()">
        </textarea>

          <div id="gridContainer" style="max-height:700px; overflow:auto; border:1px solid #ddd; border-radius:8px;">
            <p style="text-align:center; padding:20px; color:#999;">Ø§Ø®ØªØ± "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ø£Ùˆ "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡
            </p>
          </div>
          <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
             <button class="btn" onclick="saveSettingsAndData(false, this)" style="width:auto; background:#43a047; color:white;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ø¯ÙˆÙ† Ø¥ØºÙ„Ø§Ù‚)</button>
             <button class="btn" onclick="saveSettingsAndData(true, this)" style="width:auto; background:#1e88e5; color:white;">ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
          </div>
        </div>

      </div>

      <div id="globalUpdateStats" style="display:none; margin-top:10px; padding:10px; background:#e3f2fd; border-radius:8px; text-align:center; font-weight:bold; border: 1px solid #90caf9;">
        <span style="color:#2e7d32; margin-left:20px;">âœ… Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«: <span id="updateCount" style="font-size:1.2em;">0</span></span>
        <span style="color:#c62828;">ğŸš« Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ (Ø¬Ø¯ÙŠØ¯): <span id="ignoreCount" style="font-size:1.2em;">0</span></span>
      </div>
      
      </div>
      </div>

    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ ÙƒÙ„ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± (ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„) -->
  <div class="center-screen" id="allParentsScreen" style="display:none; z-index:800;">
    <div class="box box-large" style="display:flex; flex-direction:column; height:95vh;">
      <div class="header-bar">
        <h3>ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</h3>
        <div style="display:flex; gap:10px; align-items:center;">
           <select id="allParentsFilterEmp" onchange="filterAllParentsTable()" style="margin:0; width:180px;">
             <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
             <!-- Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© -->
           </select>
           
           <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ø­Ø« -->
           <select id="allParentsSearchCol" onchange="filterAllParentsTable()" style="margin:0; width:150px;">
             <option value="all">Ø¨Ø­Ø« Ø´Ø§Ù…Ù„</option>
             <option value="parent_name">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</option>
             <option value="parent_code">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</option>
             <option value="phone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</option>
             <option value="student_name">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</option>
             <option value="notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
           </select>

           <input type="text" id="allParentsSearch" oninput="filterAllParentsTable()" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..." style="margin:0; width:200px;">
           <button class="btn btn-outline" onclick="exportAllParentsToExcel()" style="width:auto; margin:0;">ğŸ“¥ Excel</button>
           <button class="btn btn-secondary" onclick="document.getElementById('allParentsScreen').style.display='none'" style="width:auto; margin:0;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="table-container" style="flex:1; margin-top:10px;">
        <table id="allParentsTable">
          <thead></thead><tbody id="allParentsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„) -->
  <div class="center-screen" id="adminScreen" style="display:none; z-index:30;">

    <!-- Ø´Ø§Ø´Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù (ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©) -->
    <div class="center-screen" id="employeeSettingsScreen" style="display:none; z-index:520;">
      <div class="box" style="width:95%; margin:0 auto; text-align:right;">
        <h2 style="text-align:center;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h2>
        <div id="employeeSettingsTitle" style="text-align:center; font-weight:700; margin-bottom:8px; color:#333;">
        </div>
        <div style="padding:6px 0;">
          <label>ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</label>
          <input type="password" id="emp_pass_input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©">
          <label style="margin-top:10px; display:block;">ğŸ¨ ÙˆØ§Ø¬Ù‡Ø© Ø®Ø§ØµØ©</label>
          <input type="color" id="emp_theme_input" style="height:40px; padding:2px;">
          <div style="margin-top:8px; display:flex; gap:8px; justify-content:center;">
            <button class="btn btn-outline" onclick="resetEmployeeTheme()" style="width:auto;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
            <span style="align-self:center; color:#666; font-size:13px;">(Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ø­Ø³Ø§Ø¨Ùƒ ÙÙ‚Ø·)</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px; justify-content:center;">
          <button class="btn" onclick="saveEmployeeSettings()">Ø­ÙØ¸</button>
          <button class="btn btn-secondary" onclick="closeEmployeeSettings()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
    <div class="box box-large" style="display:flex; flex-direction:column;">
      <h2>ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ (ÙˆØ¶Ø¹ Ø§Ù„Ø¥ÙƒØ³Ù„)</h2>
      <p style="color:#666; font-size:14px;">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ù†Ø§ ÙˆÙ„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø«Ù… Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ ÙˆÙ„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§
        Ù„Ù„Ø­ÙØ¸. <br> <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ
        Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡.</p>

      <textarea id="adminDataInput"
        style="flex:1; white-space:pre; overflow:auto; font-family:monospace; font-size:12px; border:2px solid #2979ff;"
        placeholder="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."></textarea>

      <div style="display:flex; gap:10px; justify-content:center;">
        <button class="btn" onclick="saveAdminDataFull()" style="background:#d32f2f;">ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„</button>
        <button class="btn btn-outline" onclick="loadAdminData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="btn btn-secondary" onclick="closeAdminPanel()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Modal) -->
  <div class="center-screen" id="fullDetailsModal" style="display:none; z-index:600;">
    <div class="box" style="width: 95%; text-align: right;">
      <h2 style="color:#2979ff; border-bottom: 2px solid #eee; padding-bottom:10px;">ğŸ“„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h2>
      <div id="fullDetailsContent" style="max-height: 60vh; overflow-y: auto; padding: 10px;">
        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
      </div>
      <div style="margin-top:20px; text-align:center;">
        <button class="btn btn-secondary" onclick="document.getElementById('fullDetailsModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Drill-down) -->
  <div class="center-screen" id="statsDrillDownModal" style="display:none; z-index:650;">
    <div class="box box-large">
      <h2 id="drillDownTitle" style="color:#2979ff;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</h2>
      <div id="drillDownContent" style="max-height: 70vh; overflow: auto;"></div>
      <button class="btn btn-secondary" onclick="document.getElementById('statsDrillDownModal').style.display='none'" style="margin-top:15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Dashboard) -->
  <div class="center-screen" id="generalAdminScreen" style="display:none; z-index:900;">
    <div class="box box-large" style="background: #f8f9fa; display: flex; flex-direction: column; height: 98vh; padding: 0; overflow: hidden;">
      <div class="header-bar" style="background: #fff; margin: 10px; border-radius: 12px; flex-shrink: 0;">
        <h2 style="margin:0; color: var(--primary-color);">ğŸ›ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select id="adminPeriodSelect" onchange="toggleAdminDateInputs(); renderGeneralAdminDashboard()" style="padding:10px; border-radius:8px; border:1px solid #ddd; font-weight:bold;">
                <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                <option value="month" selected>Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                <option value="all">Ø§Ù„ÙƒÙ„ (Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)</option>
                <option value="custom">ÙØªØ±Ø© Ù…Ø­Ø¯Ø¯Ø©</option>
            </select>
            <div id="adminCustomDateDiv" style="display:none; align-items:center; gap:5px;">
                <input type="date" id="adminDateFrom" style="padding:8px; border-radius:8px; border:1px solid #ddd; margin:0; width:auto;">
                <span>Ø¥Ù„Ù‰</span>
                <input type="date" id="adminDateTo" style="padding:8px; border-radius:8px; border:1px solid #ddd; margin:0; width:auto;">
                <button class="btn btn-sm" onclick="renderGeneralAdminDashboard()" style="height:38px; margin:0;">Ø¹Ø±Ø¶</button>
            </div>
            <button class="btn btn-outline" onclick="exportAdminStatsToExcel()" style="width:auto; font-size:14px; padding:5px 15px;">ğŸ“¥ Excel</button>
            <button class="btn btn-outline" onclick="changeAdminPassword()" style="width:auto; font-size:14px; padding:5px 15px;">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
            <button class="btn btn-secondary" onclick="document.getElementById('generalAdminScreen').style.display='none'" style="width:auto;">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 0 10px 10px 10px;">
        
        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ: Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø²Ù…Ù†ÙŠ -->
        <div style="flex: 0 0 45%; background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: var(--primary-color);">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                <select id="adminChartType" onchange="renderGeneralAdminDashboard(true)" style="width:auto; padding:5px; border-radius:5px; border:1px solid #ccc; font-weight:bold;">
                    <option value="bar">Ø£Ø¹Ù…Ø¯Ø© (Bar)</option>
                    <option value="line">Ø®Ø·ÙŠ (Line)</option>
                </select>
            </div>
            <div style="flex:1; position:relative; min-height: 0;">
                <canvas id="adminDailyChart"></canvas>
            </div>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ: Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªÙØµÙŠÙ„ÙŠ -->
        <div class="table-container" style="flex: 1; overflow: auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; border: 1px solid #eee;">
            <table id="adminFullStatsTable" class="excel-preview-table" style="width: 100%; min-width: max-content;">
                <thead>
                    <!-- Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                </thead>
                <tbody>
                    <!-- Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://emrsfzmaqmfavehrdppw.supabase.co',
      'sb_publishable_dmZ-1l-BmDzIteU1IaSjnw_3TMkHMhw'
    );

    // ===== Usage tracking =====
    const pushUsageEvent = async (evt) => {
      try {
        await supabase.from('employee_usage').insert(evt);
      } catch (e) {
        console.debug('Supabase insert for usage event failed:', e?.message || e);
      }
    };

    const sessionStartTimes = {};

    const recordLogin = (employee) => {
      const now = Date.now();
      sessionStartTimes[employee] = now;
      pushUsageEvent({ employee, type: 'login', ts: new Date().toISOString() });
    };

    const recordLogout = (employee) => {
      try {
        const start = sessionStartTimes[employee];
        if (start) {
          const end = Date.now();
          const duration = Math.max(0, end - start);
          pushUsageEvent({
            employee,
            type: 'session',
            start: new Date(start).toISOString(),
            end: new Date(end).toISOString(),
            duration_ms: duration
          });
          delete sessionStartTimes[employee];
        } else {
          pushUsageEvent({ employee, type: 'logout', ts: new Date().toISOString() });
        }
      } catch (e) { console.error(e); }
    };

    let currentEmployee = "";
    let currentParentId = null;
    let currentParentCode = "";
    let currentStudentCode = "";
    let currentParentPhone = "";
    let currentParentIdentity = "";

    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø±Ù‚Ù… Ø¹Ø±Ø¨ÙŠ/ÙØ§Ø±Ø³ÙŠ/Ù„ØºÙˆÙŠ Ø¥Ù„Ù‰ Ø±Ù‚Ù… JS ØµØ§Ù„Ø­ - ØªØ¹Ø±ÙŠÙ Ø¹Ø§Ù…
    window.cleanNumber = (input) => {
      if (input === null || input === undefined) return 0;
      let s = input.toString().trim();

      const map = {
        'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4', 'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9',
        'Û°': '0', 'Û±': '1', 'Û²': '2', 'Û³': '3', 'Û´': '4', 'Ûµ': '5', 'Û¶': '6', 'Û·': '7', 'Û¸': '8', 'Û¹': '9'
      };
      s = s.replace(/[Ù -Ù©Û°-Û¹]/g, d => map[d] || d);
      s = s.replace(/[\u200B\u200C\u200E\u200F\u202F\s\u00A0]/g, '');

      if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
        if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
          s = s.replace(/\./g, '').replace(/,/g, '.');
        } else {
          s = s.replace(/,/g, '');
        }
      } else if (s.indexOf(',') !== -1) {
        if (/^\d{1,3}(,\d{3})+$/.test(s) || s.match(/,\d{3}$/)) {
            s = s.replace(/,/g, '');
        } else {
            s = s.replace(/,/g, '.');
        }
      }
      s = s.replace(/[^0-9.\-]/g, '');
      const num = parseFloat(s);
      return isNaN(num) ? 0 : num;
    };

    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    let appConfig = {
      theme: '#00e5ff',
      paymentUrl: 'https://google.com',
      passwords: { emp1: '', emp2: '', emp3: '', emp4: '' },
      employeeNames: { emp1: 'Ù…ÙˆØ¸Ù 1', emp2: 'Ù…ÙˆØ¸Ù 2', emp3: 'Ù…ÙˆØ¸Ù 3', emp4: 'Ù…ÙˆØ¸Ù 4' },
      employeeThemes: {},
      statusOptions: "Ù…Ø´ØºÙˆÙ„\nÙ„Ù… ÙŠØ±Ø¯\nÙ…Ø¹ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯\nÙ…Ø¹ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…\nØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯",
      manualTargetData: {}, // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù„Ù„Ù…Ø³ØªÙ‡Ø¯Ù
      stages: { 'stage1': { name: 'Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', pass: '' }, 'stage2': { name: 'Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…ØªÙˆØ³Ø·', pass: '' }, 'stage3': { name: 'Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', pass: '' } },
      adminPass: 'admin', // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      schoolTotalFees: 0, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
      schoolTarget: 0 // Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø§Ù„Ø¹Ø§Ù…
    };

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function saveConfigToDB() {
      try {
        const { error } = await supabase.from('app_config').upsert({
          id: 1,
          config: appConfig,
          updated_at: new Date().toISOString()
        });
        if (error) {
          console.error('Error saving settings to DB:', error);
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù†Ø´Ø¦Ù‡
          if (error.message.includes('does not exist')) {
            await createTablesIfNotExist();
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
            await saveConfigToDB();
          }
        }
      } catch (e) {
        console.error('Failed to save config:', e);
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    async function createTablesIfNotExist() {
      try {
        console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©...');

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ app_config Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const { error: configError } = await supabase.rpc('create_tables_if_not_exist');

        if (configError) {
          console.log('RPC ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… SQL Ù…Ø¨Ø§Ø´Ø±Ø©...');
          // Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ÙØ±Ø¯ÙŠØ©
        }
      } catch (e) {
        console.error('Error in createTablesIfNotExist:', e);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadSettings() {
      try {
        const { data, error } = await supabase.from('app_config').select('config').eq('id', 1).single();

        if (error) {
          console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:', error.message);
          // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          await saveConfigToDB();
        } else if (data && data.config) {
          const parsed = data.config;
          appConfig = Object.assign({}, appConfig, parsed);

          // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          appConfig.passwords = Object.assign({ emp1: '', emp2: '', emp3: '', emp4: '' }, appConfig.passwords || {});
          appConfig.employeeNames = Object.assign({
            emp1: 'Ù…ÙˆØ¸Ù 1',
            emp2: 'Ù…ÙˆØ¸Ù 2',
            emp3: 'Ù…ÙˆØ¸Ù 3',
            emp4: 'Ù…ÙˆØ¸Ù 4'
          }, appConfig.employeeNames || {});
          
          // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          appConfig.stages = Object.assign({ 'stage1': { name: 'Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', pass: '' }, 'stage2': { name: 'Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…ØªÙˆØ³Ø·', pass: '' } }, appConfig.stages || {});
          appConfig.adminPass = appConfig.adminPass || 'admin';
          appConfig.schoolTotalFees = appConfig.schoolTotalFees || 0;
          appConfig.schoolTarget = appConfig.schoolTarget || 0;

          appConfig.employeeThemes = Object.assign({}, appConfig.employeeThemes || {});

          console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', appConfig);
        }
      } catch (e) {
        console.error('Failed to load appConfig from DB:', e);
      }

      applyTheme();
      renderEntryScreen('main');
      updateImportSelect();
      
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    }

    function applyTheme() {
      const empTheme = (currentEmployee && appConfig.employeeThemes && appConfig.employeeThemes[currentEmployee]);
      document.documentElement.style.setProperty('--primary-color', empTheme || appConfig.theme);
    }

    function getEmployeeLabel(emp) {
      if (appConfig.employeeNames && appConfig.employeeNames[emp]) return appConfig.employeeNames[emp];
      if (appConfig.stages && appConfig.stages[emp]) return appConfig.stages[emp].name;
      return emp;
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Ù…ÙˆØ¸ÙÙŠÙ† / Ù…Ø±Ø§Ø­Ù„)
    window.renderEntryScreen = (view = 'main') => {
      const container = document.getElementById('employeeButtons');
      container.innerHTML = '';

      if (view === 'main') {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const grid = document.createElement('div');
        grid.className = 'main-dashboard-grid';

        // 1. ÙƒØ±Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        grid.innerHTML += `
            <div class="dash-card card-employees" onclick="renderEntryScreen('employees')">
                <div class="icon">ğŸ‘¥</div>
                <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                <p>Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ù„ØªØ­ØµÙŠÙ„</p>
            </div>
        `;

        // 2. ÙƒØ±Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        grid.innerHTML += `
            <div class="dash-card card-stages" onclick="renderEntryScreen('stages')">
                <div class="icon">ğŸ«</div>
                <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</h3>
                <p>Ù…Ø´Ø±ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
            </div>
        `;

        // 3. ÙƒØ±Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Ù…Ù…ÙŠØ²)
        grid.innerHTML += `
            <div class="dash-card card-admin" onclick="openGeneralAdmin()">
                <div class="icon">ğŸ›ï¸</div>
                <h3>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                <p>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</p>
            </div>
        `;

        // 4. ÙƒØ±Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ù…ÙŠØ²)
        grid.innerHTML += `
            <div class="dash-card card-settings" onclick="openSettingsAdmin()">
                <div class="icon">âš™ï¸</div>
                <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            </div>
        `;
        
        container.appendChild(grid);

      } else if (view === 'employees') {
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        const grid = document.createElement('div');
        grid.className = 'card-container';
        // ÙƒØ±ÙˆØª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        Object.keys(appConfig.employeeNames || {}).forEach((emp, index) => {
          const card = document.createElement('div');
          card.className = 'emp-card';
          card.innerHTML = `<div class="title">${getEmployeeLabel(emp)}</div>`;
          card.style.animationDelay = `${index * 0.1}s`;
          card.onclick = () => checkPasswordAndLogin(emp);
          grid.appendChild(card);
        });
        container.appendChild(grid);

        // Ø²Ø± Ø±Ø¬ÙˆØ¹
        const backBtn = document.createElement('button');
        backBtn.className = 'btn btn-secondary';
        backBtn.style.marginTop = '20px';
        backBtn.innerText = 'ğŸ”™ Ø±Ø¬ÙˆØ¹';
        backBtn.onclick = () => renderEntryScreen('main');
        container.appendChild(backBtn);

      } else if (view === 'stages') {
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        const grid = document.createElement('div');
        grid.className = 'card-container';
        // ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        const stages = appConfig.stages || {};
        Object.keys(stages).forEach((key, index) => {
            const card = document.createElement('div');
            card.className = 'emp-card';
            card.innerHTML = `<div class="title">${stages[key].name}</div>`;
            card.style.animationDelay = `${index * 0.1}s`;
            card.onclick = () => checkStagePasswordAndLogin(key);
            grid.appendChild(card);
        });
        container.appendChild(grid);

        // Ø²Ø± Ø±Ø¬ÙˆØ¹
        const backBtn = document.createElement('button');
        backBtn.className = 'btn btn-secondary';
        backBtn.style.marginTop = '20px';
        backBtn.innerText = 'ğŸ”™ Ø±Ø¬ÙˆØ¹';
        backBtn.onclick = () => renderEntryScreen('main');
        container.appendChild(backBtn);
      }
    }

    window.checkPasswordAndLogin = (emp) => {
      const pass = appConfig.passwords[emp];
      if (pass && pass.trim() !== "") {
        const input = prompt("ğŸ”’ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
        if (input !== pass) {
          alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
          return;
        }
      }
      showDataForEmployee(emp);
      try { recordLogin(emp); } catch (e) { console.error(e); }
    };

    window.checkStagePasswordAndLogin = (stageKey) => {
      const stage = appConfig.stages[stageKey];
      if (stage && stage.pass && stage.pass.trim() !== "") {
        const input = prompt(`ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ${stage.name}:`);
        if (input !== stage.pass) {
          alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
          return;
        }
      }
      showDataForStage(stageKey);
      try { recordLogin(stageKey); } catch (e) { console.error(e); }
    };

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ±ØªÙŠØ¨
    window.currentEmployeeData = [];
    window.currentViewMode = 'reception'; // 'reception' or 'stage'
    let currentSort = { field: 'serial_no', dir: 'asc' };
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©
    const columnDefinitions = {
      last_call_status: { label: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„', type: 'text' },
      notes: { label: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', type: 'text', style: 'max-width:200px; overflow:hidden; text-overflow:ellipsis;' },
      serial_no: { label: 'Ù…', type: 'number' },
      parent_code: { label: 'Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ', type: 'text' },
      parent_name: { label: 'Ø§Ù„Ø§Ø³Ù…', type: 'text' },
      identity_no: { label: 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©', type: 'text' },
      phone: { label: 'Ø§Ù„Ø¬ÙˆØ§Ù„', type: 'text' },
      updated_at: { label: 'ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„', type: 'date' },
      next_call_date: { label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…', type: 'date' },
      carried_balance: { label: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±', type: 'money' },
      term1_balance: { label: 'Ø±ØµÙŠØ¯ Ù1', type: 'money' },
      term2_balance: { label: 'Ø±ØµÙŠØ¯ Ù2', type: 'money' },
      final_balance: { label: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', type: 'money' }
    };
    let currentColumnOrder = [];

    window.applySort = () => {
      currentSort.field = document.getElementById('sortCriteria').value;
      sortAndRender();
      sortAndRender(); // This will sort and then call filterTable
    };

    window.toggleSortDirection = () => {
      currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      document.getElementById('sortDirectionBtn').innerText = currentSort.dir === 'asc' ? 'â¬‡ï¸' : 'â¬†ï¸';
      sortAndRender();
    };

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
    window.filterTable = () => {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const col = document.getElementById('searchColumn').value;
        
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø±ØªØ¨Ø© Ø¨Ø§Ù„ÙØ¹Ù„)
        const filtered = window.currentEmployeeData.filter(row => {
            if (!query) return true;
            if (col === 'all') {
                return [row.parent_name, row.parent_code, row.phone, row.identity_no]
                    .some(val => String(val || '').toLowerCase().includes(query));
            }
            return String(row[col] || '').toLowerCase().includes(query);
        });
        
        window.currentFilteredData = filtered;
        renderParentsTable(filtered);
    };

    window.sortAndRender = () => {
      if (!window.currentEmployeeData || window.currentEmployeeData.length === 0) return;
      
      const { field, dir } = currentSort;
      
      window.currentEmployeeData.sort((a, b) => {
        let valA = a[field];
        let valB = b[field];

        if (field === 'updated_at' || field === 'next_call_date') {
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ© ØªØ¹ØªØ¨Ø± Ù‚Ø¯ÙŠÙ…Ø© Ø¬Ø¯Ø§Ù‹)
            valA = valA ? new Date(valA).getTime() : 0;
            valB = valB ? new Date(valB).getTime() : 0;
        } else if (field === 'serial_no' || field === 'final_balance' || field === 'call_count') {
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            valA = Number(valA) || 0;
            valB = Number(valB) || 0;
        } else {
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ
            valA = (valA || '').toString().toLowerCase();
            valB = (valB || '').toString().toLowerCase();
        }

        if (valA < valB) return dir === 'asc' ? -1 : 1;
        if (valA > valB) return dir === 'asc' ? 1 : -1;
        return 0;
      });

      renderParentsTable(window.currentEmployeeData);
      // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± (Ø¥Ø°Ø§ ÙˆØ¬Ø¯) Ø«Ù… Ø§Ù„Ø¹Ø±Ø¶
      filterTable();
    };

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù - Ù…Ø¹Ø¯Ù„ Ø¨Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
    window.showDataForEmployee = async (employee) => {
      console.log(`Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆØ¸Ù: ${employee}`);
      currentEmployee = employee;
      window.currentViewMode = 'reception'; // ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ (ØªØ¬Ù…ÙŠØ¹)
      applyTheme();

      // ØªØ­Ù…ÙŠÙ„ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      const savedOrder = localStorage.getItem(`colOrder_${employee}`);
      if (savedOrder) {
        currentColumnOrder = JSON.parse(savedOrder);
      } else {
        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹
        currentColumnOrder = ['last_call_status', 'notes', 'serial_no', 'parent_code', 'parent_name', 'identity_no', 'phone', 'updated_at', 'next_call_date', 'carried_balance', 'term1_balance', 'term2_balance', 'final_balance'];
      }

      document.getElementById("employeeName").innerText = "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… - " + getEmployeeLabel(employee);

      try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const { data, error } = await supabase
          .from("parents")
          .select("*")
          .eq("employee", employee)
          .order("serial_no");

        console.log("Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ù…ÙˆØ¸Ù", employee, ":", { data, error });

        if (error) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);

          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù†Ø´Ø¦ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
          if (error.message.includes('does not exist') || error.message.includes('relation') || error.code === '42P01') {
            await createSampleData(employee);
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await showDataForEmployee(employee);
            return;
          }

          const tbody = document.getElementById("tableBody");
          tbody.innerHTML = `<tr><td colspan='9' style='text-align:center; color:red;'>
          Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}
          <br><button onclick="showDataForEmployee('${employee}')" style="margin-top:10px; padding:5px 15px; background:#1976d2; color:white; border:none; border-radius:5px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </td></tr>`;
          return;
        }

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan='9' style='text-align:center; color:orange;'>
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆØ¸Ù ${getEmployeeLabel(employee)}. 
          <br>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.
        </td></tr>`;
        } else {
          // Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
          let interactions = [];

          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ù„Ø¬Ù„Ø¨ ØªÙØ§Ø¹Ù„Ø§ØªÙ‡Ù… Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…ÙˆØ¸Ù (Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„)
          const parentCodes = data.map(p => p.parent_code).filter(c => c);

          if (parentCodes.length > 0) {
            const { data: intData, error: intError } = await supabase
              .from('interactions')
              .select('*')
              .in('parent_code', parentCodes)
              .order('updated_at', { ascending: false })
              .range(0, 4999);

            if (!intError && intData) {
              interactions = intData;
            }
          }

          const intMap = {};
          interactions.forEach(i => {
            // Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø© ØªØ¸Ù‡Ø± Ù„ÙƒÙ„ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„
            if (!intMap[i.parent_code]) {
              intMap[i.parent_code] = i;
            }
          });

          // 1. Ø¯Ù…Ø¬ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹
          const rawDataWithInteractions = data.map(p => {
            const interaction = intMap[p.parent_code]; // can be undefined
            const merged = { ...p, ...interaction };
            if (!interaction) merged.updated_at = null;
            return merged;
          });

          // 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Aggregation)
          const groupedData = {};
          rawDataWithInteractions.forEach(row => {
            const pCode = row.parent_code ? String(row.parent_code).trim() : "UNKNOWN";
            if (!groupedData[pCode]) {
              // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¬Ù…Ø¹
              groupedData[pCode] = {
                ...row, // Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ Ø·Ø§Ù„Ø¨ ÙƒØ¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                student_count: 0,
                carried_balance: 0,
                term1_balance: 0,
                term2_balance: 0,
                final_balance: 0,
                _student_ids: new Set()
              };
            }

            // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙØ±ÙŠØ¯ Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¹Ø¯ Ù„Ù†ÙØ³ Ø§Ù„Ø·Ø§Ù„Ø¨)
            const sCode = row.student_code ? String(row.student_code).trim() : null;
            if (sCode) {
                if (!groupedData[pCode]._student_ids.has(sCode)) {
                    groupedData[pCode]._student_ids.add(sCode);
                    groupedData[pCode].student_count++;
                }
            } else {
                // ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… Ø·Ø§Ù„Ø¨ØŒ Ù†Ø¹Ø¯ Ø§Ù„ØµÙ ÙƒØ·Ø§Ù„Ø¨
                groupedData[pCode].student_count++;
            }

            // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø±ØµØ¯Ø©
            groupedData[pCode].carried_balance += Number(row.carried_balance || 0);
            groupedData[pCode].term1_balance += Number(row.term1_balance || 0);
            groupedData[pCode].term2_balance += Number(row.term2_balance || 0);
            groupedData[pCode].final_balance += Number(row.final_balance || 0);
          });

          // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
          window.currentEmployeeData = Object.values(groupedData).map((item, index) => {
            item.serial_no = index + 1; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù„Ø³Ù„ Ù„Ù„Ø¹Ø±Ø¶
            return item;
          });

          // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø±ØªØ¨Ø§Ù‹
          sortAndRender();
        }

        document.getElementById("employeeScreen").style.display = "none";
        document.getElementById("dashboardScreen").style.display = "block";

      } catch (e) {
        console.error("Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", e);
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = `<tr><td colspan='9' style='text-align:center; color:red;'>
        Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${e.message}
        <br><button onclick="showDataForEmployee('${employee}')" style="margin-top:10px; padding:5px 15px; background:#1976d2; color:white; border:none; border-radius:5px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
      </td></tr>`;
      }
    };

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© (ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…)
    window.showDataForStage = async (stageKey) => {
      const stageName = appConfig.stages[stageKey].name;
      console.log(`Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±Ø­Ù„Ø©: ${stageName} (${stageKey})`);
      currentEmployee = stageKey;
      window.currentViewMode = 'stage'; // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (ØªÙØµÙŠÙ„ÙŠ)
      applyTheme();

      // ØªØ­Ù…ÙŠÙ„ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ù…Ø±Ø§Ø­Ù„
      const savedOrder = localStorage.getItem(`colOrder_${stageKey}`);
      if (savedOrder) {
        currentColumnOrder = JSON.parse(savedOrder);
      } else {
        currentColumnOrder = ['last_call_status', 'notes', 'serial_no', 'student_code', 'student_name', 'parent_code', 'parent_name', 'phone', 'updated_at', 'next_call_date', 'carried_balance', 'term1_balance', 'term2_balance', 'final_balance'];
      }

      document.getElementById("employeeName").innerText = "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© - " + stageName;

      try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø³Ù†Ø¯Ø©)
        const { data, error } = await supabase
          .from("parents")
          .select("*")
          .eq("employee", stageKey) // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ ÙˆÙ„ÙŠØ³ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…
          .order("serial_no");

        if (error) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
          const tbody = document.getElementById("tableBody");
          tbody.innerHTML = `<tr><td colspan='15' style='text-align:center; color:red;'>
          Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}
          <br><button onclick="showDataForStage('${stageKey}')" class="btn btn-sm" style="margin-top:10px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </td></tr>`;
          return;
        }

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan='15' style='text-align:center; color:orange; padding:30px;'>
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ù†Ø¯Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.
        </td></tr>`;
        } else {
          // Ø¯Ù…Ø¬ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†)
          let interactions = [];
          const studentCodes = data.map(p => p.student_code).filter(c => c);

          if (studentCodes.length > 0) {
            const { data: intData, error: intError } = await supabase
              .from('interactions')
              .select('*')
              .in('student_code', studentCodes)
              .order('updated_at', { ascending: false })
              .range(0, 4999);

            if (!intError && intData) interactions = intData;
          }

          const intMap = {};
          interactions.forEach(i => { if (i.student_code && !intMap[i.student_code]) intMap[i.student_code] = i; });

          window.currentEmployeeData = data.map(p => {
            const interaction = intMap[p.student_code];
            const merged = { ...p, ...interaction };
            if (!interaction) merged.updated_at = null;
            return merged;
          });

          sortAndRender();
        }

        document.getElementById("employeeScreen").style.display = "none";
        document.getElementById("dashboardScreen").style.display = "block";

      } catch (e) {
        console.error("Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
      }
    };

    window.renderParentsTable = (dataList) => {
        const thead = document.querySelector("#parentsTable thead");
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        thead.innerHTML = "";

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const trHead = document.createElement('tr');
        currentColumnOrder.forEach((colKey, index) => {
            // ØªØ®Ø·ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø±ÙŠÙ (Ù…Ø«Ù„ student_code ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„)
            if (window.currentViewMode !== 'stage' && (colKey === 'student_code' || colKey === 'student_name')) return;
            
            // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø¹Ø±ÙØ© Ø¹Ø§Ù…Ø©
            let label = columnDefinitions[colKey] ? columnDefinitions[colKey].label : colKey;
            if (colKey === 'student_code') label = 'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨';
            if (colKey === 'student_name') label = 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨';

            const th = document.createElement('th');
            th.innerText = label;
            th.className = 'draggable';
            th.draggable = true;
            th.dataset.key = colKey;
            th.dataset.index = index;
            
            // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
            th.addEventListener('dragstart', handleDragStart);
            th.addEventListener('dragover', handleDragOver);
            th.addEventListener('drop', handleDrop);
            th.addEventListener('dragend', handleDragEnd);

            trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); // ØªØµÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª Ù„Ø­Ø³Ø§Ø¨ ÙØ±Ù‚ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø¯Ù‚Ø©

        dataList.forEach(p => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„ Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ
            let rowClass = "";
            let statusBadge = "";

            if (p.updated_at) {
              const lastCallDate = new Date(p.updated_at);
              lastCallDate.setHours(0, 0, 0, 0); // ØªØµÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª

              const diffTime = todayDate - lastCallDate;
              const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

              if (diffDays === 0) {
                rowClass = "contacted-today";
                statusBadge = ' âœ…';
              } else if (diffDays > 0) {
                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¨Ø§Ù„Ø£Ø­Ù…Ø± Ø¥Ø°Ø§ Ù…Ø± Ø£ÙƒØ«Ø± Ù…Ù† 30 ÙŠÙˆÙ…
                const badgeColor = diffDays > 30 ? '#d32f2f' : '#607d8b';
                // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙˆØªÙ†Ø³ÙŠÙ‚Ù‡
                statusBadge = ` <span style="display:inline-block; background:${badgeColor}; color:white; padding:4px 12px; border-radius:8px; font-size:16px; margin-right:5px; font-weight:bold; min-width:30px; text-align:center;" title="ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…">${diffDays}</span>`;
              }
            }

            let nextCallStyle = "";
            if (p.next_call_date) {
                const parts = p.next_call_date.split('-');
                if (parts.length === 3) {
                    const nextDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    if (nextDate < todayDate) {
                        nextCallStyle = "background-color:#ffcdd2; color:#b71c1c; font-weight:bold;";
                    }
                }
            }

            const tr = document.createElement("tr");
            if (rowClass) tr.className = rowClass;
            tr.onclick = () => selectParent(tr, p);
            
            currentColumnOrder.forEach(colKey => {
                if (window.currentViewMode !== 'stage' && (colKey === 'student_code' || colKey === 'student_name')) return;

                const td = document.createElement('td');
                let val = p[colKey];
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙ…
                if (colKey === 'updated_at') val = val ? new Date(val).toLocaleDateString('en-GB') : '-';
                else if (colKey === 'next_call_date') {
                    val = val || '-';
                    if (nextCallStyle) td.style.cssText = nextCallStyle;
                }
                else if (['carried_balance', 'term1_balance', 'term2_balance', 'final_balance'].includes(colKey)) {
                    val = Number(val || 0).toLocaleString('en-US');
                    if (colKey === 'final_balance') td.style.color = (p.final_balance || 0) > 0 ? 'red' : 'green';
                }
                else if (colKey === 'parent_name' || colKey === 'student_name') {
                    td.innerHTML = `<strong>${val || '-'}${statusBadge}</strong>`;
                    val = null; // Prevent overwriting innerHTML
                }
                else if (colKey === 'notes') {
                    td.style.maxWidth = '200px';
                    td.style.overflow = 'hidden';
                    td.style.textOverflow = 'ellipsis';
                    td.title = val || ''; // Tooltip
                }
                
                if (val !== null) td.innerText = val || '-';
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
        makeTableResizable(document.querySelector('#parentsTable'));
    };

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©
    let dragSrcEl = null;
    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.classList.add('dragging');
    }
    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
        return false;
    }
    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (dragSrcEl !== this) {
            const fromIndex = parseInt(dragSrcEl.dataset.index);
            const toIndex = parseInt(this.dataset.index);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØµÙÙˆÙØ©
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…ØµÙÙˆÙØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©ØŒ Ù„ÙƒÙ† Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ø¯ ÙŠØ®ÙÙŠ Ø¨Ø¹Ø¶Ù‡Ø§.
            // Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø³Ø­Ø¨ ÙŠØªÙ… ÙÙ‚Ø· Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©.
            // Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø¨Ø³Ø·: ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
            const item = currentColumnOrder.splice(fromIndex, 1)[0];
            currentColumnOrder.splice(toIndex, 0, item);
            
            // Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨
            localStorage.setItem(`colOrder_${currentEmployee}`, JSON.stringify(currentColumnOrder));
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù…
            renderParentsTable(window.currentFilteredData || window.currentEmployeeData);
        }
        return false;
    }
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('th').forEach(th => th.classList.remove('drag-over'));
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    async function createSampleData(employee) {
      console.log(`Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…ÙˆØ¸Ù: ${employee}`);

      const sampleData = {
        emp1: [
          { parent_code: 'EMP1_001', parent_name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', identity_no: '1234567890', phone: '0501234567', serial_no: 1, carried_balance: 1000, term1_balance: 500, term2_balance: 300, final_balance: 1800 },
          { parent_code: 'EMP1_002', parent_name: 'Ø³Ø§Ù„Ù… Ø¹Ù„ÙŠ', identity_no: '2345678901', phone: '0512345678', serial_no: 2, carried_balance: 2000, term1_balance: 1000, term2_balance: 500, final_balance: 3500 }
        ],
        emp2: [
          { parent_code: 'EMP2_001', parent_name: 'Ù…Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯', identity_no: '3456789012', phone: '0523456789', serial_no: 1, carried_balance: 1500, term1_balance: 750, term2_balance: 250, final_balance: 2500 },
          { parent_code: 'EMP2_002', parent_name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø³Ø¹ÙŠØ¯', identity_no: '4567890123', phone: '0534567890', serial_no: 2, carried_balance: 3000, term1_balance: 1500, term2_balance: 800, final_balance: 5300 }
        ],
        emp3: [
          { parent_code: 'EMP3_001', parent_name: 'Ø®Ø§Ù„Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†', identity_no: '5678901234', phone: '0545678901', serial_no: 1, carried_balance: 1200, term1_balance: 600, term2_balance: 300, final_balance: 2100 }
        ],
        emp4: [
          { parent_code: 'EMP4_001', parent_name: 'Ù†Ø§ØµØ± ÙÙ‡Ø¯', identity_no: '6789012345', phone: '0556789012', serial_no: 1, carried_balance: 2500, term1_balance: 1200, term2_balance: 600, final_balance: 4300 }
        ]
      };

      const data = sampleData[employee] || [];

      if (data.length > 0) {
        try {
          // Ø¥Ø¶Ø§ÙØ© employee Ø¥Ù„Ù‰ ÙƒÙ„ Ø³Ø¬Ù„
          const records = data.map(item => ({ ...item, employee }));

          const { error } = await supabase
            .from('parents')
            .insert(records);

          if (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©:', error);
          } else {
            console.log(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${data.length} Ø³Ø¬Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù ${employee}`);
          }
        } catch (e) {
          console.error('Ø®Ø·Ø£ ÙÙŠ createSampleData:', e);
        }
      }
    }

    // Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ„ÙŠ Ø£Ù…Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    window.selectParent = (tr, data) => {
      // Highlight row
      document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
      tr.classList.add('selected');

      // Set Data
      currentParentId = data.id;
      currentParentCode = data.parent_code;
      currentStudentCode = data.student_code || "";
      currentParentPhone = data.phone;
      currentParentIdentity = data.identity_no;
      window.currentParentData = data; // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„

      // Generate QR Code
      const qrContainer = document.getElementById('qrCodeContainer');
      if (currentParentPhone) {
        const cleanPhone = currentParentPhone.replace(/\D/g, '');
        qrContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=tel:${cleanPhone}" alt="QR Call" style="display:block; margin:0 auto;"><span style="font-size:11px; color:#666;">Ø§Ù…Ø³Ø­ Ù„Ù„Ø§ØªØµØ§Ù„</span>`;
      } else {
        qrContainer.innerHTML = '';
      }

      // Populate Sidebar
      const infoDiv = document.getElementById('sidebarInfo');
      const formatLtr = (val) => `<span class="num-cell">${val}</span>`;
      const formatDate = (dateStr) => {
        if (!dateStr) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        try {
          return new Date(dateStr).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
        } catch (e) { return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­'; }
      };

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ Ø§ØªØµØ§Ù„ Ø³Ø§Ø¨Ù‚
      const hasHistory = (data.last_call_status && data.last_call_status.trim() !== "") ||
        (data.call_count > 0) ||
        (data.notes && data.notes.trim() !== "");

      // Check if the last interaction was by another employee
      const isOtherEmployee = hasHistory && data.employee && data.employee !== currentEmployee;
      const otherEmployeeStyle = isOtherEmployee ? 'style="background-color: #fffde7; border-left: 3px solid #fbc02d;"' : '';

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„)
      const historyDiv = document.getElementById('historyInfo');
      historyDiv.innerHTML = `
      <h3 style="color: #2979ff; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</h3>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø£Ø¬Ø±Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„</div><div class="info-value">${(hasHistory && data.employee) ? getEmployeeLabel(data.employee) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</div><div class="info-value">${hasHistory ? formatDate(data.updated_at) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</div><div class="info-value" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto; background:#f9f9f9; padding:8px; border-radius:4px;">${(hasHistory && data.notes) ? data.notes : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</div><div class="info-value" style="color: #2979ff;">${(hasHistory && data.last_call_status) ? data.last_call_status : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡</div><div class="info-value">${(hasHistory && data.next_call_date) ? data.next_call_date : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group" ${otherEmployeeStyle}><div class="info-label">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø³Ø§Ø¨Ù‚Ø§Ù‹</div><div class="info-value">${(hasHistory && data.whatsapp_sent) ? 'Ù†Ø¹Ù… âœ…' : 'Ù„Ø§ âŒ'}</div></div>
    `;

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ (Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø£Ùˆ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹)
      if (window.currentViewMode === 'stage') {
        infoDiv.innerHTML = `
        <h3 style="color: #2979ff; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <div class="info-group"><div class="info-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div><div class="info-value">${data.student_name || '-'}</div></div>
        <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div><div class="info-value">${data.student_code || '-'}</div></div>
        <div class="info-group"><div class="info-label">ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div><div class="info-value">${data.parent_name || '-'}</div></div>
        <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</div><div class="info-value">${formatLtr(data.identity_no || '-')}</div></div>
        <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div><div class="info-value">${formatLtr(data.phone || '-')}</div></div>
        <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="info-value" style="color:red; font-size: 1.2em;">${formatLtr((data.final_balance || 0).toLocaleString('en-US'))}</div></div>
        <div class="info-group"><div class="info-label">Ø±ØµÙŠØ¯ Ù1</div><div class="info-value">${formatLtr((data.term1_balance || 0).toLocaleString('en-US'))}</div></div>
        <div class="info-group"><div class="info-label">Ø±ØµÙŠØ¯ Ù2</div><div class="info-value">${formatLtr((data.term2_balance || 0).toLocaleString('en-US'))}</div></div>
        <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</div><div class="info-value">${formatLtr((data.carried_balance || 0).toLocaleString('en-US'))}</div></div>
        `;
      } else {
        infoDiv.innerHTML = `
        <h3 style="color: #2979ff; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h3>
        <div class="info-group"><div class="info-label">Ø§Ù„Ø§Ø³Ù…</div><div class="info-value">${data.parent_name || '-'}</div></div>
        <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</div><div class="info-value">${formatLtr(data.identity_no || '-')}</div></div>
        <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div><div class="info-value">${formatLtr(data.phone || '-')}</div></div>
        <div class="info-group"><div class="info-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</div><div class="info-value">${formatLtr(data.student_count || 1)}</div></div>
        <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="info-value" style="color:red; font-size: 1.2em;">${formatLtr((data.final_balance || 0).toLocaleString('en-US'))}</div></div>
        <div class="info-group"><div class="info-label">Ø±ØµÙŠØ¯ Ù1</div><div class="info-value">${formatLtr((data.term1_balance || 0).toLocaleString('en-US'))}</div></div>
        <div class="info-group"><div class="info-label">Ø±ØµÙŠØ¯ Ù2</div><div class="info-value">${formatLtr((data.term2_balance || 0).toLocaleString('en-US'))}</div></div>
        <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</div><div class="info-value">${formatLtr((data.carried_balance || 0).toLocaleString('en-US'))}</div></div>
        `;
      }

      // Set Inputs
      document.getElementById('callCountInput').value = data.call_count || 0;
      document.getElementById('notesInput').value = data.notes || "";

      // Populate Status Dropdown
      const statusSelect = document.getElementById('callStatusSelect');
      statusSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© --</option>';
      const options = appConfig.statusOptions.split(/\r?\n|,/).map(s => s.trim()).filter(Boolean);
      options.forEach(opt => { statusSelect.innerHTML += `<option value="${opt}">${opt}</option>`; });
      statusSelect.value = data.last_call_status || "";

      // Date
      document.getElementById('nextCallDateInput').value = data.next_call_date || "";
      document.getElementById('whatsappSentCheckbox').checked = data.whatsapp_sent || false;

      // Show Sidebar
      document.getElementById('detailsSidebar').classList.add('active');
      document.getElementById('historySidebar').classList.add('active');
    };

    window.closeSidebar = () => {
      document.getElementById('detailsSidebar').classList.remove('active');
      document.getElementById('historySidebar').classList.remove('active');
      document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
    };

    window.saveParentInteraction = async () => {
      if (!currentParentCode) return alert("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±");

      try {
        const callsInput = document.getElementById('callCountInput').value;
        const calls = callsInput ? parseInt(callsInput) : 0;
        const notes = document.getElementById('notesInput').value;
        const status = document.getElementById('callStatusSelect').value;
        const nextDate = document.getElementById('nextCallDateInput').value;
        const whatsappSent = document.getElementById('whatsappSentCheckbox').checked;

        const sCode = (window.currentViewMode === 'stage' && currentStudentCode) ? currentStudentCode : '';

        const { error } = await supabase
          .from('interactions')
          .upsert({
            parent_code: currentParentCode,
            student_code: sCode,
            employee: currentEmployee,
            call_count: calls,
            notes: notes,
            last_call_status: status,
            next_call_date: nextDate || null,
            whatsapp_sent: whatsappSent,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'employee,parent_code,student_code'
          });

        if (error) {
          console.error('Error saving interaction:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message);
        } else {
          alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
          closeSidebar();
          showDataForEmployee(currentEmployee);
        }
      } catch (e) {
        console.error("Network/Fetch error:", e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + e.message);
      }
    };

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    window.openFullParentDetailsModal = () => {
      if (!window.currentParentData) return;
      const d = window.currentParentData;
      const content = document.getElementById('fullDetailsContent');
      
      const formatVal = (v) => (v === null || v === undefined || v === '') ? '---' : v;
      const formatMoney = (v) => Number(v || 0).toLocaleString('en-US');

      content.innerHTML = `
        <table class="excel-preview-table" style="width:100%; text-align:right;">
          <tr><th colspan="2" style="background:#eee; color:#333;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</th></tr>
          <tr><td>Ø§Ù„Ø§Ø³Ù…</td><td>${formatVal(d.parent_name)}</td></tr>
          <tr><td>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ (Code)</td><td>${formatVal(d.parent_code)}</td></tr>
          <tr><td>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</td><td>${formatVal(d.identity_no)}</td></tr>
          <tr><td>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</td><td>${formatVal(d.phone)}</td></tr>
          <tr><td>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</td><td>${formatVal(d.student_count || 1)}</td></tr>
          
          <tr><th colspan="2" style="background:#eee; color:#333;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</th></tr>
          <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</td><td>${formatMoney(d.carried_balance)}</td></tr>
          <tr><td>Ø±ØµÙŠØ¯ Ø§Ù„ÙØµÙ„ 1</td><td>${formatMoney(d.term1_balance)}</td></tr>
          <tr><td>Ø±ØµÙŠØ¯ Ø§Ù„ÙØµÙ„ 2</td><td>${formatMoney(d.term2_balance)}</td></tr>
          <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</td><td style="font-weight:bold; color:${d.final_balance > 0 ? 'red' : 'green'}">${formatMoney(d.final_balance)}</td></tr>

          <tr><th colspan="2" style="background:#eee; color:#333;">Ø³Ø¬Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</th></tr>
          <tr><td>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</td><td>${formatVal(d.call_count)}</td></tr>
          <tr><td>Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</td><td>${formatVal(d.last_call_status)}</td></tr>
          <tr><td>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</td><td>${d.updated_at ? new Date(d.updated_at).toLocaleString('ar-EG') : '---'}</td></tr>
          <tr><td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</td><td>${formatVal(d.next_call_date)}</td></tr>
          <tr><td>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</td><td>${d.whatsapp_sent ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td></tr>
          <tr><td>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</td><td style="white-space:pre-wrap;">${formatVal(d.notes)}</td></tr>
        </table>
      `;
      document.getElementById('fullDetailsModal').style.display = 'flex';
    };

    window.goBack = () => {
      closeSidebar();
      document.getElementById("dashboardScreen").style.display = "none";
      document.getElementById("employeeScreen").style.display = "flex";
      renderEntryScreen('main'); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      try { recordLogout(currentEmployee); } catch (e) { console.error(e); }
    };

    window.openSettingsAdmin = () => {
      document.getElementById('admin_login_input').value = '';
      document.getElementById('adminLoginScreen').style.display = 'flex';
      setTimeout(() => { try { document.getElementById('admin_login_input').focus(); } catch (e) { } }, 50);
    };

    window.submitAdminLogin = () => {
      const pass = document.getElementById('admin_login_input').value;
      if (pass === 'admin123') {
        document.getElementById('adminLoginScreen').style.display = 'none';
        // Populate fields
        document.getElementById('themeColor').value = appConfig.theme;
        document.getElementById('paymentUrlSetting').value = appConfig.paymentUrl;
        document.getElementById('statusOptionsInput').value = appConfig.statusOptions;
        
        renderSettingsUI(); // Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        updateImportSelect();

        document.getElementById("settingsScreen").style.display = "flex";
      } else {
        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ');
      }
    };

    window.closeAdminLogin = () => { document.getElementById('adminLoginScreen').style.display = 'none'; };

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
    window.showSettingsSection = (sectionId) => {
        document.getElementById('settingsMenu').style.display = 'none';
        if(sectionId === 'general') document.getElementById('settingsGeneral').style.display = 'block';
        if(sectionId === 'employees') document.getElementById('settingsEmployees').style.display = 'block';
        if(sectionId === 'data') document.getElementById('settingsData').style.display = 'block';
    };

    window.backToSettingsMenu = () => {
        document.getElementById('settingsGeneral').style.display = 'none';
        document.getElementById('settingsEmployees').style.display = 'none';
        document.getElementById('settingsData').style.display = 'none';
        document.getElementById('settingsMenu').style.display = 'grid';
    };

    // --- Ø¯ÙˆØ§Ù„ Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ---
    window.renderSettingsUI = () => {
      // 1. Reception Employees
      const recContainer = document.getElementById('receptionSettingsContainer');
      recContainer.innerHTML = '';
      const empNames = appConfig.employeeNames || {};
      const empPass = appConfig.passwords || {};
      
      Object.keys(empNames).forEach(key => {
        const div = document.createElement('div');
        div.className = 'settings-row';
        div.innerHTML = `
          <input type="text" value="${empNames[key]}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" data-key="${key}" class="rec-name-input">
          <input type="text" value="${empPass[key] || ''}" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="rec-pass-input">
          <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>
        `;
        recContainer.appendChild(div);
      });

      // 2. Stages
      const stageContainer = document.getElementById('stagesSettingsContainer');
      stageContainer.innerHTML = '';
      const stages = appConfig.stages || {};
      
      Object.keys(stages).forEach(key => {
        const div = document.createElement('div');
        div.className = 'settings-row';
        div.innerHTML = `
          <input type="text" value="${stages[key].name}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©" data-key="${key}" class="stage-name-input">
          <input type="text" value="${stages[key].pass || ''}" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="stage-pass-input">
          <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>
        `;
        stageContainer.appendChild(div);
      });
    };

    window.addReceptionEmployeeRow = () => {
      const key = 'emp_' + Date.now(); // Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯
      const container = document.getElementById('receptionSettingsContainer');
      const div = document.createElement('div');
      div.className = 'settings-row';
      div.innerHTML = `
        <input type="text" value="" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯" data-key="${key}" class="rec-name-input">
        <input type="text" value="" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="rec-pass-input">
        <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>
      `;
      container.appendChild(div);
    };

    window.addStageRow = () => {
      const key = 'stage_' + Date.now(); // Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯
      const container = document.getElementById('stagesSettingsContainer');
      const div = document.createElement('div');
      div.className = 'settings-row';
      div.innerHTML = `
        <input type="text" value="" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" data-key="${key}" class="stage-name-input">
        <input type="text" value="" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="stage-pass-input">
        <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>
      `;
      container.appendChild(div);
    };

    window.closeSettings = () => {
      document.getElementById("settingsScreen").style.display = "none";
      backToSettingsMenu(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    };

    window.saveAppSettings = async (silent = false) => {
      appConfig.theme = document.getElementById('themeColor').value;
      appConfig.paymentUrl = document.getElementById('paymentUrlSetting').value;
      appConfig.statusOptions = document.getElementById('statusOptionsInput').value;
      
      // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      const newNames = {};
      const newPass = {};
      document.querySelectorAll('#receptionSettingsContainer .settings-row').forEach(row => {
        const nameInput = row.querySelector('.rec-name-input');
        const passInput = row.querySelector('.rec-pass-input');
        const key = nameInput.getAttribute('data-key');
        if (nameInput.value.trim()) {
            newNames[key] = nameInput.value.trim();
            newPass[key] = passInput.value.trim();
        }
      });
      appConfig.employeeNames = newNames;
      appConfig.passwords = newPass;

      // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø­Ù„
      const newStages = {};
      document.querySelectorAll('#stagesSettingsContainer .settings-row').forEach(row => {
        const nameInput = row.querySelector('.stage-name-input');
        const passInput = row.querySelector('.stage-pass-input');
        const key = nameInput.getAttribute('data-key');
        if (nameInput.value.trim()) {
            newStages[key] = {
                name: nameInput.value.trim(),
                pass: passInput.value.trim()
            };
        }
      });
      appConfig.stages = newStages;

      await saveConfigToDB();
      applyTheme();
      updateImportSelect(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
      renderEntryScreen('main');
      if (!silent) alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    };

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
    window.openEmployeeSettings = () => {
      if (!currentEmployee) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      document.getElementById('employeeSettingsTitle').innerText = getEmployeeLabel(currentEmployee);
      document.getElementById('emp_pass_input').value = appConfig.passwords[currentEmployee] || '';
      document.getElementById('emp_theme_input').value = (appConfig.employeeThemes && appConfig.employeeThemes[currentEmployee]) || appConfig.theme;
      document.getElementById('employeeSettingsScreen').style.display = 'flex';
    };

    window.saveEmployeeSettings = async () => {
      if (!currentEmployee) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      const pass = document.getElementById('emp_pass_input').value;
      const theme = document.getElementById('emp_theme_input').value;
      appConfig.passwords[currentEmployee] = pass;
      appConfig.employeeThemes = appConfig.employeeThemes || {};
      appConfig.employeeThemes[currentEmployee] = theme;
      await saveConfigToDB();
      applyTheme();
      alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù');
      document.getElementById('employeeSettingsScreen').style.display = 'none';
    };

    window.resetEmployeeTheme = async () => {
      if (!currentEmployee) return;
      if (appConfig.employeeThemes) delete appConfig.employeeThemes[currentEmployee];
      document.getElementById('emp_theme_input').value = appConfig.theme;
      await saveConfigToDB();
      applyTheme();
      alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ');
    };

    window.closeEmployeeSettings = () => { document.getElementById('employeeSettingsScreen').style.display = 'none'; };

    window.openWhatsApp = () => {
      if (!currentParentPhone) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„");
      let phone = currentParentPhone.replace(/\D/g, '');
      
      // ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ù‚Ù…: Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø¨Ù€ 05ØŒ Ù†Ø¶ÙŠÙ 966 ÙˆÙ†Ø­Ø°Ù Ø§Ù„ØµÙØ±
      if (phone.startsWith('05')) {
          phone = '966' + phone.substring(1);
      }
      
      window.open(`https://wa.me/${phone}`, '_blank');
    };

    window.openPayment = () => {
      if (!currentParentIdentity) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±");
      window.open(`https://ncle-sms.com/Payment/?id=${currentParentIdentity}`, '_blank');
    };

    // ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =====
    function formatCurrency(v) {
      return Number(v || 0).toLocaleString('en-US');
    }

    window.openStats = async () => {
      try {
        const { data, error } = await supabase.from('parents').select('*');
        if (error) {
          alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ' + error.message);
          console.error(error);
          return;
        }

        // Ø¯Ù…Ø¬ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        const { data: interactions } = await supabase.from('interactions').select('*');
        let mergedData = data || [];

        if (interactions) {
          const intMap = {};
          interactions.forEach(i => intMap[i.parent_code] = i);
          mergedData = mergedData.map(p => {
            const i = intMap[p.parent_code];
            if (i) {
              return { ...p, ...i };
            }
            return p;
          });
        }

        const byEmp = {};
        // Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ© (Ù…ÙˆØ¸ÙÙŠÙ† + Ù…Ø±Ø§Ø­Ù„)
        const knownEmps = [...Object.keys(appConfig.employeeNames || {}), ...Object.keys(appConfig.stages || {})];
        knownEmps.forEach(e => {
          byEmp[e] = { count: 0, sum_final: 0, sum_carried: 0, debtors: 0, total_calls: 0, responded: 0, no_answer: 0 };
        });

        mergedData.forEach(r => {
          const emp = r.employee || 'emp1';
          if (!byEmp[emp]) byEmp[emp] = { count: 0, sum_final: 0, sum_carried: 0, debtors: 0, total_calls: 0, responded: 0, no_answer: 0 };
          byEmp[emp].count += 1;
          byEmp[emp].sum_final += Number(r.final_balance || 0);
          byEmp[emp].sum_carried += Number(r.carried_balance || 0);
          if ((r.final_balance || 0) > 0) byEmp[emp].debtors += 1;
          byEmp[emp].total_calls += Number(r.call_count || 0);
          if (r.last_call_status && r.last_call_status.trim() !== '') byEmp[emp].responded += 1;
          if (r.last_call_status === 'Ù„Ù… ÙŠØ±Ø¯' || r.last_call_status === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯') byEmp[emp].no_answer += 1;
        });

        const html = ['<div style="padding:10px; max-height:70vh; overflow:auto;">',
          '<h3 style="text-align:center;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ù…Ù„Ø®Øµ</h3>',
          '<div class="controls" style="justify-content:center;">',
          '<select id="statsMetric" onchange="renderStatsTable()" style="margin-left:5px;">',
          '<option value="sum_final">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</option>',
          '<option value="sum_carried">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</option>',
          '<option value="count">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</option>',
          '<option value="debtors">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†</option>',
          '<option value="total_calls">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</option>',
          '<option value="responded">Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯</option>',
          '<option value="no_answer">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯</option>',
          '</select>',
          '<select id="statsCategory" onchange="renderStatsTable()" style="margin-left:5px;">',
          '<option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>',
          '<option value="reception">Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>',
          '<option value="stages">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</option>',
          '</select>',
          '<select id="statsChartType" onchange="renderStatsTable()"><option value="bar">Ø£Ø¹Ù…Ø¯Ø©</option><option value="pie">Ø¯Ø§Ø¦Ø±ÙŠ</option><option value="doughnut">Ø¯ÙˆÙ†Ø§Øª</option><option value="line">Ø®Ø·ÙŠ</option></select>',
          '<button onclick="renderStatsTable()" class="btn">ØªØ­Ø¯ÙŠØ«</button>',
          '<button class="btn" onclick="saveStatsPDF(\'statsScreen\')">Ø­ÙØ¸ ÙƒÙ€ PDF</button>',
          '</div>',
          '<canvas id="statsChart" style="max-width:100%; height:300px;"></canvas>',
          '<div id="statsTable" style="margin-top:10px;"></div>',
          '<div style="text-align:center; margin-top:10px;"><button class="btn btn-secondary" onclick="closeStats()">Ø¥ØºÙ„Ø§Ù‚</button></div>',
          '</div>'].join('');

        const screen = document.createElement('div');
        screen.className = 'center-screen';
        screen.id = 'statsScreen';
        screen.style.zIndex = 520;
        screen.innerHTML = `<div class="box box-large stats-box">${html}</div>`;
        document.body.appendChild(screen);

        window.renderStatsTable = () => {
          const metric = document.getElementById('statsMetric')?.value || 'sum_final';
          const category = document.getElementById('statsCategory')?.value || 'all';
          const metricLabels = {
             'sum_final': 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ',
             'sum_carried': 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±',
             'count': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª',
             'debtors': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†',
             'total_calls': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª',
             'responded': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯',
             'no_answer': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯'
          };

          let labelsIds = Object.keys(byEmp);
          
          // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
          if (category === 'reception') {
              const receptionKeys = Object.keys(appConfig.employeeNames || {});
              labelsIds = labelsIds.filter(id => receptionKeys.includes(id));
          } else if (category === 'stages') {
              const stageKeys = Object.keys(appConfig.stages || {});
              labelsIds = labelsIds.filter(id => stageKeys.includes(id));
          }

          const labels = labelsIds.map(id => getEmployeeLabel(id));
          const dataValues = labelsIds.map(k => byEmp[k][metric]);

          const tableHtml = ['<table class="excel-preview-table"><thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙˆØ±</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯</th><th>Ù„Ù… ÙŠØ±Ø¯</th></tr></thead><tbody>'];
          labelsIds.forEach(k => {
            tableHtml.push(`<tr><td>${getEmployeeLabel(k)}</td><td>${byEmp[k].count}</td><td>${formatCurrency(byEmp[k].sum_final)}</td><td>${formatCurrency(byEmp[k].sum_carried)}</td><td>${byEmp[k].debtors}</td><td>${byEmp[k].total_calls}</td><td>${byEmp[k].responded}</td><td>${byEmp[k].no_answer}</td></tr>`);
          });
          tableHtml.push('</tbody></table>');
          document.getElementById('statsTable').innerHTML = tableHtml.join('');
          makeTableResizable(document.querySelector('#statsTable table'));

          // Chart
          try {
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (window._statsChart) window._statsChart.destroy();
            const selectedType = document.getElementById('statsChartType')?.value || 'bar';
            window._statsChart = new Chart(ctx, {
              type: selectedType,
              data: { labels, datasets: [{ label: metricLabels[metric], data: dataValues, backgroundColor: ['#1976d2', '#43a047', '#fbc02d', '#e64a19'] }] },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: selectedType === 'pie' || selectedType === 'doughnut' },
                  title: { display: true, text: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨: ' + metricLabels[metric], font: { size: 18, weight: '600' }, color: '#333' }
                },
                scales: selectedType === 'pie' || selectedType === 'doughnut' ? {} : {
                  y: { beginAtZero: true, ticks: { font: { size: 14 }, color: '#333' } },
                  x: { ticks: { font: { size: 14 }, color: '#333' } }
                }
              }
            });
          } catch (e) { console.error('Chart render failed', e); }
        };

        renderStatsTable();
      } catch (e) {
        console.error('Error in openStats:', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ' + e.message);
      }
    };

    window.closeStats = () => {
      const s = document.getElementById('statsScreen');
      if (s) s.remove();
    };

    window.saveStatsPDF = (elementId) => {
      const el = document.getElementById(elementId);
      if (!el) return;
      const box = el.querySelector('.box');
      html2canvas(box).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("stats.pdf");
      });
    };

    window.openAdvancedStats = async () => {
      // Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      const loadingId = 'loading-' + Date.now();
      const loadingHTML = `<div id="${loadingId}" class="center-screen" style="z-index:9999"><div class="box" style="width:auto"><h3>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3></div></div>`;
      document.body.insertAdjacentHTML('beforeend', loadingHTML);

      try {
        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data: parents, error: err1 } = await supabase.from('parents').select('employee, final_balance');
        const { data: interactions, error: err2 } = await supabase.from('interactions').select('employee, call_count, whatsapp_sent, updated_at, parent_code');
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
        let usage = [];
        try {
            const { data: u } = await supabase.from('employee_usage').select('employee, type, ts, start');
            if (u) usage = u;
        } catch(e) { console.log('Usage table info not available'); }

        if (err1) throw err1; // Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¢Ø¨Ø§Ø¡
        if (err2) throw err2; // Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        window.filterAndRenderStats = () => {
            const period = document.getElementById('advPeriodSelect').value;
            const dateFrom = document.getElementById('advDateFrom').value;
            const dateTo = document.getElementById('advDateTo').value;
            const headerLabel = document.getElementById('advDateHeaderLabel');

            let startDate = new Date(0); // 1970
            let endDate = new Date(8640000000000000); // Far future

            const now = new Date();
            now.setHours(0,0,0,0);
            
            let labelText = "ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª";

            if (period === 'today') {
                startDate = new Date(now);
                endDate = new Date(now); endDate.setHours(23,59,59,999);
                labelText = `Ø§Ù„ÙŠÙˆÙ…: ${now.toLocaleDateString('ar-EG')}`;
            } else if (period === 'week') {
                const day = now.getDay();
                const diff = now.getDate() - day + (day == 0 ? -6:1); // adjust when day is sunday
                startDate = new Date(now.setDate(diff));
                endDate = new Date(now); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23,59,59,999);
                labelText = `Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${startDate.toLocaleDateString('ar-EG')} - ${endDate.toLocaleDateString('ar-EG')}`;
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                labelText = `Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ${startDate.toLocaleDateString('ar-EG', {month:'long', year:'numeric'})}`;
            } else if (period === 'year') {
                startDate = new Date(now.getFullYear(), 0, 1);
                endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                labelText = `Ø³Ù†Ø©: ${now.getFullYear()}`;
            } else if (period === 'custom') {
                if(dateFrom) startDate = new Date(dateFrom);
                if(dateTo) { endDate = new Date(dateTo); endDate.setHours(23,59,59,999); }
                labelText = `ÙØªØ±Ø© Ù…Ø®ØµØµØ©: ${startDate.toLocaleDateString('ar-EG')} Ø¥Ù„Ù‰ ${endDate.toLocaleDateString('ar-EG')}`;
            }

            headerLabel.innerText = labelText;

            // ØªØµÙÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
            const filteredInteractions = (interactions || []).filter(i => {
                if (!i.updated_at) return false;
                const d = new Date(i.updated_at);
                return d >= startDate && d <= endDate;
            });

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const stats = {};
            const empKeys = [...Object.keys(appConfig.employeeNames || {}), ...Object.keys(appConfig.stages || {})];
            empKeys.forEach(k => {
                stats[k] = { parents: 0, debt: 0, calls: 0, whatsapp: 0, logins: 0, contacted_parents_codes: [] };
            });

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø«Ø§Ø¨Øª Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø£Ù†Ù‡ Ø±ØµÙŠØ¯ Ø­Ø§Ù„ÙŠ)
            // Ù„ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø·Ù„Ø¨: "ØªØ¸Ù‡Ø± ÙƒÙ„ Ø§Ø³Ù…Ø§Ø¡ Ø§ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø§Ù…ÙˆØ± Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø¯Ù‡ Ø§Ù„ØªÙŠ Ø§Ø®ØªØ±ØªÙ‡Ø§"
            // Ù„Ø°Ø§ Ø³Ù†Ø±Ø¨Ø· Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø¨Ù…Ù† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù… ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„Ø© Drill-downØŒ Ø£Ù…Ø§ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ÙÙ‡ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
            (parents || []).forEach(p => {
                const e = p.employee || 'emp1';
                if (!stats[e]) stats[e] = { parents: 0, debt: 0, calls: 0, whatsapp: 0, logins: 0, contacted_parents_codes: [] };
                stats[e].parents++;
                stats[e].debt += (Number(p.final_balance) || 0);
            });

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (ØªØªØ£Ø«Ø± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®)
            filteredInteractions.forEach(i => {
                const e = i.employee || 'emp1';
                if (!stats[e]) stats[e] = { parents: 0, debt: 0, calls: 0, whatsapp: 0, logins: 0, contacted_parents_codes: [] };
                stats[e].calls += 1; // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ (Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡Ù…) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¬Ù…Ø¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ
                // Ø§Ù„Ø£Ø¯Ù‚: Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©
                if (i.whatsapp_sent) stats[e].whatsapp++;
                if (i.parent_code) stats[e].contacted_parents_codes.push(i.parent_code);
            });

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªØªØ£Ø«Ø± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ timestamp)
            // Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ `employee_usage` ÙŠØ­ØªÙˆÙŠ `ts` Ø£Ùˆ `start`.
            usage.forEach(u => {
                const e = u.employee || 'emp1';
                const timeStr = u.ts || u.start;
                if (timeStr) {
                    const d = new Date(timeStr);
                    if (d >= startDate && d <= endDate) {
                        if (!stats[e]) stats[e] = { parents: 0, debt: 0, calls: 0, whatsapp: 0, logins: 0, contacted_parents_codes: [] };
                        if (u.type === 'login') stats[e].logins++;
                    }
                }
            });

            window.currentStatsData = stats; // Ø­ÙØ¸ Ù„Ù„Ø±Ø³Ù…
            window.renderAdvChartAndTable();
        };

        // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const html = `
          <div style="padding:10px; height:100%; overflow:auto;">
            <h2 style="text-align:center; color:#2979ff;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø© ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
            
            <!-- Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
            <div style="background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #bbdefb;">
                <h3 id="advDateHeaderLabel" style="text-align:center; margin:0 0 10px 0; color:#1565c0;">ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª</h3>
                <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center;">
                    <select id="advPeriodSelect" onchange="toggleCustomDate(); filterAndRenderStats()" style="padding:8px; border-radius:5px;">
                        <option value="all">ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</option>
                        <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                        <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                        <option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                        <option value="year">Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</option>
                        <option value="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</option>
                    </select>
                    <span id="customDateSpan" style="display:none;">
                        Ù…Ù†: <input type="date" id="advDateFrom" onchange="filterAndRenderStats()">
                        Ø¥Ù„Ù‰: <input type="date" id="advDateTo" onchange="filterAndRenderStats()">
                    </span>
                    <button class="btn" style="width:180px; height:55px; font-size:20px; padding:0;" onclick="filterAndRenderStats()">ØªØ­Ø¯ÙŠØ«</button>
                </div>
            </div>

            <div style="display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-bottom:20px; background:#f5f5f5; padding:15px; border-radius:10px;">
                <div style="flex:1; min-width:200px;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©:</label>
                    <select id="advMetricSelect" onchange="renderAdvChartAndTable()" style="width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;">
                        <option value="calls">ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù…</option>
                        <option value="logins">ğŸ” Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
                        <option value="whatsapp">ğŸ’¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</option>
                        <option value="parents">ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±)</option>
                        <option value="debt">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</option>
                    </select>
                </div>
                <div style="flex:1; min-width:200px;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø´ÙƒÙ„ Ø§Ù„Ù…Ø®Ø·Ø·:</label>
                    <select id="advTypeSelect" onchange="renderAdvChartAndTable()" style="width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;">
                        <option value="bar">ğŸ“Š Ø£Ø¹Ù…Ø¯Ø© (Bar)</option>
                        <option value="pie">ğŸ¥§ Ø¯Ø§Ø¦Ø±ÙŠ (Pie)</option>
                        <option value="doughnut">ğŸ© Ø­Ù„Ù‚ÙŠ (Doughnut)</option>
                        <option value="line">ğŸ“ˆ Ø®Ø·ÙŠ (Line)</option>
                        <option value="polarArea">â„ï¸ Ù‚Ø·Ø¨ÙŠ (Polar Area)</option>
                    </select>
                </div>
            </div>

            <div style="background:#fff; padding:10px; border-radius:10px; border:1px solid #eee; height:400px; position:relative;">
                <canvas id="advMainChart"></canvas>
            </div>

            <h3 style="margin-top:20px; border-bottom:2px solid #eee; padding-bottom:10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</h3>
            <div id="advStatsTableContainer" style="overflow-x:auto;"></div>

            <div style="text-align:center; margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn" onclick="openTargetStats()" style="width:auto; display:inline-block; background:linear-gradient(135deg, #ab47bc, #8e24aa); color:white;">ğŸ¯ Ù†Ø³Ø¨Ø© ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</button>
                <button class="btn" onclick="saveStatsPDF('advStatsScreen')" style="width:auto; display:inline-block;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
                <button class="btn btn-secondary" onclick="document.getElementById('advStatsScreen').remove()" style="width:auto; display:inline-block;">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </div>
        `;

        const screen = document.createElement('div');
        screen.className = 'center-screen';
        screen.id = 'advStatsScreen';
        screen.style.zIndex = 600;
        screen.innerHTML = `<div class="box box-large" style="max-width:900px;">${html}</div>`;
        document.body.appendChild(screen);

        window.toggleCustomDate = () => {
            const val = document.getElementById('advPeriodSelect').value;
            document.getElementById('customDateSpan').style.display = (val === 'custom') ? 'inline-block' : 'none';
        };

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù (Drill-down)
        window.showEmpDrillDown = async (emp) => {
            const codes = window.currentStatsData[emp].contacted_parents_codes || [];
            if (codes.length === 0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.');

            // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙÙŠ parents)
            // Ù„ÙƒÙ† parents ØªØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰ employee, final_balance ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£ØµÙ„ÙŠ.
            // Ù†Ø­ØªØ§Ø¬ Ù„Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ø¢Ø¨Ø§Ø¡.
            
            const { data: fullParents, error } = await supabase.from('parents').select('*').in('parent_code', codes);
            
            if (error || !fullParents) return alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„');

            let html = `<table class="excel-preview-table"><thead><tr><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</th></tr></thead><tbody>`;
            fullParents.forEach((p, idx) => {
                html += `<tr><td>${idx+1}</td><td>${p.parent_name}</td><td>${p.phone}</td><td>${formatCurrency(p.final_balance)}</td><td>ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«</td></tr>`;
            });
            html += `</tbody></table>`;
            
            document.getElementById('drillDownTitle').innerText = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª: ${getEmployeeLabel(emp)}`;
            document.getElementById('drillDownContent').innerHTML = html;
            document.getElementById('statsDrillDownModal').style.display = 'flex';
            makeTableResizable(document.querySelector('#drillDownContent table'));
        };

        // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        window.renderAdvChartAndTable = () => {
            const stats = window.currentStatsData;
            const metric = document.getElementById('advMetricSelect').value;
            const type = document.getElementById('advTypeSelect').value;
            const ctx = document.getElementById('advMainChart').getContext('2d');
            
            if (window._advChart) window._advChart.destroy();

            const labels = Object.keys(stats).map(e => getEmployeeLabel(e));
            const data = Object.keys(stats).map(e => stats[e][metric]);
            
            const labelMap = {
                'parents': 'Ø¹Ø¯Ø¯ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±',
                'calls': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù…',
                'whatsapp': 'Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨',
                'logins': 'Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„',
                'debt': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©'
            };

            const bgColors = ['rgba(25, 118, 210, 0.7)', 'rgba(67, 160, 71, 0.7)', 'rgba(251, 192, 45, 0.7)', 'rgba(230, 74, 25, 0.7)', 'rgba(156, 39, 176, 0.7)', 'rgba(0, 172, 193, 0.7)'];
            const borderColors = ['rgba(25, 118, 210, 1)', 'rgba(67, 160, 71, 1)', 'rgba(251, 192, 45, 1)', 'rgba(230, 74, 25, 1)', 'rgba(156, 39, 176, 1)', 'rgba(0, 172, 193, 1)'];

            window._advChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelMap[metric],
                        data: data,
                        backgroundColor: type === 'line' ? bgColors[0] : bgColors,
                        borderColor: type === 'line' ? borderColors[0] : borderColors,
                        borderWidth: 1,
                        fill: type !== 'line',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type !== 'bar' && type !== 'line', position: 'bottom' },
                        title: { display: true, text: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨: ' + labelMap[metric], font: { size: 18 } }
                    },
                    scales: (type === 'bar' || type === 'line') ? { y: { beginAtZero: true } } : {}
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const tableHtml = `
                <table class="excel-preview-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th>Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ù…</th>
                            <th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                            <th>Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th>
                            <th>Ø¹Ø¯Ø¯ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(stats).map(emp => `
                            <tr style="cursor:pointer;" onclick="showEmpDrillDown('${emp}')" title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©">
                                <td style="color:#2979ff; text-decoration:underline;">${getEmployeeLabel(emp)}</td>
                                <td>${stats[emp].calls}</td>
                                <td>${stats[emp].logins}</td>
                                <td>${stats[emp].whatsapp}</td>
                                <td>${stats[emp].parents}</td>
                                <td>${formatCurrency(stats[emp].debt)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="text-align:center; font-size:12px; color:#666; margin-top:5px;">* Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡Ù… ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>
            `;
            document.getElementById('advStatsTableContainer').innerHTML = tableHtml;
            makeTableResizable(document.querySelector('#advStatsTableContainer table'));
        };

        // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
        window.filterAndRenderStats();

      } catch (e) { 
        alert('Ø®Ø·Ø£: ' + e.message); 
      } finally {
        const l = document.getElementById(loadingId);
        if(l) l.remove();
      }
    };

    window.openTargetStats = async () => {
      const loadingId = 'loading-target-' + Date.now();
      document.body.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="center-screen" style="z-index:9999"><div class="box"><h3>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</h3></div></div>`);

      try {
        const { data: parents, error: err1 } = await supabase.from('parents').select('parent_code, final_balance');
        const { data: interactions, error: err2 } = await supabase.from('interactions').select('parent_code, updated_at');

        if (err1 || err2) throw new Error((err1 || err2).message);

        const balanceMap = {};
        let totalSchoolDebt = 0;
        parents.forEach(p => {
            const val = cleanNumber(p.final_balance);
            balanceMap[p.parent_code] = val;
            totalSchoolDebt += val;
        });

        const html = `
            <div style="padding:10px; height:100%; overflow:auto;">
                <h2 style="text-align:center; color:#2979ff;">ğŸ¯ Ù†Ø³Ø¨Ø© ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</h2>
                <div style="text-align:center; font-size:20px; color:#d32f2f; margin-bottom:15px; font-weight:bold; background:#ffebee; padding:10px; border-radius:8px; display:inline-block;">
                    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø§Ù„ÙƒÙ„): ${totalSchoolDebt.toLocaleString('en-US')}
                </div>
                
                <div style="background:#f5f5f5; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:end;">
                    <div>
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">Ù†ÙˆØ¹ Ø§Ù„ÙØªØ±Ø©:</label>
                        <select id="targetPeriodType" onchange="toggleTargetDateInputs()" style="padding:8px; border-radius:5px; width:150px;">
                            <option value="month">Ø´Ù‡Ø±ÙŠ</option>
                            <option value="custom">Ù…Ø®ØµØµ</option>
                        </select>
                    </div>
                    <div id="targetMonthDiv">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">Ø§Ù„Ø´Ù‡Ø±:</label>
                        <input type="month" id="targetMonthInput" style="padding:8px; border-radius:5px;">
                    </div>
                    <div id="targetCustomDiv" style="display:none;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">Ù…Ù†:</label>
                        <input type="date" id="targetFromDate" style="padding:8px; border-radius:5px;">
                        <label style="display:inline-block; font-weight:bold; margin:0 5px;">Ø¥Ù„Ù‰:</label>
                        <input type="date" id="targetToDate" style="padding:8px; border-radius:5px;">
                    </div>
                    <button class="btn" onclick="calcTargetStats()" style="width:auto; height:42px; margin:0;">Ø¹Ø±Ø¶</button>
                </div>
                <div style="height:300px; margin-bottom:20px;"><canvas id="targetChart"></canvas></div>

                <div id="targetTableContainer"></div>

                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-secondary" onclick="document.getElementById('targetStatsScreen').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;

        const screen = document.createElement('div');
        screen.className = 'center-screen';
        screen.id = 'targetStatsScreen';
        screen.style.zIndex = 750;
        screen.innerHTML = `<div class="box box-large" style="max-width:700px;">${html}</div>`;
        document.body.appendChild(screen);

        const now = new Date();
        const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('targetMonthInput').value = monthStr;

        window.toggleTargetDateInputs = () => {
            const type = document.getElementById('targetPeriodType').value;
            document.getElementById('targetMonthDiv').style.display = type === 'month' ? 'block' : 'none';
            document.getElementById('targetCustomDiv').style.display = type === 'custom' ? 'block' : 'none';
        };

        window.calcTargetStats = () => {
            const type = document.getElementById('targetPeriodType').value;
            let startDate, endDate;

            if (type === 'month') {
                const mVal = document.getElementById('targetMonthInput').value;
                if (!mVal) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±');
                const [y, m] = mVal.split('-');
                startDate = new Date(y, m - 1, 1);
                endDate = new Date(y, m, 0, 23, 59, 59, 999);
            } else {
                const f = document.getElementById('targetFromDate').value;
                const t = document.getElementById('targetToDate').value;
                if (!f || !t) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† ÙˆØ¥Ù„Ù‰');
                startDate = new Date(f);
                endDate = new Date(t);
                endDate.setHours(23, 59, 59, 999);
            }

            const manualData = appConfig.manualTargetData || {};
            const dailyTotals = {};
            const dailyManual = {};
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                dailyTotals[key] = 0; // System
                dailyManual[key] = manualData[key] ? parseFloat(manualData[key]) : 0; // Manual
            }

            const relevantInteractions = window._targetRawData.interactions.filter(i => {
                if (!i.updated_at) return false;
                const d = new Date(i.updated_at);
                return d >= startDate && d <= endDate;
            });

            const dayGroups = {};
            relevantInteractions.forEach(i => {
                const d = new Date(i.updated_at);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (!dayGroups[key]) dayGroups[key] = new Set();
                dayGroups[key].add(i.parent_code);
            });

            Object.keys(dayGroups).forEach(key => {
                if (dailyTotals.hasOwnProperty(key)) {
                    let sum = 0;
                    dayGroups[key].forEach(code => { sum += (window._targetRawData.balanceMap[code] || 0); });
                    dailyTotals[key] = sum;
                }
            });

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„ÙØªØ±Ø© (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„Ø£ÙŠØ§Ù…)
            const periodUniqueParents = new Set();
            relevantInteractions.forEach(i => periodUniqueParents.add(i.parent_code));
            
            let totalPeriodSum = 0;
            periodUniqueParents.forEach(code => {
                totalPeriodSum += (window._targetRawData.balanceMap[code] || 0);
            });

            // Calculate Manual Total
            let totalManualSum = 0;
            Object.keys(dailyManual).forEach(k => totalManualSum += dailyManual[k]);

            let tableHtml = `<table class="excel-preview-table"><thead><tr><th style="background:#e0f7fa;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th style="background:#e0f7fa;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª (Ù†Ø¸Ø§Ù…)</th><th style="background:#fff9c4;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª (ÙŠØ¯ÙˆÙŠ)</th></tr></thead><tbody>`;
            
            const chartLabels = [];
            const chartDataSys = [];
            const chartDataMan = [];

            Object.keys(dailyTotals).sort().forEach(dateStr => {
                const val = dailyTotals[dateStr];
                const manVal = dailyManual[dateStr];
                chartLabels.push(dateStr);
                chartDataSys.push(val);
                chartDataMan.push(manVal);
                tableHtml += `<tr>
                    <td>${dateStr}</td>
                    <td>${val.toLocaleString('en-US')}</td>
                    <td contenteditable="true" onblur="saveManualTarget('${dateStr}', this)" onfocus="this.innerText = cleanNumber(this.innerText)" style="background:#fffde7; font-weight:bold;">${manVal.toLocaleString('en-US')}</td>
                </tr>`;
            });


            tableHtml += `
                <tr style="background:#eee; font-weight:bold;"><td style="white-space:nowrap;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td><td>${totalPeriodSum.toLocaleString('en-US')}</td><td>${totalManualSum.toLocaleString('en-US')}</td></tr>
                <tr style="background:#fff;"><td style="white-space:nowrap;">Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</td><td colspan="2"><input type="text" id="targetInput" oninput="formatInputCurrency(this); updateTargetRatio(${totalPeriodSum}, ${totalManualSum})" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù" style="width:100%; box-sizing:border-box; font-size:16px; padding:5px; text-align:center;"></td></tr>
                <tr style="background:#b9f6ca; font-weight:bold; font-size:18px;"><td style="white-space:nowrap;">Ù†Ø³Ø¨Ø© ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</td><td id="sysRatioDisplay">0%</td><td id="manRatioDisplay">0%</td></tr>
            </tbody></table>`;

            document.getElementById('targetTableContainer').innerHTML = tableHtml;
            makeTableResizable(document.querySelector('#targetTableContainer table'));

            // Chart
            const ctx = document.getElementById('targetChart').getContext('2d');
            if(window._targetChart) window._targetChart.destroy();
            window._targetChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        { label: 'Ù†Ø¸Ø§Ù…', data: chartDataSys, backgroundColor: '#29b6f6' },
                        { label: 'ÙŠØ¯ÙˆÙŠ', data: chartDataMan, backgroundColor: '#ffa726' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        };

        window.formatInputCurrency = (input) => {
            let val = input.value.replace(/[^0-9.]/g, '');
            if(val) {
                const parts = val.split('.');
                if (parts[0] !== "") {
                    parts[0] = parseInt(parts[0]).toLocaleString('en-US');
                }
                input.value = parts.join('.');
            } else {
                input.value = '';
            }
        };

        window.updateTargetRatio = (sysTotal, manTotal) => {
            const target = cleanNumber(document.getElementById('targetInput').value);
            const sysDisplay = document.getElementById('sysRatioDisplay');
            const manDisplay = document.getElementById('manRatioDisplay');
            if (!target || target === 0) { sysDisplay.innerText = "---"; manDisplay.innerText = "---"; return; }
            
            const sysRatio = (sysTotal / target) * 100;
            const manRatio = (manTotal / target) * 100;
            
            sysDisplay.innerText = sysRatio.toFixed(2) + '%';
            manDisplay.innerText = manRatio.toFixed(2) + '%';
            
            sysDisplay.style.color = sysRatio >= 100 ? 'green' : (sysRatio >= 50 ? 'orange' : 'red');
            manDisplay.style.color = manRatio >= 100 ? 'green' : (manRatio >= 50 ? 'orange' : 'red');
        };

        window.saveManualTarget = async (date, cell) => {
            const val = cleanNumber(cell.innerText);
            if(!appConfig.manualTargetData) appConfig.manualTargetData = {};
            appConfig.manualTargetData[date] = val;
            await saveConfigToDB();
            calcTargetStats(); // Refresh totals
        };

        window._targetRawData = { interactions, balanceMap };
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        calcTargetStats();

      } catch (e) { alert('Error: ' + e.message); } finally { document.getElementById(loadingId)?.remove(); }
    };

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
    window.updateImportSelect = () => {
        const select = document.getElementById('importEmpSelect');
        if(!select) return;
        select.innerHTML = '<option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>';
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        Object.keys(appConfig.employeeNames || {}).forEach(key => {
            select.innerHTML += `<option value="${key}">ğŸ‘¤ ${appConfig.employeeNames[key]}</option>`;
        });
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        Object.keys(appConfig.stages || {}).forEach(key => {
            select.innerHTML += `<option value="${key}">ğŸ« ${appConfig.stages[key].name}</option>`;
        });
        select.innerHTML += '<option value="global_update">Ø§Ù„Ù„ØµÙ‚ Ù‡Ù†Ø§ (ØªØ­Ø¯ÙŠØ« Ø´Ø§Ù…Ù„)</option>';
    };

    window.togglePasteArea = () => {
      const area = document.getElementById('excelPasteArea');
      area.style.display = area.style.display === 'none' ? 'block' : 'none';
      if (area.style.display === 'block') area.focus();
    };

    window.clearPasteAreaAndGrid = () => {
        document.getElementById('excelPasteArea').value = '';
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Ø§Ø®ØªØ± "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ø£Ùˆ "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡</p>';
        const stats = document.getElementById('globalUpdateStats');
        if(stats) {
            stats.style.display = 'none';
            document.getElementById('updateCount').innerText = '0';
            document.getElementById('ignoreCount').innerText = '0';
        }
    };

    window.deleteEmployeeDataDB = async () => {
      const emp = document.getElementById('importEmpSelect').value;
      const empName = getEmployeeLabel(emp);
      
      if (emp === 'global_update') {
        return alert('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ù…Ù„.');
      }

      if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ (${empName}) Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) return;

      const { error } = await supabase.from('parents').delete().eq('employee', emp);

      if (error) {
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message);
      } else {
        alert(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª ${empName} Ø¨Ù†Ø¬Ø§Ø­.`);
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:red;">ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
        document.getElementById('excelPasteArea').value = '';
      }
    };

    window.loadDataToGrid = async () => {
      const emp = document.getElementById('importEmpSelect').value;
      if (!emp) {
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>';
        return;
      }
      
      if (emp === 'global_update') {
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©...</p>';
        const { data, error } = await supabase.from('parents').select('parent_code');
        if (error) { alert('Ø®Ø·Ø£: ' + error.message); return; }
        window.existingParentsMap = new Set(data.map(p => p.parent_code));
        
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:#2979ff; font-weight:bold;">âœ¨ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ù…Ù„ âœ¨<br>Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§. <span style="color:red; background:#ffebee; padding:2px 5px; border-radius:4px;">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡</span> ØªØ¹Ù†ÙŠ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯ ØºÙŠØ± Ù…Ø³Ø¬Ù„ÙŠÙ† (Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸Ù‡Ù…).</p>';
        document.getElementById('excelPasteArea').style.display = 'block';
        document.getElementById('excelPasteArea').value = '';
        document.getElementById('excelPasteArea').focus();
        if(document.getElementById('globalUpdateStats')) document.getElementById('globalUpdateStats').style.display = 'none';
        return;
      }

      document.getElementById('excelPasteArea').value = '';
      document.getElementById('gridContainer').innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

      const { data, error } = await supabase.from("parents").select("*").eq("employee", emp).order("serial_no");

      if (error) {
        console.error('Error loading data:', error);
        document.getElementById('gridContainer').innerHTML = `<p style="text-align:center; color:red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${error.message}</p>`;
        return;
      }
      renderGrid(data);
      document.getElementById('excelPasteArea').style.display = 'none';
    };

    window.convertPasteToGrid = () => {
      const text = document.getElementById('excelPasteArea').value;
      const rows = text.split("\n");
      const data = [];

      rows.forEach(row => {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹
        if (!row || !row.trim()) return;
        
        // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø®Ù„Ø§ÙŠØ§ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø© Ù…Ù† ÙƒÙ„ Ø®Ù„ÙŠØ©
        let c = row.split("\t").map(cell => cell ? cell.trim() : "");

        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ÙƒÙˆØ¯ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ÙÙ‚ÙˆØ¯ (Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©)
        if (!c[0] || isNaN(parseInt(c[0])) || !c[1]) return;

        data.push({
          serial_no: c[0],
          student_code: (c[1] || '').trim() || null,
          student_name: c[2] || "",
          parent_code: c[3] || "",
          parent_name: c[4] || "",
          identity_no: c[5] || "",
          phone: c[6] || "",
          carried_balance: cleanNumber(c[7]),
          term1_balance: cleanNumber(c[8]),
          term2_balance: cleanNumber(c[9]),
          final_balance: cleanNumber(c[10])
        });
      });
      
      const isGlobal = document.getElementById('importEmpSelect').value === 'global_update';
      let updateCount = 0;
      let ignoreCount = 0;

      if (isGlobal && window.existingParentsMap) {
        data.forEach(r => {
            const exists = window.existingParentsMap.has(r.parent_code);
            r.is_unassigned = !exists;
            if (exists) updateCount++; else ignoreCount++;
        });
        data.sort((a, b) => (a.is_unassigned === b.is_unassigned) ? 0 : a.is_unassigned ? -1 : 1);
        
        const stats = document.getElementById('globalUpdateStats');
        if(stats) { stats.style.display = 'block'; document.getElementById('updateCount').innerText = updateCount; document.getElementById('ignoreCount').innerText = ignoreCount; }
      } else {
        const stats = document.getElementById('globalUpdateStats');
        if(stats) stats.style.display = 'none';
      }
      renderGrid(data);
    };

    function renderGrid(data) {
      if (!data || data.length === 0) {
        document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>';
        return;
      }

      let html = `<table class="excel-preview-table">
      ${document.getElementById('importEmpSelect').value === 'global_update' ? '<caption style="caption-side:top; text-align:center; color:red; font-size:12px;">* Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ = ØºÙŠØ± Ù…Ø³Ù†Ø¯Ø© Ù„Ù…ÙˆØ¸Ù (Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰)</caption>' : ''}
      <thead>
        <tr>
          <th>Ø­Ø°Ù</th><th>Ù…</th><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th><th>Ø§Ø³Ù… Ø§Ù„ÙˆÙ„ÙŠ</th><th>Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
          <th>Ø§Ù„Ù…Ø¯ÙˆØ±</th><th>Ù1</th><th>Ù2</th><th>Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
        </tr>
      </thead><tbody>`;

      const isGlobal = document.getElementById('importEmpSelect').value === 'global_update';

      data.forEach((row, index) => {
        let trStyle = "";
        if (isGlobal && row.is_unassigned) trStyle = "background-color: #ffcdd2; border: 2px solid #e57373;";
        
        html += `<tr style="${trStyle}">
        <td><button onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;cursor:pointer;">âœ–</button></td>
        <td contenteditable="true">${row.serial_no || ''}</td>
        <td contenteditable="true">${row.student_code || ''}</td>
        <td contenteditable="true">${row.student_name || ''}</td>
        <td contenteditable="true">${row.parent_code || ''}</td>
        <td contenteditable="true">${row.parent_name || ''}</td>
        <td contenteditable="true">${row.identity_no || ''}</td>
        <td contenteditable="true">${row.phone || ''}</td>
        <td contenteditable="true">${(row.carried_balance || 0).toLocaleString('en-US')}</td>
        <td contenteditable="true">${(row.term1_balance || 0).toLocaleString('en-US')}</td>
        <td contenteditable="true">${(row.term2_balance || 0).toLocaleString('en-US')}</td>
        <td contenteditable="true" style="font-weight:bold;">${(row.final_balance || 0).toLocaleString('en-US')}</td>
      </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('gridContainer').innerHTML = html;
      makeTableResizable(document.querySelector('#gridContainer table'));
    }

    window.searchGlobalDB = async () => {
      const col = document.getElementById('globalSearchCol').value;
      const query = document.getElementById('globalSearchInput').value.trim();
      const isExact = document.getElementById('globalSearchExact').checked;
      const container = document.getElementById('globalSearchResults');

      if (!query) {
        container.innerHTML = '<p style="text-align:center; color:#666; padding:10px;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„Ø¨Ø­Ø«</p>';
        return;
      }

      container.innerHTML = '<p style="text-align:center; padding:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';

      try {
        let queryBuilder = supabase.from('parents').select('*');

        if (isExact) {
            queryBuilder = queryBuilder.eq(col, query);
        } else {
            queryBuilder = queryBuilder.ilike(col, `%${query}%`);
        }

        const { data, error } = await queryBuilder.limit(50);

        if (error) throw error;

        if (!data || data.length === 0) {
          container.innerHTML = '<p style="text-align:center; color:#d32f2f; padding:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</p>';
          return;
        }

        let html = `<table class="excel-preview-table">
          <thead>
            <tr>
              <th style="background:#e1bee7;">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
              <th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th>
              <th>Ø§Ø³Ù… Ø§Ù„ÙˆÙ„ÙŠ</th>
              <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
              <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
            </tr>
          </thead>
          <tbody>`;

        // Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© "ØºÙŠØ± Ù…Ø³Ù†Ø¯" Ø¹Ù†Ø¯ ØªÙƒØ±Ø§Ø± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
        // Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© ØªØ±Ø¨Ø· ÙƒÙˆØ¯ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„Ù…ÙˆØ¸Ù Ø¥Ø°Ø§ ÙˆØ¬Ø¯ ÙÙŠ Ø£ÙŠ ØµÙ
        const parentEmpMap = {};
        data.forEach(r => {
            if (r.parent_code && r.employee) {
                parentEmpMap[r.parent_code] = r.employee;
            }
        });

        data.forEach(row => {
          // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØŒ Ø£Ùˆ Ù†Ø¨Ø­Ø« Ø¹Ù†Ù‡ ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
          const effectiveEmp = row.employee || parentEmpMap[row.parent_code];
          html += `<tr>
            <td style="font-weight:bold; color:#4a148c;">${getEmployeeLabel(effectiveEmp) || 'ØºÙŠØ± Ù…Ø³Ù†Ø¯'}</td>
            <td>${row.student_code || '-'}</td>
            <td>${row.student_name || '-'}</td>
            <td>${row.parent_code || '-'}</td>
            <td>${row.parent_name || '-'}</td>
            <td>${row.phone || '-'}</td>
            <td>${(row.final_balance || 0).toLocaleString('en-US')}</td>
          </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;

      } catch (e) {
        console.error(e);
        container.innerHTML = `<p style="text-align:center; color:red; padding:10px;">Ø®Ø·Ø£: ${e.message}</p>`;
      }
    };

    window.exportToExcel = () => {
      const data = window.currentFilteredData || window.currentEmployeeData;
      if (!data || data.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");

      const exportData = data.map(row => ({
        "Ù…": row.serial_no,
        "Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨": row.student_code,
        "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨": row.student_name,
        "Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ": row.parent_code,
        "Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±": row.parent_name,
        "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©": row.identity_no,
        "Ø§Ù„Ø¬ÙˆØ§Ù„": row.phone,
        "ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„": row.updated_at ? new Date(row.updated_at).toLocaleDateString('en-GB') : '',
        "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…": row.next_call_date || '',
        "Ø§Ù„Ù…ÙˆØ¸Ù": row.employee ? getEmployeeLabel(row.employee) : '',
        "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±": row.carried_balance,
        "Ø±ØµÙŠØ¯ Ù1": row.term1_balance,
        "Ø±ØµÙŠØ¯ Ù2": row.term2_balance,
        "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ": row.final_balance,
        "Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª": row.call_count || 0,
        "Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø§ØªØµØ§Ù„": row.last_call_status || '',
        "Ù…Ù„Ø§Ø­Ø¸Ø§Øª": row.notes || ''
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Parents");
      XLSX.writeFile(wb, "Parents_Data.xlsx");
    };

    window.saveSettingsAndData = async (shouldClose, btnElement) => {
      // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø£Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙŠØ¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙŠÙÙ‚Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
      const currentSelectedEmp = document.getElementById('importEmpSelect').value;

      // 1. Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ø²Ø¹Ø§Ø¬)
      await saveAppSettings(true);
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯
      if (currentSelectedEmp) {
        const sel = document.getElementById('importEmpSelect');
        if (sel) sel.value = currentSelectedEmp;
      }

      // 2. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const emp = currentSelectedEmp;
      const table = document.querySelector('#gridContainer table tbody');

      if (emp === 'global_update') {
        if (!table || table.querySelectorAll('tr').length === 0) {
          alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹.');
          return;
        }
        if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\nØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙ‚Ø·ØŒ ÙˆØ³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø¯Ø¯ (Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡).')) return;
        
        if (btnElement) btnElement.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
        
        const rows = table.querySelectorAll('tr');
        const pastedData = [];
        rows.forEach(tr => {
          const cells = tr.querySelectorAll('td');
          if (cells.length > 1) {
            pastedData.push({
              serial_no: parseInt(cells[1].innerText) || 0,
              student_code: cells[2].innerText.trim() || null,
              student_name: cells[3].innerText.trim(),
              parent_code: cells[4].innerText.trim(),
              parent_name: cells[5].innerText.trim(),
              identity_no: cells[6].innerText.trim(),
              phone: cells[7].innerText.trim(),
              carried_balance: cleanNumber(cells[8].innerText),
              term1_balance: cleanNumber(cells[9].innerText),
              term2_balance: cleanNumber(cells[10].innerText),
              final_balance: cleanNumber(cells[11].innerText)
            });
          }
        });

        try {
          const { data: existingParents, error: fetchError } = await supabase.from('parents').select('id, parent_code, student_code, student_name, employee');
          if (fetchError) throw fetchError;
          
          const studentMap = new Map();
          const parentMap = new Map();
          
          existingParents.forEach(p => { 
             if(p.student_code) studentMap.set(p.student_code, p);
             if(p.parent_code) {
                 if(!parentMap.has(p.parent_code)) parentMap.set(p.parent_code, []);
                 parentMap.get(p.parent_code).push(p);
             }
          });
          
          const updates = [];
          const usedIds = new Set();

          pastedData.forEach(row => {
            let existing = null;
            
            // 1. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ù„Ø£Ø¯Ù‚)
            if (row.student_code && studentMap.has(row.student_code)) {
                existing = studentMap.get(row.student_code);
            }
            // 2. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± + Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠÙ‡Ø§ Ø±Ù‚Ù… Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©)
            else if (row.parent_code && parentMap.has(row.parent_code)) {
                const candidates = parentMap.get(row.parent_code);
                if (row.student_name) {
                    const nameMatch = candidates.find(c => c.student_name === row.student_name);
                    if (nameMatch) existing = nameMatch;
                }
                // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¨Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ÙÙ‚Ø· Ù„Ù…Ù†Ø¹ Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø´Ù‚Ø§Ø¡ Ø¨Ø§Ù„Ø®Ø·Ø£
            }

            if (existing) {
              // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ« Ù†ÙØ³ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø±ØªÙŠÙ† (Ù„Ù…Ù†Ø¹ Ø®Ø·Ø£ ON CONFLICT)
              if (!usedIds.has(existing.id)) {
                updates.push({ id: existing.id, employee: existing.employee, ...row });
                usedIds.add(existing.id);
              }
            }
          });


          if (updates.length === 0) {
            alert('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©.');
            if (btnElement) btnElement.innerText = "Ø­ÙØ¸ (Ø¨Ø¯ÙˆÙ† Ø¥ØºÙ„Ø§Ù‚)";
            return;
          }

          const { error: updateError } = await supabase.from('parents').upsert(updates);
          if (updateError) throw updateError;

          alert(`âœ… ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${updates.length} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.`);
          if (shouldClose) closeSettings();
          else if (btnElement) { btnElement.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…"; setTimeout(() => btnElement.innerText = "ğŸ’¾ Ø­ÙØ¸ (Ø¨Ø¯ÙˆÙ† Ø¥ØºÙ„Ø§Ù‚)", 2000); }
        } catch (e) { alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message); if (btnElement) btnElement.innerText = "Ø­ÙØ¸ (Ø¨Ø¯ÙˆÙ† Ø¥ØºÙ„Ø§Ù‚)"; }
        return;
      }

      // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const newRecords = [];
      if (table && table.querySelectorAll('tr').length > 0) {
        // Ù…ØµÙÙˆÙØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù Ù†ÙØ³Ù‡
        const studentCodesCheck = new Set();
        const duplicates = [];

        const rows = table.querySelectorAll('tr');
        rows.forEach(tr => {
          const cells = tr.querySelectorAll('td');
          if (cells.length > 1) {
            newRecords.push({
              employee: emp,
              serial_no: parseInt(cells[1].innerText) || 0,
              // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ù…Ø®ÙÙŠØ© ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù€ null Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹
              student_code: (cells[2].innerText || '').replace(/\u00a0/g, ' ').trim() || null,
              student_name: (cells[3].innerText || '').trim(),
              parent_code: (cells[4].innerText || '').trim(),
              parent_name: (cells[5].innerText || '').trim(),
              identity_no: (cells[6].innerText || '').trim(),
              phone: (cells[7].innerText || '').trim(),
              carried_balance: cleanNumber(cells[8].innerText),
              term1_balance: cleanNumber(cells[9].innerText),
              term2_balance: cleanNumber(cells[10].innerText),
              final_balance: cleanNumber(cells[11].innerText)
            });

            // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const sCode = newRecords[newRecords.length - 1].student_code;
            if (sCode) {
              if (studentCodesCheck.has(sCode)) {
                duplicates.push(sCode);
              } else {
                studentCodesCheck.add(sCode);
              }
            }
          }
        });

        if (duplicates.length > 0) {
          alert(`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø± ÙÙŠ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ (Student Code) ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªØ­Ø§ÙˆÙ„ Ø­ÙØ¸Ù‡Ø§!\n\nØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙƒØ±Ø±Ø©: ${duplicates.join(', ')}\n\nÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ø±Ù‚Ù… Ù…Ù…ÙŠØ². Ù„Ù„Ø£Ø®ÙˆØ©ØŒ Ø§ØªØ±Ùƒ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙØ§Ø±ØºØ§Ù‹ Ø£Ùˆ Ø¶Ø¹ Ø±Ù‚Ù…Ø§Ù‹ Ù…Ø®ØªÙ„ÙØ§Ù‹ Ù„ÙƒÙ„ Ø£Ø®.`);
          if (btnElement) {
            btnElement.innerText = "Ø­ÙØ¸ (Ø¨Ø¯ÙˆÙ† Ø¥ØºÙ„Ø§Ù‚)";
            btnElement.style.background = "";
          }
          return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­ÙØ¸
        }
      }

      // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      const { error: delError } = await supabase.from('parents').delete().eq('employee', emp);

      if (delError) {
        console.error(delError);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ' + delError.message);
        return;
      }

      // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      if (newRecords.length > 0) {
        const { error: insError } = await supabase.from('parents').insert(newRecords);
        if (insError) {
          console.error(insError);
          alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ' + insError.message);
          return;
        }
      }

      if (shouldClose) {
        closeSettings();
      } else {
        if (btnElement) {
          const originalText = btnElement.innerText;
          const originalBg = btnElement.style.background;
          btnElement.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…";
          btnElement.style.background = "#4caf50";
          setTimeout(() => {
            btnElement.innerText = originalText;
            btnElement.style.background = originalBg;
          }, 1500);
        }
        await loadDataToGrid();
      }
    };

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù†
    window.openAdminPanel = () => {
      const pass = prompt("ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
      if (pass === "admin123") {
        document.getElementById("adminScreen").style.display = "flex";
        loadAdminData();
      } else if (pass !== null) {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");
      }
    };

    window.closeAdminPanel = () => {
      document.getElementById("adminScreen").style.display = "none";
    };

    window.loadAdminData = async () => {
      const textarea = document.getElementById("adminDataInput");
      textarea.value = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

      const { data, error } = await supabase
        .from("parents")
        .select("*")
        .order("employee")
        .order("serial_no");

      if (error) {
        textarea.value = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + error.message;
        console.error(error);
        return;
      }

      let text = "Ø§Ù„Ù…ÙˆØ¸Ù\tÙ…\tØ±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨\tØ§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨\tØ±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±\tØ§Ù„Ø§Ø³Ù…\tØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©\tØ§Ù„Ø¬ÙˆØ§Ù„\tØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±\tØ±ØµÙŠØ¯ Ù1\tØ±ØµÙŠØ¯ Ù2\tØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ\n";

      data.forEach(row => {
        text += `${row.employee || ''}\t${row.serial_no || ''}\t${row.student_code || ''}\t${row.student_name || ''}\t${row.parent_code || ''}\t${row.parent_name || ''}\t${row.identity_no || ''}\t${row.phone || ''}\t${row.carried_balance || 0}\t${row.term1_balance || 0}\t${row.term2_balance || 0}\t${row.final_balance || 0}\n`;
      });

      textarea.value = text;
    };

    window.saveAdminDataFull = async () => {
      if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹!")) return;

      const rawText = document.getElementById("adminDataInput").value;
      const rows = rawText.split("\n");
      const newRecords = [];

      const parseNum = (str) => {
        return cleanNumber(str);
      };

      for (let i = 0; i < rows.length; i++) {
        const line = rows[i].trim();
        if (!line) continue;

        const cols = line.split("\t");
        if (isNaN(parseInt(cols[1]))) continue;

        newRecords.push({
          employee: cols[0]?.trim() || 'emp1',
          serial_no: parseInt(cols[1]) || 0,
          student_code: (cols[2] || '').trim() || null,
          student_name: (cols[3] || '').trim(),
          parent_code: cols[4] || "",
          parent_name: cols[5] || "",
          identity_no: cols[6] || "",
          phone: cols[7] || "",
          carried_balance: parseNum(cols[8]),
          term1_balance: parseNum(cols[9]),
          term2_balance: parseNum(cols[10]),
          final_balance: parseNum(cols[11])
        });
      }

      const { error: delError } = await supabase.from("parents").delete().neq('id', -1);

      if (delError) {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©! Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£Ù„ØºÙŠØª.");
        console.error(delError);
        return;
      }

      if (newRecords.length > 0) {
        const { error: insError } = await supabase.from("parents").insert(newRecords);
        if (insError) {
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!");
          console.error(insError);
        } else {
          alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! (${newRecords.length} Ø³Ø¬Ù„) âœ…`);
          closeAdminPanel();
        }
      } else {
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ§Ø±Øº).");
        closeAdminPanel();
      }
    };

    window.openDebtStats = async () => {
      const loadingId = 'loading-debt-' + Date.now();
      document.body.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="center-screen" style="z-index:9999"><div class="box"><h3>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©...</h3></div></div>`);

      try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data: parents, error: err1 } = await supabase.from('parents').select('employee, final_balance, parent_code, updated_at');
        // Ù†Ø­ØªØ§Ø¬ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ù„Ù…Ø¹Ø±ÙØ© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¢Ø¨Ø§Ø¡
        const { data: interactions, error: err2 } = await supabase.from('interactions').select('parent_code, updated_at, employee');

        if (err1 || err2) throw new Error((err1 || err2).message);

        // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù†Ø³ØªØ®Ø¯Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„ØªØ­Ø¯ÙŠØ¯ "Ù…ØªÙ‰" ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ù†Ø´Ø·Ø©/ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ù…Ù„Ùƒ Ø¬Ø¯ÙˆÙ„ ØªØ§Ø±ÙŠØ®ÙŠØŒ Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¢Ø®Ø± ØªÙØ§Ø¹Ù„
        
        // Ø®Ø±ÙŠØ·Ø© Ù„Ø±Ø¨Ø· Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const balanceMap = {};
        parents.forEach(p => balanceMap[p.parent_code] = cleanNumber(p.final_balance));

        const html = `
            <div style="padding:10px; height:100%; overflow:auto;">
                <h2 style="text-align:center; color:#2979ff;">ğŸ’° ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Line Chart)</h2>
                <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px; background:#f5f5f5; padding:15px; border-radius:10px; flex-wrap:wrap;">
                    <div>
                        <label style="font-weight:bold;">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø±Ø¶:</label>
                        <select id="debtRangeSelect" onchange="renderDebtChart()" style="padding:8px; border-radius:5px;">
                            <option value="daily">ÙŠÙˆÙ…ÙŠ (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…)</option>
                            <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø¢Ø®Ø± 12 Ø£Ø³Ø¨ÙˆØ¹)</option>
                            <option value="monthly">Ø´Ù‡Ø±ÙŠ (Ø¢Ø®Ø± 12 Ø´Ù‡Ø±)</option>
                            <option value="custom">Ù…Ø®ØµØµ</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight:bold;">Ø§Ù„Ù…Ø¹ÙŠØ§Ø±:</label>
                        <select id="debtMetricSelect" onchange="renderDebtChart()" style="padding:8px; border-radius:5px;">
                            <option value="debt">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</option>
                            <option value="paid">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„ÙØ±Ù‚ Ø¹Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight:bold;">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø·Ø·:</label>
                        <select id="debtChartType" onchange="renderDebtChart()" style="padding:8px; border-radius:5px;">
                            <option value="line">Ø®Ø·ÙŠ (Line)</option>
                            <option value="bar">Ø£Ø¹Ù…Ø¯Ø© (Bar)</option>
                            <option value="pie">Ø¯Ø§Ø¦Ø±ÙŠ (Pie)</option>
                            <option value="doughnut">Ø¯ÙˆÙ†Ø§Øª (Doughnut)</option>
                            <option value="polarArea">Ù‚Ø·Ø¨ÙŠ (Polar Area)</option>
                            <option value="radar">Ø±Ø§Ø¯Ø§Ø± (Radar)</option>
                        </select>
                    </div>
                    <div id="debtCustomDateDiv" style="display:none;">
                        <label>Ù…Ù†:</label><input type="date" id="debtFromDate" onchange="renderDebtChart()">
                        <label>Ø¥Ù„Ù‰:</label><input type="date" id="debtToDate" onchange="renderDebtChart()">
                    </div>
                    <button class="btn" onclick="openDailyCollectionStats()" style="width:auto; height:38px; margin-top:25px; background:#43a047; color:white;">ğŸ’µ ØªØ­ØµÙŠÙ„ ÙŠÙˆÙ…ÙŠ ØªÙØµÙŠÙ„ÙŠ</button>
                </div>
                <div style="background:#fff; padding:10px; border-radius:10px; border:1px solid #eee; height:500px;"><canvas id="debtChartCanvas"></canvas></div>
                <div id="debtTableContainer" style="margin-top:20px;"></div>
                <div style="text-align:center; margin-top:20px;"><button class="btn btn-secondary" onclick="document.getElementById('debtStatsScreen').remove()">Ø¥ØºÙ„Ø§Ù‚</button></div>
            </div>
        `;

        const screen = document.createElement('div');
        screen.className = 'center-screen';
        screen.id = 'debtStatsScreen';
        screen.style.zIndex = 700;
        screen.innerHTML = `<div class="box box-large" style="max-width:800px;">${html}</div>`;
        document.body.appendChild(screen);

        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        window._debtRawData = { parents, interactions, balanceMap };

        window.renderDebtChart = () => {
            const range = document.getElementById('debtRangeSelect').value;
            const metric = document.getElementById('debtMetricSelect').value;
            const chartType = document.getElementById('debtChartType').value;
            document.getElementById('debtCustomDateDiv').style.display = (range === 'custom') ? 'block' : 'none';

            const ctx = document.getElementById('debtChartCanvas').getContext('2d');
            if (window._debtChartInstance) window._debtChartInstance.destroy();

            // ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©
            let startDate = new Date();
            let endDate = new Date();
            endDate.setHours(23, 59, 59, 999);

            if (range === 'daily') startDate.setDate(startDate.getDate() - 30);
            else if (range === 'weekly') startDate.setDate(startDate.getDate() - (7 * 12));
            else if (range === 'monthly') startDate.setMonth(startDate.getMonth() - 12);
            else if (range === 'custom') {
                const f = document.getElementById('debtFromDate').value;
                const t = document.getElementById('debtToDate').value;
                if(f) startDate = new Date(f);
                if(t) endDate = new Date(t);
            }
            startDate.setHours(0,0,0,0);

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…ÙˆØ¸Ù
            // Ø§Ù„Ù‡ÙŠÙƒÙ„: { "YYYY-MM-DD": { "emp1": 1000, "emp2": 500 } }
            const timeSeries = {};
            const timeSeriesSets = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„ÙØ±ÙŠØ¯ÙŠÙ† Ù„ÙƒÙ„ ÙØªØ±Ø©
            const employees = [...Object.keys(appConfig.employeeNames || {}), ...Object.keys(appConfig.stages || {})];
            
            // Ø¯Ù…Ø¬ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ÙˆØ§Ù„Ø¢Ø¨Ø§Ø¡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«
            // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ù„Ø£Ù†Ù‡Ø§ Ø£Ø¯Ù‚ ØªØ§Ø±ÙŠØ®ÙŠØ§Ù‹ØŒ ÙˆÙ†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ù„Ù„Ø±ØµÙŠØ¯
            const allPoints = [...window._debtRawData.interactions];
            // Ù†Ø¶ÙŠÙ Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… ØªÙØ§Ø¹Ù„Ø§Øª (Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ updated_at ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¢Ø¨Ø§Ø¡)
            window._debtRawData.parents.forEach(p => {
                if(p.updated_at) allPoints.push({ parent_code: p.parent_code, updated_at: p.updated_at, employee: p.employee });
            });

            allPoints.forEach(point => {
                if (!point.updated_at) return;
                const d = new Date(point.updated_at);
                if (d < startDate || d > endDate) return;

                // Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (ÙŠÙˆÙ…/Ø£Ø³Ø¨ÙˆØ¹/Ø´Ù‡Ø±)
                let key = "";
                if (range === 'monthly') key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}`;
                else if (range === 'weekly') {
                    const firstDay = new Date(d);
                    firstDay.setDate(d.getDate() - d.getDay()); // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
                    key = `${firstDay.getFullYear()}-${String(firstDay.getMonth()+1).padStart(2, '0')}-${String(firstDay.getDate()).padStart(2, '0')}`;
                } else {
                    key = d.toISOString().split('T')[0];
                }

                if (!timeSeriesSets[key]) timeSeriesSets[key] = {};
                employees.forEach(e => { if(!timeSeriesSets[key][e]) timeSeriesSets[key][e] = new Set(); });

                const emp = point.employee || 'emp1';
                
                // Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¬Ù…Ø¹ Ù„Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©
                if (timeSeriesSets[key][emp]) {
                    timeSeriesSets[key][emp].add(point.parent_code);
                }
            });

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
            Object.keys(timeSeriesSets).forEach(key => {
                timeSeries[key] = {};
                employees.forEach(emp => {
                    let sum = 0;
                    if (timeSeriesSets[key][emp]) {
                        timeSeriesSets[key][emp].forEach(code => {
                            sum += (window._debtRawData.balanceMap[code] || 0);
                        });
                    }
                    timeSeries[key][emp] = sum;
                });
            });

            // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø®Ø·Ø·
            const sortedKeys = Object.keys(timeSeries).sort();
            const datasets = employees.map((emp, idx) => {
                const colors = ['#ef5350', '#ab47bc', '#5c6bc0', '#26a69a', '#ffa726', '#8d6e63'];
                let data = sortedKeys.map(k => timeSeries[k][emp]);

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„ÙØ±Ù‚) Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡
                if (metric === 'paid') {
                    const paidData = [];
                    for (let i = 0; i < data.length; i++) {
                        if (i === 0) paidData.push(0); // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¨Ù‚
                        else paidData.push(data[i-1] - data[i]);
                    }
                    data = paidData;
                }

                return {
                    label: getEmployeeLabel(emp) + (metric === 'paid' ? ' (Ø§Ù„Ù…Ø¯ÙÙˆØ¹)' : ''),
                    data: data,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length],
                    borderWidth: 2,
                    tension: 0.3, // Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø· Ù…Ù†Ø­Ù†ÙŠØ§Ù‹ Ù‚Ù„ÙŠÙ„Ø§Ù‹
                    fill: chartType !== 'line' // Ù…Ù„Ø¡ Ø§Ù„Ù„ÙˆÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø®Ø·ÙŠØ§Ù‹
                };
            });

            window._debtChartInstance = new Chart(ctx, {
                type: chartType,
                data: { labels: sortedKeys, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: metric === 'paid' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„ÙØ±Ù‚ Ø¹Ù† Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚)' : 'ØªØ·ÙˆØ± Ø­Ø¬Ù… Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†', font: { size: 18 } },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${Number(ctx.raw).toLocaleString('en-US')}` } }
                    },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© (Ø±ÙŠØ§Ù„)' } } }
                }
            });

            // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ (Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© + Ù…Ø¯ÙÙˆØ¹Ø§Øª) - Ù†Ø³Ø®Ø© Ù…Ø¹Ø¯Ù„Ø©
            let tableHtml = '<table class="excel-preview-table" style="margin-top:20px;"><thead><tr><th rowspan="2" style="background:#e0f7fa; vertical-align: middle;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>';
            employees.forEach(emp => {
                const empName = getEmployeeLabel(emp);
                tableHtml += `<th colspan="3" style="text-align:center; background:#f5f5f5; border-right: 3px solid #999; border-left: 3px solid #999;">${empName}</th>`;
            });
            tableHtml += `<th rowspan="2" style="background:#fffde7; vertical-align: middle; border-right: 3px solid #999;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹<br>ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</th>`;
            tableHtml += '</tr><tr>'; // Second row of header
            employees.forEach(emp => {
                tableHtml += `<th style="background:#fff3e0; border-right: 3px solid #999;">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©</th>`;
                tableHtml += `<th style="background:#e8f5e9;">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>`;
                tableHtml += `<th style="background:#e3f2fd; border-left: 3px solid #999;">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø­Ø§Ù„ÙŠØ©</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            const prevDebtMap = {}; 
            const totalPaymentsMap = {};
            employees.forEach(e => totalPaymentsMap[e] = 0);
            
            sortedKeys.forEach((key) => {
                let dailyTotalPaid = 0;
                tableHtml += `<tr><td>${key}</td>`;
                employees.forEach(emp => {
                    const currentDebt = timeSeries[key][emp] || 0;
                    
                    // ØªØ­Ø³ÙŠÙ†: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨ ÙÙŠ Ø£ÙˆÙ„ ÙŠÙˆÙ…
                    let previousDebt = prevDebtMap[emp];
                    let paid = 0;

                    if (previousDebt === undefined) {
                        previousDebt = currentDebt;
                    } else {
                        paid = previousDebt - currentDebt;
                    }
                    
                    if (paid > 0) {
                        totalPaymentsMap[emp] += paid;
                        dailyTotalPaid += paid;
                    }
                    
                    prevDebtMap[emp] = currentDebt;

                    const paidColor = paid > 0 ? 'green' : (paid < 0 ? 'red' : '#666');
                    const paidCellStyle = paid > 0 ? 'background-color:#dcedc8; color:green; font-weight:bold;' : `color:${paidColor};`;

                    tableHtml += `<td style="color:#757575; border-right: 3px solid #999;">${previousDebt > 0 ? previousDebt.toLocaleString('en-US') : '-'}</td>`;
                    tableHtml += `<td style="${paidCellStyle} direction:ltr;">${paid !== 0 ? paid.toLocaleString('en-US') : '-'}</td>`;
                    tableHtml += `<td style="font-weight:bold; border-left: 3px solid #999;">${currentDebt > 0 ? currentDebt.toLocaleString('en-US') : '-'}</td>`;
                });
                tableHtml += `<td style="background:#fffde7; font-weight:bold; color: #3f51b5; border-right: 3px solid #999;">${dailyTotalPaid > 0 ? dailyTotalPaid.toLocaleString('en-US') : '-'}</td>`;
                tableHtml += '</tr>';
            });

            let grandTotalPaid = 0;
            Object.values(totalPaymentsMap).forEach(val => grandTotalPaid += val);

            tableHtml += '<tr style="background:#f0f4c3; font-weight:bold; border-top:2px solid #999;"><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>';
            employees.forEach(emp => {
                const totalPaidForEmp = totalPaymentsMap[emp] || 0;
                tableHtml += `<td style="text-align:center; border-right: 3px solid #999;">-</td>`;
                tableHtml += `<td style="color:green; direction:ltr;">${totalPaidForEmp.toLocaleString('en-US')}</td>`;
                tableHtml += `<td style="text-align:center; border-left: 3px solid #999;">-</td>`;
            });
            tableHtml += `<td style="background:#fffde7; color:green; font-weight:bold; border-right: 3px solid #999;">${grandTotalPaid.toLocaleString('en-US')}</td>`;
            tableHtml += '</tr>';
            
            tableHtml += '</tbody></table>';
            document.getElementById('debtTableContainer').innerHTML = tableHtml;
            makeTableResizable(document.querySelector('#debtTableContainer table'));
        };
        renderDebtChart();
      } catch (e) { alert('Error: ' + e.message); } finally { document.getElementById(loadingId)?.remove(); }
    };

    window.openDailyCollectionStats = () => {
        if (!window._debtRawData) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        
        const html = `
            <div style="padding:10px; height:100%; overflow:auto;">
                <h2 style="text-align:center; color:#2e7d32;">ğŸ’µ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h2>
                
                <div style="background:#e8f5e9; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; border:1px solid #c8e6c9;">
                    <label style="font-weight:bold;">Ø§Ù„ÙØªØ±Ø©:</label>
                    <select id="collPeriodSelect" onchange="toggleCollDateInputs(); renderDailyCollection()" style="padding:8px; border-radius:5px;">
                        <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                        <option value="yesterday">Ø£Ù…Ø³</option>
                        <option value="this_week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                        <option value="this_month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                        <option value="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</option>
                    </select>
                    
                    <div id="collCustomDateDiv" style="display:none;">
                        <label>Ù…Ù†:</label><input type="date" id="collFromDate" onchange="renderDailyCollection()">
                        <label>Ø¥Ù„Ù‰:</label><input type="date" id="collToDate" onchange="renderDailyCollection()">
                    </div>
                    
                    <label style="font-weight:bold; margin-right:10px;">Ø§Ù„Ù…Ø®Ø·Ø·:</label>
                    <select id="collChartType" onchange="renderDailyCollection()" style="padding:8px; border-radius:5px;">
                        <option value="bar">Ø£Ø¹Ù…Ø¯Ø©</option>
                        <option value="pie">Ø¯Ø§Ø¦Ø±ÙŠ</option>
                        <option value="doughnut">Ø¯ÙˆÙ†Ø§Øª</option>
                        <option value="line">Ø®Ø·ÙŠ</option>
                    </select>
                    
                    <button class="btn" onclick="renderDailyCollection()" style="width:auto; height:38px; margin:0; background:#43a047; color:white;">Ø¹Ø±Ø¶ Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                </div>

                <div style="height:300px; margin-bottom:20px; background:#fff; padding:10px; border-radius:10px; border:1px solid #eee;">
                    <canvas id="collChartCanvas"></canvas>
                </div>

                <div id="collSummaryBox" style="text-align:center; margin-bottom:20px;"></div>
                <div id="collTableContainer"></div>

                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-secondary" onclick="document.getElementById('dailyCollectionScreen').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;

        const screen = document.createElement('div');
        screen.className = 'center-screen';
        screen.id = 'dailyCollectionScreen';
        screen.style.zIndex = 710;
        screen.innerHTML = `<div class="box box-large" style="max-width:700px;">${html}</div>`;
        document.body.appendChild(screen);
        
        renderDailyCollection();
    };

    window.toggleCollDateInputs = () => {
        const val = document.getElementById('collPeriodSelect').value;
        document.getElementById('collCustomDateDiv').style.display = (val === 'custom') ? 'block' : 'none';
    };

    window.renderDailyCollection = () => {
        const period = document.getElementById('collPeriodSelect').value;
        let startDate = new Date();
        let endDate = new Date();
        startDate.setHours(0,0,0,0);
        endDate.setHours(23,59,59,999);

        if (period === 'yesterday') {
            startDate.setDate(startDate.getDate() - 1);
            endDate.setDate(endDate.getDate() - 1);
            startDate.setHours(0,0,0,0); endDate.setHours(23,59,59,999);
        } else if (period === 'this_week') {
            const day = startDate.getDay();
            const diff = startDate.getDate() - day + (day == 0 ? -6:1); 
            startDate.setDate(diff);
        } else if (period === 'this_month') {
            startDate.setDate(1);
        } else if (period === 'custom') {
            const f = document.getElementById('collFromDate').value;
            const t = document.getElementById('collToDate').value;
            if(!f || !t) return;
            startDate = new Date(f);
            endDate = new Date(t);
            endDate.setHours(23,59,59,999);
        }

        const timeSeries = {};
        const timeSeriesSets = {};
        const employees = [...Object.keys(appConfig.employeeNames || {}), ...Object.keys(appConfig.stages || {})];
        
        const allPoints = [...window._debtRawData.interactions];
        window._debtRawData.parents.forEach(p => {
            if(p.updated_at) allPoints.push({ parent_code: p.parent_code, updated_at: p.updated_at, employee: p.employee });
        });

        allPoints.forEach(point => {
            if (!point.updated_at) return;
            const d = new Date(point.updated_at);
            // ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† UTC Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            if (!timeSeriesSets[key]) timeSeriesSets[key] = {};
            employees.forEach(e => { if(!timeSeriesSets[key][e]) timeSeriesSets[key][e] = new Set(); });
            const emp = point.employee || 'emp1';
            if (timeSeriesSets[key][emp]) timeSeriesSets[key][emp].add(point.parent_code);
        });

        Object.keys(timeSeriesSets).forEach(key => {
            timeSeries[key] = {};
            employees.forEach(emp => {
                let sum = 0;
                if (timeSeriesSets[key][emp]) {
                    timeSeriesSets[key][emp].forEach(code => {
                        sum += (window._debtRawData.balanceMap[code] || 0);
                    });
                }
                timeSeries[key][emp] = sum;
            });
        });

        const sortedKeys = Object.keys(timeSeries).sort();
        const collectionStats = {};
        employees.forEach(e => collectionStats[e] = 0);
        let totalCollection = 0;
        const prevDebtMap = {};
        
        sortedKeys.forEach(key => {
            const keyDate = new Date(key);
            const inRange = keyDate >= startDate && keyDate <= endDate;

            employees.forEach(emp => {
                const currentDebt = timeSeries[key][emp] || 0;
                let previousDebt = prevDebtMap[emp];
                let paid = 0;
                if (previousDebt === undefined) previousDebt = currentDebt;
                else paid = previousDebt - currentDebt;
                
                prevDebtMap[emp] = currentDebt;

                if (inRange && paid > 0) {
                    collectionStats[emp] += paid;
                    totalCollection += paid;
                }
            });
        });

        // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        const ctx = document.getElementById('collChartCanvas').getContext('2d');
        if (window._collChart) window._collChart.destroy();
        
        const chartType = document.getElementById('collChartType').value;
        const labels = employees.map(e => getEmployeeLabel(e));
        const data = employees.map(e => collectionStats[e]);
        const bgColors = ['#4caf50', '#2196f3', '#ff9800', '#f44336', '#9c27b0', '#00bcd4'];

        window._collChart = new Chart(ctx, {
            type: chartType,
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ­ØµÙŠÙ„',
                    data: data,
                    backgroundColor: bgColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: chartType !== 'bar' },
                    title: { display: true, text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù', font: { size: 16 } }
                }
            }
        });

        document.getElementById('collSummaryBox').innerHTML = `
            <div style="font-size:24px; font-weight:bold; color:#2e7d32;">
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„: ${totalCollection.toLocaleString('en-US')} Ø±ÙŠØ§Ù„
            </div>
            <div style="font-size:14px; color:#666;">
                Ù„Ù„ÙØªØ±Ø© Ù…Ù† ${startDate.toLocaleDateString('ar-EG')} Ø¥Ù„Ù‰ ${endDate.toLocaleDateString('ar-EG')}
            </div>
        `;

        let tableHtml = `<table class="excel-preview-table">
            <thead>
                <tr>
                    <th style="background:#e8f5e9;">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th style="background:#c8e6c9;">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                </tr>
            </thead>
            <tbody>`;
        
        employees.forEach(emp => {
            tableHtml += `<tr>
                <td>${getEmployeeLabel(emp)}</td>
                <td style="font-weight:bold; color:#2e7d32;">${collectionStats[emp].toLocaleString('en-US')}</td>
            </tr>`;
        });
        
        tableHtml += `</tbody></table>`;
        document.getElementById('collTableContainer').innerHTML = tableHtml;
    };

    // --- Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ ÙƒÙ„ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± (Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„) ---
    window.openAllParentsReport = async () => {
        document.getElementById('allParentsScreen').style.display = 'flex';
        document.getElementById('allParentsTableBody').innerHTML = '<tr><td colspan="10" style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';
        
        // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        const empSelect = document.getElementById('allParentsFilterEmp');
        empSelect.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
        Object.keys(appConfig.employeeNames || {}).forEach(k => empSelect.innerHTML += `<option value="${k}">${appConfig.employeeNames[k]}</option>`);
        Object.keys(appConfig.stages || {}).forEach(k => empSelect.innerHTML += `<option value="${k}">${appConfig.stages[k].name}</option>`);

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data: parents, error } = await supabase.from('parents').select('*');
        const { data: interactions } = await supabase.from('interactions').select('*');
        
        if (error) { alert('Ø®Ø·Ø£: ' + error.message); return; }
        
        // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const intMap = {};
        (interactions || []).forEach(i => intMap[i.parent_code] = i);
        
        window.allParentsData = parents.map(p => {
            const i = intMap[p.parent_code] || {};
            return { ...p, ...i };
        });
        
        filterAllParentsTable();
    };

    window.filterAllParentsTable = () => {
        const empFilter = document.getElementById('allParentsFilterEmp').value;
        const searchCol = document.getElementById('allParentsSearchCol').value;
        const search = document.getElementById('allParentsSearch').value.toLowerCase();
        
        const filtered = window.allParentsData.filter(row => {
            if (empFilter !== 'all' && row.employee !== empFilter) return false;
            if (search) {
                if (searchCol === 'all') {
                    return [row.parent_name, row.parent_code, row.phone, row.student_name, row.notes].some(v => String(v||'').toLowerCase().includes(search));
                } else {
                    return String(row[searchCol] || '').toLowerCase().includes(search);
                }
            }
            return true;
        });
        
        const tbody = document.getElementById('allParentsTableBody');
        const thead = document.querySelector('#allParentsTable thead');
        
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø´Ø§Ù…Ù„ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©)
        thead.innerHTML = `<tr>
            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>`;
        
        let html = '';
        filtered.forEach(r => {
            html += `<tr>
                <td>${getEmployeeLabel(r.employee)}</td>
                <td>${r.parent_code || ''}</td>
                <td>${r.parent_name || ''}</td>
                <td>${r.phone || ''}</td>
                <td>${r.student_code || ''}</td>
                <td>${r.student_name || ''}</td>
                <td>${Number(r.final_balance||0).toLocaleString('en-US')}</td>
                <td>${r.updated_at ? new Date(r.updated_at).toLocaleDateString('en-GB') : '-'}</td>
                <td>${r.last_call_status || '-'}</td>
                <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${r.notes||''}">${r.notes || '-'}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
        
        // ØªÙØ¹ÙŠÙ„ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        makeTableResizable(document.querySelector('#allParentsTable'));
    };

    window.exportAllParentsToExcel = () => {
        const wb = XLSX.utils.table_to_book(document.getElementById('allParentsTable'), {sheet:"Report"});
        XLSX.writeFile(wb, "All_Parents_Report.xlsx");
    };

    // --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (General Admin) ---
    window.openGeneralAdmin = () => {
        document.getElementById('general_admin_pass_input').value = '';
        document.getElementById('generalAdminLoginModal').style.display = 'flex';
        setTimeout(() => document.getElementById('general_admin_pass_input').focus(), 100);
    };

    window.submitGeneralAdminLogin = () => {
        const pass = document.getElementById('general_admin_pass_input').value;
        if (pass === appConfig.adminPass) {
            document.getElementById('generalAdminLoginModal').style.display = 'none';
            document.getElementById('generalAdminScreen').style.display = 'flex';
            renderGeneralAdminDashboard();
        } else {
            alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");
        }
    };

    window.closeGeneralAdminLogin = () => {
        document.getElementById('generalAdminLoginModal').style.display = 'none';
    };

    window.changeAdminPassword = async () => {
        const newPass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©:");
        if (newPass && newPass.trim() !== "") {
            appConfig.adminPass = newPass.trim();
            await saveConfigToDB();
            alert("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        }
    };

    window.toggleAdminDateInputs = () => {
        const val = document.getElementById('adminPeriodSelect').value;
        document.getElementById('adminCustomDateDiv').style.display = (val === 'custom') ? 'flex' : 'none';
    };

    window.renderGeneralAdminDashboard = async (updateChartOnly = false) => {
        const period = document.getElementById('adminPeriodSelect').value;
        const chartType = document.getElementById('adminChartType').value || 'bar';
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
        let startDate = new Date(0);
        let endDate = new Date();
        endDate.setHours(23, 59, 59, 999);
        
        const now = new Date();

        if (period === 'today') {
            startDate = new Date(now); startDate.setHours(0,0,0,0);
        } else if (period === 'week') {
            const day = now.getDay();
            const diff = now.getDate() - day + (day == 0 ? -6:1);
            startDate = new Date(now.setDate(diff));
            startDate.setHours(0,0,0,0);
        } else if (period === 'month') {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        } else if (period === 'all') {
            startDate = new Date(0);
        } else if (period === 'custom') {
            const f = document.getElementById('adminDateFrom').value;
            const t = document.getElementById('adminDateTo').value;
            if (f) startDate = new Date(f);
            if (t) {
                endDate = new Date(t);
                endDate.setHours(23, 59, 59, 999);
            }
        }

        // Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const tbody = document.querySelector('#adminFullStatsTable tbody');
        if (tbody && !updateChartOnly) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let interactions = window._adminCachedInteractions;
        if (!interactions || !updateChartOnly) {
             const resInt = await supabase.from('interactions').select('*');
             if (resInt.error) {
                console.error("Error fetching admin data", resInt.error);
                if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                return;
             }
             interactions = resInt.data;
             window._adminCachedInteractions = interactions;
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        const filtered = interactions.filter(i => {
            if (!i.updated_at) return false;
            const d = new Date(i.updated_at);
            return d >= startDate && d <= endDate;
        });

        // 1. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø·Ø· (ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®)
        const dateMap = {};
        filtered.forEach(i => {
            const d = new Date(i.updated_at);
            const key = d.toLocaleDateString('en-CA'); // YYYY-MM-DD
            dateMap[key] = (dateMap[key] || 0) + 1;
        });

        // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ
        const ctx = document.getElementById('adminDailyChart').getContext('2d');
        if (window._adminDailyChart) window._adminDailyChart.destroy();

        const sortedDates = Object.keys(dateMap).sort();
        const chartData = sortedDates.map(k => dateMap[k]);

        window._adminDailyChart = new Chart(ctx, {
            type: chartType,
            data: {
                labels: sortedDates,
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª',
                    data: chartData,
                    backgroundColor: 'rgba(21, 101, 192, 0.5)',
                    borderColor: 'rgba(21, 101, 192, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Ù†Ø´Ø§Ø· Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©' }
                },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });

        // 2. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù)
        const empStats = {};
        const employees = [...Object.keys(appConfig.employeeNames || {}), ...Object.keys(appConfig.stages || {})];
        employees.forEach(e => empStats[e] = { calls: 0, answered: 0, whatsapp: 0, no_answer: 0 });

        filtered.forEach(i => {
            const emp = i.employee || 'emp1';
            if (!empStats[emp]) empStats[emp] = { calls: 0, answered: 0, whatsapp: 0, no_answer: 0 };
            
            empStats[emp].calls++;
            if (i.whatsapp_sent) empStats[emp].whatsapp++;
            
            const status = (i.last_call_status || '').trim();
            const negativeStatuses = ['Ù„Ù… ÙŠØ±Ø¯', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯', 'Ù…Ø´ØºÙˆÙ„', 'Ù…ØºÙ„Ù‚', 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©', ''];
            if (!negativeStatuses.includes(status) && status !== '') {
                empStats[emp].answered++;
            } else {
                empStats[emp].no_answer++;
            }
        });

        // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        const totalAllCalls = Object.values(empStats).reduce((acc, val) => acc + val.calls, 0);

        // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const thead = document.querySelector('#adminFullStatsTable thead');
        thead.innerHTML = `
            <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</th>
                <th>ØªÙ… Ø§Ù„Ø±Ø¯</th>
                <th>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯</th>
                <th>ÙˆØ§ØªØ³Ø§Ø¨</th>
                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</th>
            </tr>
        `;

        let tableHtml = '';
        employees.forEach(e => {
            const s = empStats[e];
            // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
            const ratio = totalAllCalls > 0 ? Math.round((s.calls / totalAllCalls) * 100) : 0;
            
            tableHtml += `<tr>
                <td style="font-weight:bold;">${getEmployeeLabel(e)}</td>
                <td>${s.calls}</td>
                <td style="color:green;">${s.answered}</td>
                <td style="color:red;">${s.no_answer}</td>
                <td>${s.whatsapp}</td>
                <td>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <div style="flex:1; background:#e0e0e0; height:8px; border-radius:4px; overflow:hidden;">
                            <div style="width:${ratio}%; background:${ratio > 20 ? '#1565C0' : '#64b5f6'}; height:100%;"></div>
                        </div>
                        <span style="font-size:12px;">${ratio}%</span>
                    </div>
                </td>
            </tr>`;
        });
        tbody.innerHTML = tableHtml;

        // ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø¬Ø¯ÙˆÙ„
        makeTableResizable(document.getElementById('adminFullStatsTable'));
    };

    window.saveSchoolTargetSettings = async () => {
        appConfig.schoolTotalFees = cleanNumber(document.getElementById('schoolTotalFeesInput').value);
        appConfig.schoolTarget = cleanNumber(document.getElementById('schoolTargetInput').value);
        await saveConfigToDB();
        renderGeneralAdminDashboard(true); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… ÙÙ‚Ø·
    };

    window.exportAdminStatsToExcel = () => {
        const table = document.getElementById('adminFullStatsTable');
        if (!table) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
        const wb = XLSX.utils.table_to_book(table, {sheet: "AdminStats"});
        XLSX.writeFile(wb, "Admin_Dashboard_Stats.xlsx");
    };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¸Ù
    document.getElementById('importEmpSelect').addEventListener('change', () => {
      loadDataToGrid();
    });

    // ØªÙØ¹ÙŠÙ„ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    window.makeTableResizable = (table) => {
      if (!table) return;
      const headers = table.querySelectorAll('th');
      const isMainTable = table.id === 'parentsTable';
      
      headers.forEach((th, index) => {
        if (th.querySelector('.resizer')) th.querySelector('.resizer').remove(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±

        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        th.appendChild(resizer);
        
        let startX, startWidth;
        
        resizer.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          startWidth = th.offsetWidth;
          resizer.classList.add('resizing');
          
          const onMouseMove = (e) => {
            const dx = startX - e.clientX; // RTL: Moving left increases width
            const newWidth = Math.max(50, startWidth + dx);
            
            if (isMainTable && index === 0) document.documentElement.style.setProperty('--col1-width', `${newWidth}px`);
            else if (isMainTable && index === 1) document.documentElement.style.setProperty('--col2-width', `${newWidth}px`);
            else if (isMainTable && index === 2) document.documentElement.style.setProperty('--col3-width', `${newWidth}px`);
            else {
              th.style.width = `${newWidth}px`;
              th.style.minWidth = `${newWidth}px`;
            }
          };
          
          const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            resizer.classList.remove('resizing');
          };
          
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    };

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    window.resetView = () => {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª CSS Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø«Ø¨ØªØ©
      document.documentElement.style.removeProperty('--col1-width');
      document.documentElement.style.removeProperty('--col2-width');
      document.documentElement.style.removeProperty('--col3-width');

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø±Ø¶ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      document.querySelectorAll('#parentsTable th').forEach(th => {
        th.style.width = '';
        th.style.minWidth = '';
      });
      document.getElementById('searchInput').value = '';
      document.getElementById('searchColumn').value = 'all';

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (currentEmployee) showDataForEmployee(currentEmployee);
    };

    window.toggleDarkMode = () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    };

    // Init
    loadSettings();
    // Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ updateImportSelect Ø¯Ø§Ø®Ù„ loadSettings Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    makeTableResizable(document.getElementById('parentsTable'));
  </script>

</body>

</html>