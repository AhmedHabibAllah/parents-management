<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</title>

  <style>
    :root {
      --primary-color: #1976d2;
      --bg-color: #f0f8ff;
      --text-color: #000000;
      --sidebar-width: 350px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      margin: 0;
      min-height: 100vh;
      overflow: auto; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ ÙˆØ£ÙÙ‚ÙŠØ§Ù‹ */
      -webkit-overflow-scrolling: touch;
      direction: rtl;
      font-size: 20px;
    }

    /* Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª (Centered Boxes) */
    .center-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      background: var(--bg-color);
      transition: all 0.3s;
      overflow: auto; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† ÙƒØ¨ÙŠØ±Ø© */
      padding: 20px;
      box-sizing: border-box;
      max-height: 100vh;
    }

    .box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      width: 99.5%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      text-align: center;
      max-height: calc(100vh - 60px);
      overflow: auto; /* ØªÙ…Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
    }

    .box-large {
      width: 99.5%;
      height: auto;
      max-width: none;
      max-height: calc(100vh - 60px);
      overflow: auto;
    }

    h2 {
      margin-bottom: 20px;
      color: var(--primary-color);
    }

    .btn {
      width: 100%;
      padding: 0 16px;
      height: 60px;
      margin-bottom: 10px;
      font-size: 22px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: var(--primary-color);
      color: white;
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 800;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-outline {
      background: #ffffff;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 700;
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
    }

    .btn-secondary {
      background: #777;
    }

    input, textarea, select {
      width: 100%;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 20px;
      font-weight: 600;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard Layout) */
    #dashboardScreen {
      display: none;
      min-height: 100vh;
      width: 100%;
      position: relative;
      overflow: auto;
    }

    .main-content {
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      transition: margin-left 0.3s;
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-container {
      background: #fafafa;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow-x: auto; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ */
      max-height: calc(100vh - 150px); /* ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ø¬Ø¯ÙˆÙ„ */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    thead {
      background: #f7f7f7;
      color: #000;
      position: sticky; /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø£Ø³ */
      top: 0;
      z-index: 5;
    }

    th, td {
      padding: 20px;
      text-align: right;
      border-bottom: 1px solid #ccc;
      white-space: nowrap;
      color: #000;
      font-weight: 600;
      background: #fff;
      font-size: 20px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ù„ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
    .num-cell {
      direction: ltr;
      font-family: 'Segoe UI', sans-serif;
    }

    tr:hover {
      background-color: #f9f9f9;
      cursor: pointer;
    }

    tr.selected {
      background-color: #e3f2fd;
      border-right: 4px solid var(--primary-color);
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: var(--sidebar-width);
      background: white;
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      transform: translateX(-100%); /* Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 20px;
      background: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ (History) */
    .sidebar-right {
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      width: var(--sidebar-width);
      background: white;
      box-shadow: 5px 0 15px rgba(0,0,0,0.1);
      transform: translateX(100%); /* Ù…Ø®ÙÙŠØ© Ù„Ù„ÙŠÙ…ÙŠÙ† */
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar-right.active {
      transform: translateX(0);
    }

    .sidebar-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .info-group {
      margin-bottom: 15px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
    }
    
    .sidebar-right .sidebar-header {
      padding: 20px;
      background: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    .info-value {
      font-weight: bold;
      color: #333;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }

    .close-sidebar {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-group {
      margin-bottom: 20px;
      text-align: right;
    }
    .settings-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    textarea.excel-input {
      height: 150px;
      resize: none;
      font-family: monospace;
      font-size: 12px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .excel-preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }
    .excel-preview-table th, .excel-preview-table td {
      border: 1px solid #ddd;
      padding: 14px 16px;
      text-align: center;
      border-collapse: collapse;
      font-size: 16px;
    }
    .excel-preview-table th {
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
      color: white;
      position: sticky;
      top: 0;
      font-weight: 700;
      font-size: 17px;
    }
    .excel-preview-table tbody tr {
      transition: background-color 0.2s;
    }
    .excel-preview-table tbody tr:hover {
      background-color: #f5f5f5 !important;
    }
    .excel-preview-table tbody tr:nth-child(even) {
      background-color: #fafafa;
    }
    .excel-preview-table td[contenteditable="true"]:focus {
      background: #e3f2fd;
      outline: 2px solid var(--primary-color);
      z-index: 1;
    }

    .qr-container {
      text-align: center;
      margin-bottom: 20px;
      padding: 10px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - ØªØµÙ…ÙŠÙ… Ø£ÙƒØ¨Ø± ÙˆÙˆØ§Ø¶Ø­ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨ */
    .stat-btn {
      padding: 0 20px;
      height: 60px;
      font-size: 20px;
      border-radius: 10px;
      margin-left: 6px;
      background: linear-gradient(90deg,#1976d2,#43a047);
      color: #fff;
      border: none;
      box-shadow: 0 6px 18px rgba(25,118,210,0.18);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .stat-outline {
      background: linear-gradient(90deg,#ffb74d,#ff8a65);
      color: #fff;
    }

    .stats-box {
      background: #ffffff;
      color: #000;
      font-weight: 700;
    }

    .stats-box h3 { font-size: 24px; color: #000; margin: 6px 0 12px; }
    .stats-box .excel-preview-table th, .stats-box .excel-preview-table td { font-size: 16px; padding:12px; font-weight:700; }
    .stats-box .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .stats-box .controls select, .stats-box .controls button { font-size:16px; padding:8px 12px; border-radius:8px; }

    /* Ø£Ø²Ø±Ø§Ø± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª */
    .chart-type-btn {
      padding: 8px 16px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.2s;
    }
    .chart-type-btn:hover { background: #f0f0f0; }
    .chart-type-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

    /* Ù…ØªØ¬Ø§ÙˆØ¨: Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 768px) {
      .box { padding: 18px; width: 95%; }
      .btn { padding: 10px; font-size: 14px; }
      .stat-btn { padding: 10px; font-size: 14px; }
      .excel-preview-table th, .excel-preview-table td { font-size: 13px; }
      table { min-width: 600px; }
    }

    @media (max-width: 420px) {
      .header-bar { flex-direction: column; gap:8px; }
      .header-bar h3 { font-size: 18px; }
      .stat-btn { width: 100%; }
    }
  </style>
</head>

<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù -->
<div class="center-screen" id="employeeScreen">
  <div class="box" style="max-width: 600px; margin: 0 auto;">
    <h2>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
    <p style="color:#666; margin-bottom:20px;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
    <div id="employeeButtons">
      <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ -->
    </div>
    <!-- Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ Ø£ÙÙ„ØºÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <button class="btn btn-outline" onclick="openSettingsAdmin()" style="margin-top:20px;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</button>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard) -->
<div id="dashboardScreen">
  
  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div class="main-content" id="mainContent">
    <h1 style="text-align:center; font-size:28px; color:var(--primary-color); font-weight:800; margin:6px 0 12px;">Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªØ±Ø¨ÙŠÙ‡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠÙ‡ Ø§Ù„Ø±ÙˆØ§Ø¨ÙŠ</h1>
    <div class="header-bar">
      <h3 id="employeeName" style="margin:0;"></h3>
      <div>
        <button class="btn btn-secondary" onclick="goBack()" style="width:auto; display:inline-flex;">Ø®Ø±ÙˆØ¬</button>
        <button class="stat-btn" onclick="openStats()" style="width:auto; display:inline-flex; margin-right:8px;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button class="btn btn-outline" onclick="openEmployeeSettings()" style="width:auto; display:inline-flex;">âš™ï¸</button>
      </div>
    </div>

    <div class="table-container">
      <table id="parentsTable">
        <thead>
          <tr>
            <th>Ù…</th>
            <th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
            <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</th>
            <th>Ø±ØµÙŠØ¯ Ù1</th>
            <th>Ø±ØµÙŠØ¯ Ù2</th>
            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Ø§Ù„ØµÙÙˆÙ -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) -->
  <div class="sidebar" id="detailsSidebar">
    <div class="sidebar-header">
      <span id="sidebarTitle">ØªÙØ§ØµÙŠÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</span>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="close-sidebar" onclick="openEmployeeSettings()" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù">âš™ï¸</button>
        <button class="close-sidebar" onclick="closeSidebar()">âœ•</button>
      </div>
    </div>
    
    <div class="sidebar-content">
      <div id="sidebarInfo"></div>
      
      <!-- QR Code -->
      <div id="qrCodeContainer" class="qr-container"></div>

      <hr style="border:0; border-top:1px solid #eee; margin:20px 0 10px;">
      <h3 style="color: var(--primary-color); margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>

      <label class="info-label">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</label>
      <input type="number" id="callCountInput" placeholder="0">

      <label class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notesInput" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§..."></textarea>

      <label class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</label>
      <select id="callStatusSelect"></select>

      <label class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
      <input type="date" id="nextCallDateInput">

      <button class="btn" onclick="saveParentInteraction()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>

      <div class="action-buttons">
        <div style="display: flex; gap: 10px; align-items: center;">
          <button class="btn" style="background:#25D366; flex: 1; margin-bottom:0;" onclick="openWhatsApp()">
            ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨
          </button>
          <div style="display: flex; align-items: center; background: #f8f9fa; padding: 0 10px; border-radius: 8px; height: 60px; border: 1px solid #ccc;">
            <input type="checkbox" id="whatsappSentCheckbox" style="width: 20px; height: 20px; margin: 0;">
            <label for="whatsappSentCheckbox" style="margin-right: 8px; font-size: 14px; cursor: pointer; white-space: nowrap;">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
          </div>
        </div>
        <button class="btn" style="background:#ff9800; margin-bottom:0;" onclick="openPayment()">
          ğŸ’³ Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        </button>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„) -->
  <div class="sidebar-right" id="historySidebar">
    <div class="sidebar-header">
      <span>Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</span>
      <button class="close-sidebar" onclick="closeSidebar()">âœ•</button>
    </div>
    <div class="sidebar-content" id="historyInfo"></div>
  </div>

</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† (Password masked) -->
<div class="center-screen" id="adminLoginScreen" style="display:none; z-index:500;">
  <div class="box" style="width:380px; max-width:95%; margin:0 auto; text-align:right;">
    <h2 style="text-align:center;">ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
    <div style="padding:6px 0; text-align:right;">
      <label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù†</label>
      <input type="password" id="admin_login_input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%; padding:10px; margin-top:6px;">
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" onclick="submitAdminLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-secondary" onclick="closeAdminLogin()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
</div>

<div class="center-screen" id="settingsScreen" style="display:none; z-index:20;">
  <div class="box" style="width: 98%; max-width:none; height:98%; display:flex; flex-direction:column; text-align: right;">
    <h2 style="text-align:center;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
    
    <div style="flex:1; overflow-y: auto; padding: 5px;">
      
      <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± (Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ Ø£Ùˆ Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) -->
      <div style="display:flex; gap:20px; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
        <div style="flex:1;">
          <label>ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
          <input type="color" id="themeColor" style="height:40px; padding:2px;">
        </div>
        <div style="flex:2;">
          <label>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹</label>
          <input type="text" id="paymentUrlSetting" style="margin-bottom:0;">
        </div>
      </div>

      <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
        <label>ğŸ” ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</label>
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
          <input type="text" id="pass_emp1" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 1" style="margin:0;">
          <input type="text" id="pass_emp2" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 2" style="margin:0;">
          <input type="text" id="pass_emp3" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 3" style="margin:0;">
          <input type="text" id="pass_emp4" placeholder="Ø±Ù…Ø² Ù…ÙˆØ¸Ù 4" style="margin:0;">
        </div>

        <label style="display:block; margin-top:12px;">ğŸ§‘â€ğŸ’¼ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)</label>
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:6px;">
          <input type="text" id="name_emp1" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù 1" style="margin:0;">
          <input type="text" id="name_emp2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù 2" style="margin:0;">
          <input type="text" id="name_emp3" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù 3" style="margin:0;">
          <input type="text" id="name_emp4" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù 4" style="margin:0;">
        </div>
      </div> 

      <div class="settings-group" style="border-bottom:1px solid #eee; padding-bottom:15px;">
        <label>ğŸ“ Ø®ÙŠØ§Ø±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø¶Ø¹ ÙƒÙ„ Ø®ÙŠØ§Ø± ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)</label>
        <textarea id="statusOptionsInput" placeholder="Ù…Ø´ØºÙˆÙ„
Ù„Ù… ÙŠØ±Ø¯
ØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚" style="height:90px; width:100%; padding:12px; box-sizing:border-box;"></textarea>
      </div>

      <div class="settings-group">
        <label> Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Excel)</label>
        <label style="font-size:1.1em; color:var(--primary-color); border-bottom:2px solid #eee; padding-bottom:5px;">ğŸ“‚ Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù†Ø³Ø®/Ù„ØµÙ‚ Excel)</label>
        <p style="font-size:12px; color:#666; margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ØŒ Ø«Ù… Ø§Ø¶ØºØ· "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.</p>
        <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap;">
          <select id="importEmpSelect" style="width:200px; margin:0; font-weight:bold; border:2px solid var(--primary-color);">
            <option value="emp1">Ù…ÙˆØ¸Ù 1</option>
            <option value="emp2">Ù…ÙˆØ¸Ù 2</option>
            <option value="emp3">Ù…ÙˆØ¸Ù 3</option>
            <option value="emp4">Ù…ÙˆØ¸Ù 4</option>
          </select>
          <button class="btn btn-outline" onclick="loadDataToGrid()" style="width:auto; margin:0;">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
          <button class="btn btn-outline" onclick="togglePasteArea()" style="width:auto; margin:0;">ğŸ“‹ Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn btn-outline" onclick="deleteEmployeeDataDB()" style="width:auto; margin:0; color:red; border-color:red; background:#fff5f5;">âŒ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
        </div>

        <textarea id="excelPasteArea" class="excel-input" style="display:none; margin-bottom:10px;"
          placeholder="Ø§Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ ÙˆØ§Ù„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§... (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ù… - Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ - Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ù‡ÙˆÙŠØ© - Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„Ù…Ø¯ÙˆØ± - Ù1 - Ù2 - Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)" oninput="convertPasteToGrid()">
        </textarea>
        
        <div id="gridContainer" style="max-height:300px; overflow:auto; border:1px solid #ddd; border-radius:8px;">
          <p style="text-align:center; padding:20px; color:#999;">Ø§Ø®ØªØ± "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ø£Ùˆ "Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡</p>
        </div>
      </div>

    </div>

    <div style="display:flex; gap:10px; margin-top:15px;">
      <button class="btn" onclick="saveSettingsAndData(false, this)">ğŸ’¾ Ø­ÙØ¸ (Ø¨Ø¯ÙˆÙ† Ø¥ØºÙ„Ø§Ù‚)</button>
      <button class="btn btn-outline" onclick="saveSettingsAndData(true, this)">ğŸšª Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
      <button class="btn btn-outline" onclick="openAdvancedStats()">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</button>
      <button class="btn btn-secondary" onclick="closeSettings()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„) -->
<div class="center-screen" id="adminScreen" style="display:none; z-index:30;"> 

<!-- Ø´Ø§Ø´Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù (ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©) -->
<div class="center-screen" id="employeeSettingsScreen" style="display:none; z-index:520;">
  <div class="box" style="width:420px; max-width:95%; margin:0 auto; text-align:right;">
    <h2 style="text-align:center;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h2>
    <div id="employeeSettingsTitle" style="text-align:center; font-weight:700; margin-bottom:8px; color:#333;"></div>
    <div style="padding:6px 0;">
      <label>ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="emp_pass_input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©">
      <label style="margin-top:10px; display:block;">ğŸ¨ ÙˆØ§Ø¬Ù‡Ø© Ø®Ø§ØµØ©</label>
      <input type="color" id="emp_theme_input" style="height:40px; padding:2px;">
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button class="btn btn-outline" onclick="resetEmployeeTheme()" style="width:auto;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
        <span style="align-self:center; color:#666; font-size:13px;">(Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ø­Ø³Ø§Ø¨Ùƒ ÙÙ‚Ø·)</span>
      </div>
    </div>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button class="btn" onclick="saveEmployeeSettings()">Ø­ÙØ¸</button>
      <button class="btn btn-secondary" onclick="closeEmployeeSettings()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>
  <div class="box box-large" style="display:flex; flex-direction:column;">
    <h2>ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ (ÙˆØ¶Ø¹ Ø§Ù„Ø¥ÙƒØ³Ù„)</h2>
    <p style="color:#666; font-size:14px;">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ù†Ø§ ÙˆÙ„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø«Ù… Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ ÙˆÙ„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§ Ù„Ù„Ø­ÙØ¸. <br> <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡.</p>
    
    <textarea id="adminDataInput" style="flex:1; white-space:pre; overflow:auto; font-family:monospace; font-size:12px; border:2px solid var(--primary-color);" 
      placeholder="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."></textarea>
    
    <div style="display:flex; gap:10px; justify-content:center;">
      <button class="btn" onclick="saveAdminDataFull()" style="background:#d32f2f;">ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„</button>
      <button class="btn btn-outline" onclick="loadAdminData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button class="btn btn-secondary" onclick="closeAdminPanel()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://emrsfzmaqmfavehrdppw.supabase.co',
    'sb_publishable_dmZ-1l-BmDzIteU1IaSjnw_3TMkHMhw'
  );

  // ===== Usage tracking (local + optional Supabase) =====
  const pushUsageEvent = async (evt) => {
    // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙˆÙ† ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ
    try {
      await supabase.from('employee_usage').insert(evt);
    } catch (e) {
      console.debug('Supabase insert for usage event failed:', e?.message || e);
    }
  };

  // ØªØªØ¨Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† sessionStorage
  const sessionStartTimes = {};

  // Ø³Ø¬Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù
  const recordLogin = (employee) => {
    const now = Date.now();
    sessionStartTimes[employee] = now;
    pushUsageEvent({ employee, type: 'login', ts: new Date().toISOString() });
  };

  // Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ø­Ø³Ø¨ Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
  const recordLogout = (employee) => {
    try {
      const start = sessionStartTimes[employee];
      if (start) {
        const end = Date.now();
        const duration = Math.max(0, end - start);
        pushUsageEvent({ employee, type: 'session', start: new Date(start).toISOString(), end: new Date(end).toISOString(), duration_ms: duration });
        delete sessionStartTimes[employee];
      } else {
        // Push a simple logout record
        pushUsageEvent({ employee, type: 'logout', ts: new Date().toISOString() });
      }
    } catch (e) { console.error(e); }
  };

  let currentEmployee = "";
  let currentParentId = null; // ID of selected parent in DB
  let currentParentPhone = "";
  let currentParentIdentity = "";

  // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  let appConfig = {
    theme: '#1976d2',
    paymentUrl: 'https://google.com',
    passwords: { emp1: '', emp2: '', emp3: '', emp4: '' },
    employeeNames: { emp1: 'Ù…ÙˆØ¸Ù 1', emp2: 'Ù…ÙˆØ¸Ù 2', emp3: 'Ù…ÙˆØ¸Ù 3', emp4: 'Ù…ÙˆØ¸Ù 4' },
    employeeThemes: {},
    statusOptions: "Ù…Ø´ØºÙˆÙ„\nÙ„Ù… ÙŠØ±Ø¯\nÙ…Ø¹ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯\nÙ…Ø¹ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…\nØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯"
  };

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  async function saveConfigToDB() {
    const { error } = await supabase.from('app_config').upsert({ id: 1, config: appConfig });
    if (error) console.error('Error saving settings to DB', error);
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  async function loadSettings() {
    try {
      const { data, error } = await supabase.from('app_config').select('config').eq('id', 1).single();
      if (data && data.config) {
        const parsed = data.config;
        appConfig = Object.assign({}, appConfig, parsed);
        appConfig.passwords = Object.assign({}, appConfig.passwords || {}, parsed.passwords || {});
        appConfig.employeeNames = Object.assign({ emp1: 'Ù…ÙˆØ¸Ù 1', emp2: 'Ù…ÙˆØ¸Ù 2', emp3: 'Ù…ÙˆØ¸Ù 3', emp4: 'Ù…ÙˆØ¸Ù 4' }, appConfig.employeeNames || {}, (parsed.employeeNames || {}));
        appConfig.employeeThemes = Object.assign({}, appConfig.employeeThemes || {}, parsed.employeeThemes || {});
      }
    } catch (e) { console.error('Failed to load appConfig from DB', e); }

    applyTheme();
    renderEmployeeButtons();
  }

  function applyTheme() {
    const empTheme = (currentEmployee && appConfig.employeeThemes && appConfig.employeeThemes[currentEmployee]);
    document.documentElement.style.setProperty('--primary-color', empTheme || appConfig.theme);
  }

  function getEmployeeLabel(emp) {
    return (appConfig.employeeNames && appConfig.employeeNames[emp]) || emp;
  }

  function renderEmployeeButtons() {
    const container = document.getElementById('employeeButtons');
    container.innerHTML = '';
    ['emp1', 'emp2', 'emp3', 'emp4'].forEach((emp) => {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.innerText = `ğŸ‘¤ ${getEmployeeLabel(emp)}`;
      btn.onclick = () => checkPasswordAndLogin(emp);
      container.appendChild(btn);
    });
  }

  window.checkPasswordAndLogin = (emp) => {
    const pass = appConfig.passwords[emp];
    if (pass && pass.trim() !== "") {
      const input = prompt("ğŸ”’ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
      if (input !== pass) {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
        return;
      }
    }
    showDataForEmployee(emp);
    // Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    try { recordLogin(emp); } catch (e) { console.error(e); }
  };

  // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
  window.showDataForEmployee = async (employee) => {
    currentEmployee = employee;
    applyTheme();

    document.getElementById("employeeName").innerText =
      "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… - " + getEmployeeLabel(employee);

    const { data, error } = await supabase
      .from("parents")
      .select("*")
      .eq("employee", employee)
      .order("serial_no");

    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    if (error) {
      alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      console.error(error);
      return;
    }

    if (data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='9' style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
    }

    data.forEach(p => {
      const tr = document.createElement("tr");
      tr.onclick = () => selectParent(tr, p);
      tr.innerHTML = `
        <td>${p.serial_no || '-'}</td>
        <td>${p.parent_code || '-'}</td>
        <td><strong>${p.parent_name || '-'}</strong></td>
        <td>${p.identity_no || '-'}</td>
        <td class="num-cell" style="text-align:right;">${p.phone || '-'}</td>
        <td class="num-cell">${(p.carried_balance || 0).toLocaleString('en-US')}</td>
        <td class="num-cell">${(p.term1_balance || 0).toLocaleString('en-US')}</td>
        <td class="num-cell">${(p.term2_balance || 0).toLocaleString('en-US')}</td>
        <td class="num-cell" style="color:${(p.final_balance || 0) > 0 ? 'red' : 'green'}">${(p.final_balance || 0).toLocaleString('en-US')}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("employeeScreen").style.display = "none";
    document.getElementById("dashboardScreen").style.display = "block";
  };

  // Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ„ÙŠ Ø£Ù…Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
  window.selectParent = (tr, data) => {
    // Highlight row
    document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
    tr.classList.add('selected');

    // Set Data
    currentParentId = data.id; // Assuming Supabase has an 'id' column automatically or we use another unique key
    currentParentPhone = data.phone;
    currentParentIdentity = data.identity_no;

    // Generate QR Code (Using a public API for simplicity)
    const qrContainer = document.getElementById('qrCodeContainer');
    if (currentParentPhone) {
      const cleanPhone = currentParentPhone.replace(/\D/g, '');
      qrContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=tel:${cleanPhone}" alt="QR Call" style="display:block; margin:0 auto;"><span style="font-size:11px; color:#666;">Ø§Ù…Ø³Ø­ Ù„Ù„Ø§ØªØµØ§Ù„</span>`;
    } else {
      qrContainer.innerHTML = '';
    }
    
    // Populate Sidebar
    const infoDiv = document.getElementById('sidebarInfo');
    const formatLtr = (val) => `<span class="num-cell">${val}</span>`;
    const formatDate = (dateStr) => {
      if (!dateStr) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      try {
        return new Date(dateStr).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
      } catch(e) { return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­'; }
    };

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ Ø§ØªØµØ§Ù„ Ø³Ø§Ø¨Ù‚ (Ù„ØªØ¬Ù†Ø¨ Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§ØªØµØ§Ù„)
    // Ù†Ø¹ØªØ¨Ø± Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø­Ø§Ù„Ø© Ø§ØªØµØ§Ù„ Ù…Ø³Ø¬Ù„Ø© Ø£Ùˆ Ø¹Ø¯Ø¯ Ø§ØªØµØ§Ù„Ø§Øª Ø£ÙƒØ¨Ø± Ù…Ù† 0 Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª
    const hasHistory = (data.last_call_status && data.last_call_status.trim() !== "") || (data.call_count > 0) || (data.notes && data.notes.trim() !== "");

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§ØªØµØ§Ù„)
    const historyDiv = document.getElementById('historyInfo');
    historyDiv.innerHTML = `
      <h3 style="color: var(--primary-color); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</h3>
      <div class="info-group"><div class="info-label">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</div><div class="info-value">${hasHistory ? formatDate(data.updated_at) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group"><div class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¢Ø®Ø± Ø§ØªØµØ§Ù„</div><div class="info-value" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto; background:#f9f9f9; padding:8px; border-radius:4px;">${(hasHistory && data.notes) ? data.notes : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group"><div class="info-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</div><div class="info-value" style="color: var(--primary-color);">${(hasHistory && data.last_call_status) ? data.last_call_status : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group"><div class="info-label">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡</div><div class="info-value">${(hasHistory && data.next_call_date) ? data.next_call_date : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div>
      <div class="info-group"><div class="info-label">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø³Ø§Ø¨Ù‚Ø§Ù‹</div><div class="info-value">${(hasHistory && data.whatsapp_sent) ? 'Ù†Ø¹Ù… âœ…' : 'Ù„Ø§ âŒ'}</div></div>
    `;

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ (Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±)
    infoDiv.innerHTML = `
      <h3 style="color: var(--primary-color); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h3>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø§Ø³Ù…</div><div class="info-value">${data.parent_name || '-'}</div></div>
      <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</div><div class="info-value">${formatLtr(data.identity_no || '-')}</div></div>
      <div class="info-group"><div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div><div class="info-value">${formatLtr(data.phone || '-')}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="info-value" style="color:red; font-size: 1.2em;">${formatLtr((data.final_balance || 0).toLocaleString('en-US'))}</div></div>
      <div class="info-group"><div class="info-label">Ø±ØµÙŠØ¯ Ù1</div><div class="info-value">${formatLtr((data.term1_balance || 0).toLocaleString('en-US'))}</div></div>
      <div class="info-group"><div class="info-label">Ø±ØµÙŠØ¯ Ù2</div><div class="info-value">${formatLtr((data.term2_balance || 0).toLocaleString('en-US'))}</div></div>
      <div class="info-group"><div class="info-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±</div><div class="info-value">${formatLtr((data.carried_balance || 0).toLocaleString('en-US'))}</div></div>
    `;

    // Set Inputs (Assuming columns exist, if not they will be null/undefined)
    // Note: You need to ensure 'call_count' and 'notes' columns exist in your Supabase table.
    document.getElementById('callCountInput').value = data.call_count || 0;
    document.getElementById('notesInput').value = data.notes || "";
    
    // Populate Status Dropdown
    const statusSelect = document.getElementById('callStatusSelect');
    statusSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© --</option>';
    const options = appConfig.statusOptions.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean);
    options.forEach(opt => { statusSelect.innerHTML += `<option value="${opt}">${opt}</option>`; });
    statusSelect.value = data.last_call_status || "";

    // Date
    document.getElementById('nextCallDateInput').value = data.next_call_date || "";
    document.getElementById('whatsappSentCheckbox').checked = data.whatsapp_sent || false;

    // Show Sidebar
    document.getElementById('detailsSidebar').classList.add('active');
    document.getElementById('historySidebar').classList.add('active');
  };

  window.closeSidebar = () => {
    document.getElementById('detailsSidebar').classList.remove('active');
    document.getElementById('historySidebar').classList.remove('active');
    document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
  };

  window.saveParentInteraction = async () => {
    if (!currentParentId) return;

    try {
      const callsInput = document.getElementById('callCountInput').value;
      const calls = callsInput ? parseInt(callsInput) : 0;
      const notes = document.getElementById('notesInput').value;
      const status = document.getElementById('callStatusSelect').value;
      const nextDate = document.getElementById('nextCallDateInput').value;
      const whatsappSent = document.getElementById('whatsappSentCheckbox').checked;
  
      const { error } = await supabase
        .from('parents')
        .update({ 
          call_count: calls, 
          notes: notes,
          last_call_status: status,
          next_call_date: nextDate || null,
          whatsapp_sent: whatsappSent
        })
        .eq('id', currentParentId); // Using internal ID is safer
  
      if (error) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        console.error('Supabase Error:', error);
      } else {
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        closeSidebar();
        showDataForEmployee(currentEmployee);
      }
    } catch (e) {
      // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„
      console.error("Network/Fetch error:", e);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….\n\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ù…ØªØµÙØ­Ùƒ (Ù…Ø«Ù„ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª) ØªÙ…Ù†Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„.\n\nØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£: ' + e.message);
    }
  };

  window.goBack = () => {
    closeSidebar();
    document.getElementById("dashboardScreen").style.display = "none";
    document.getElementById("employeeScreen").style.display = "flex";
    try { recordLogout(currentEmployee); } catch (e) { console.error(e); }
  };

  window.openSettingsAdmin = () => {
    // show the masked admin login modal
    document.getElementById('admin_login_input').value = '';
    document.getElementById('adminLoginScreen').style.display = 'flex';
    setTimeout(()=>{ try{ document.getElementById('admin_login_input').focus(); }catch(e){} }, 50);
  };

  window.submitAdminLogin = () => {
    const pass = document.getElementById('admin_login_input').value;
    if (pass === 'admin123') {
      document.getElementById('adminLoginScreen').style.display = 'none';
      // Populate fields
      document.getElementById('themeColor').value = appConfig.theme;
      document.getElementById('paymentUrlSetting').value = appConfig.paymentUrl;
      document.getElementById('pass_emp1').value = appConfig.passwords.emp1;
      document.getElementById('pass_emp2').value = appConfig.passwords.emp2;
      document.getElementById('pass_emp3').value = appConfig.passwords.emp3;
      document.getElementById('pass_emp4').value = appConfig.passwords.emp4;
      document.getElementById('statusOptionsInput').value = appConfig.statusOptions;
      document.getElementById('name_emp1').value = (appConfig.employeeNames && appConfig.employeeNames.emp1) || 'Ù…ÙˆØ¸Ù 1';
      document.getElementById('name_emp2').value = (appConfig.employeeNames && appConfig.employeeNames.emp2) || 'Ù…ÙˆØ¸Ù 2';
      document.getElementById('name_emp3').value = (appConfig.employeeNames && appConfig.employeeNames.emp3) || 'Ù…ÙˆØ¸Ù 3';
      document.getElementById('name_emp4').value = (appConfig.employeeNames && appConfig.employeeNames.emp4) || 'Ù…ÙˆØ¸Ù 4';

      document.getElementById("settingsScreen").style.display = "flex";
    } else {
      alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ');
    }
  };

  window.closeAdminLogin = () => { document.getElementById('adminLoginScreen').style.display = 'none'; }; 

  window.closeSettings = () => {
    document.getElementById("settingsScreen").style.display = "none";
  };

  window.saveAppSettings = async () => {
    appConfig.theme = document.getElementById('themeColor').value;
    appConfig.paymentUrl = document.getElementById('paymentUrlSetting').value;
    appConfig.passwords.emp1 = document.getElementById('pass_emp1').value;
    appConfig.passwords.emp2 = document.getElementById('pass_emp2').value;
    appConfig.passwords.emp3 = document.getElementById('pass_emp3').value;
    appConfig.passwords.emp4 = document.getElementById('pass_emp4').value;
    appConfig.statusOptions = document.getElementById('statusOptionsInput').value;
    appConfig.employeeNames = {
      emp1: document.getElementById('name_emp1').value || 'Ù…ÙˆØ¸Ù 1',
      emp2: document.getElementById('name_emp2').value || 'Ù…ÙˆØ¸Ù 2',
      emp3: document.getElementById('name_emp3').value || 'Ù…ÙˆØ¸Ù 3',
      emp4: document.getElementById('name_emp4').value || 'Ù…ÙˆØ¸Ù 4'
    };

    await saveConfigToDB();
    applyTheme();
    renderEmployeeButtons();
  };

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù (ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©)
  window.openEmployeeSettings = () => {
    if (!currentEmployee) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    document.getElementById('employeeSettingsTitle').innerText = getEmployeeLabel(currentEmployee);
    document.getElementById('emp_pass_input').value = appConfig.passwords[currentEmployee] || '';
    document.getElementById('emp_theme_input').value = (appConfig.employeeThemes && appConfig.employeeThemes[currentEmployee]) || appConfig.theme;
    document.getElementById('employeeSettingsScreen').style.display = 'flex';
  };

  window.saveEmployeeSettings = async () => {
    if (!currentEmployee) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    const pass = document.getElementById('emp_pass_input').value;
    const theme = document.getElementById('emp_theme_input').value;
    appConfig.passwords[currentEmployee] = pass;
    appConfig.employeeThemes = appConfig.employeeThemes || {};
    appConfig.employeeThemes[currentEmployee] = theme;
    await saveConfigToDB();
    applyTheme();
    alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù');
    document.getElementById('employeeSettingsScreen').style.display = 'none';
  };

  window.resetEmployeeTheme = async () => {
    if (!currentEmployee) return;
    if (appConfig.employeeThemes) delete appConfig.employeeThemes[currentEmployee];
    document.getElementById('emp_theme_input').value = appConfig.theme;
    await saveConfigToDB();
    applyTheme();
    alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ');
  };

  window.closeEmployeeSettings = () => { document.getElementById('employeeSettingsScreen').style.display = 'none'; }; 

  window.openWhatsApp = () => {
    if (!currentParentPhone) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„");
    // Clean phone number
    let phone = currentParentPhone.replace(/\D/g, ''); 
    // Add country code if missing (Assuming SA for example, or just open as is)
    window.open(`https://wa.me/${phone}`, '_blank');
  };

  window.openPayment = () => {
    if (!currentParentIdentity) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±");
    window.open(`https://ncle-sms.com/Payment/?id=${currentParentIdentity}`, '_blank');
  };

  // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---

  // ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø© ÙˆÙ…ØªÙ‚Ø¯Ù…Ø© (ÙˆØ§Ø¬Ù‡Ø©) =====
  function formatCurrency(v) {
    return Number(v || 0).toLocaleString('en-US');
  }

  window.openStats = async () => {
    // Ø§Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ÙˆØ§Ø­ØªØ³Ø¨ Ù…Ø¤Ø´Ø±Ø§Øª Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
    const { data, error } = await supabase.from('parents').select('*');
    if (error) { alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ' + error.message); console.error(error); return; }

    const byEmp = {};
    // Ensure we include all known employees even if they have zero records
    const knownEmps = Object.keys(appConfig.employeeNames || {});
    knownEmps.forEach(e => { byEmp[e] = { count:0, sum_final:0, sum_carried:0, debtors:0, total_calls: 0, responded: 0 }; });

    (data || []).forEach(r => {
      const emp = r.employee || 'emp1';
      if (!byEmp[emp]) byEmp[emp] = { count: 0, sum_final: 0, sum_carried: 0, debtors: 0, total_calls: 0, responded: 0 };
      byEmp[emp].count += 1;
      byEmp[emp].sum_final += Number(r.final_balance || 0);
      byEmp[emp].sum_carried += Number(r.carried_balance || 0);
      if ((r.final_balance || 0) > 0) byEmp[emp].debtors += 1;
      byEmp[emp].total_calls += Number(r.call_count || 0);
      if(r.last_call_status && r.last_call_status.trim() !== '') byEmp[emp].responded += 1;
    });

    // Ø£Ù†Ø´Ø¦ Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ù…Ø¨Ø³Ø·Ø©
    const html = ['<div style="padding:10px; max-height:70vh; overflow:auto;">',
      '<h3 style="text-align:center;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ù…Ù„Ø®Øµ</h3>',
      '<div class="controls" style="justify-content:center;">',
        '<select id="statsChartType"><option value="bar">Ø£Ø¹Ù…Ø¯Ø©</option><option value="pie">Ø¯Ø§Ø¦Ø±ÙŠ</option><option value="doughnut">Ø¯ÙˆÙ†Ø§Øª</option><option value="line">Ø®Ø·ÙŠ</option></select>',
        '<button onclick="renderStatsTable()" class="btn">ØªØ­Ø¯ÙŠØ«</button>',
        '<button class="btn" onclick="saveStatsPDF(\'statsScreen\')">Ø­ÙØ¸ ÙƒÙ€ PDF</button>',
      '</div>',
      '<canvas id="statsChart" style="max-width:100%; height:300px;"></canvas>',
      '<div id="statsTable" style="margin-top:10px;"></div>',
      '<div style="text-align:center; margin-top:10px;"><button class="btn btn-secondary" onclick="closeStats()">Ø¥ØºÙ„Ø§Ù‚</button></div>',
      '</div>'].join('');

    // Ø¹Ø±Ø¶ ÙƒØµÙ†Ø¯ÙˆÙ‚ Ù…Ø±ÙƒØ²ÙŠ
    const screen = document.createElement('div');
    screen.className = 'center-screen';
    screen.id = 'statsScreen';
    screen.style.zIndex = 520;
    // Ø§Ø³ØªØ®Ø¯Ù… class stats-box Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø·
    screen.innerHTML = `<div class="box box-large stats-box">${html}</div>`;
    document.body.appendChild(screen);

    // render table & chart
    window.renderStatsTable = () => {
      const labelsIds = Object.keys(byEmp);
      const labels = labelsIds.map(id => getEmployeeLabel(id));
      const totals = labelsIds.map(k => byEmp[k].sum_final);

      const tableHtml = ['<table class="excel-preview-table"><thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙˆØ±</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯</th></tr></thead><tbody>'];
      labelsIds.forEach(k => {
        tableHtml.push(`<tr><td>${getEmployeeLabel(k)}</td><td>${byEmp[k].count}</td><td>${formatCurrency(byEmp[k].sum_final)}</td><td>${formatCurrency(byEmp[k].sum_carried)}</td><td>${byEmp[k].debtors}</td><td>${byEmp[k].total_calls}</td><td>${byEmp[k].responded}</td></tr>`);
      });
      tableHtml.push('</tbody></table>');
      document.getElementById('statsTable').innerHTML = tableHtml.join('');

      // Chart
      try {
        const ctx = document.getElementById('statsChart').getContext('2d');
        if (window._statsChart) window._statsChart.destroy();
        const selectedType = document.getElementById('statsChartType')?.value || 'bar';
        window._statsChart = new Chart(ctx, {
            type: selectedType,
            data: { labels, datasets: [{ label: 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', data: totals, backgroundColor: ['#1976d2','#43a047','#fbc02d','#e64a19'] }] },
            options: { 
              responsive:true, 
              plugins:{
                legend:{display:selectedType==='pie'||selectedType==='doughnut'},
                title:{display:true,text:'Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', font:{size:18, weight:'600'}, color:'#333'}
              },
              scales: selectedType === 'pie' || selectedType === 'doughnut' ? {} : {
                y:{beginAtZero:true, ticks:{font:{size:14}, color:'#333'}},
                x:{ticks:{font:{size:14}, color:'#333'}}
              }
            }
          });
      } catch(e){ console.error('Chart render failed', e); }
    };

    renderStatsTable();
  };

  window.closeStats = () => {
    const s = document.getElementById('statsScreen');
    if (s) s.remove();
  };

  window.openAdvancedStats = async () => {
    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const { data, error } = await supabase.from('parents').select('*');
    if (error) { alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message); console.error(error); return; }

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    const { data: usageData, error: usageError } = await supabase.from('employee_usage').select('*');
    const usage = usageData || [];

    // Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    let selectedDateRange = 'all'; // all, today, week, month, custom
    let customStartDate = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
    let customEndDate = new Date().toISOString().split('T')[0];
    let currentChartType = 'bar'; // Default chart type

    // Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const filterDataByDate = (allData) => {
      if (selectedDateRange === 'all') return allData;
      
      const now = new Date();
      let startDate = new Date();
      
      switch(selectedDateRange) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          break;
        case 'week':
          startDate.setDate(now.getDate() - now.getDay());
          break;
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
        case 'custom':
          startDate = new Date(customStartDate);
          break;
        default:
          return allData;
      }
      
      return (allData || []).filter(r => {
        const rDate = new Date(r.created_at || r.updated_at || 0);
        return rDate >= startDate && rDate <= new Date(customEndDate + 'T23:59:59');
      });
    };

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const updateAdvancedStats = () => {
      const filteredData = filterDataByDate(data);
      const byEmp = {};
      const knownEmps = Object.keys(appConfig.employeeNames || {});
      knownEmps.forEach(e => { 
        byEmp[e] = { count:0, sum_final:0, sum_carried:0, debtors:0, sessions:0, duration_ms:0, avg_final:0, max_final:0, min_final:0 }; 
      });

      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ø¨Ø§Ø¡
      filteredData.forEach(r => {
        const emp = r.employee || 'emp1';
        if (!byEmp[emp]) byEmp[emp] = { count:0, sum_final:0, sum_carried:0, debtors:0, sessions:0, duration_ms:0, avg_final:0, max_final:0, min_final:0 };
        byEmp[emp].count += 1;
        const finalBal = Number(r.final_balance || 0);
        byEmp[emp].sum_final += finalBal;
        byEmp[emp].sum_carried += Number(r.carried_balance || 0);
        byEmp[emp].max_final = Math.max(byEmp[emp].max_final || 0, finalBal);
        byEmp[emp].min_final = byEmp[emp].min_final === 0 ? finalBal : Math.min(byEmp[emp].min_final, finalBal);
        if (finalBal > 0) byEmp[emp].debtors += 1;
      });

      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (ØªØ·Ø¨ÙŠÙ‚ Ù†ÙØ³ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø²Ù…Ù†ÙŠ)
      const filteredUsage = filterDataByDate(usage);
      filteredUsage.forEach(u => {
        const emp = u.employee || 'emp1';
        if (!byEmp[emp]) byEmp[emp] = { count:0, sum_final:0, sum_carried:0, debtors:0, sessions:0, duration_ms:0, avg_final:0, max_final:0, min_final:0 };
        if (u.type === 'session') {
          const dur = Math.min(Number(u.duration_ms) || 0, 1000*60*60*24);
          if (dur > 0) {
            byEmp[emp].sessions = (byEmp[emp].sessions||0)+1;
            byEmp[emp].duration_ms = (byEmp[emp].duration_ms||0) + dur;
          }
        }
      });

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª
      Object.keys(byEmp).forEach(k => {
        byEmp[k].avg_final = byEmp[k].count > 0 ? Math.round(byEmp[k].sum_final / byEmp[k].count * 100) / 100 : 0;
      });

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
      const labelsIds = Object.keys(byEmp);
      const labels = labelsIds.map(id => getEmployeeLabel(id));
      const totals = labelsIds.map(k => byEmp[k].sum_final);
      const avgs = labelsIds.map(k => byEmp[k].avg_final);
      const counts = labelsIds.map(k => byEmp[k].count);
      const sessions = labelsIds.map(k => byEmp[k].sessions);
      const debtors = labelsIds.map(k => byEmp[k].debtors);

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… (Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© ÙÙ‚Ø·)
      const totalSum = Object.values(byEmp).reduce((sum, emp) => sum + (emp.sum_final || 0), 0);
      const totalCount = Object.values(byEmp).reduce((sum, emp) => sum + (emp.count || 0), 0);
      const totalSessions = Object.values(byEmp).reduce((sum, emp) => sum + (emp.sessions || 0), 0);
      const totalDebtors = Object.values(byEmp).reduce((sum, emp) => sum + (emp.debtors || 0), 0);
      const totalDuration = Object.values(byEmp).reduce((sum, emp) => sum + (emp.duration_ms || 0), 0);
      const totalHours = Math.round((totalDuration / (1000*60*60)) * 10) / 10;

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
      const noData = totalCount === 0 && totalSessions === 0;

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ HTML
      const todayStr = new Date().toISOString().split('T')[0];
      let content = '<div style="padding: 15px; direction: rtl;">';
      
      // Ø¹Ù†ÙˆØ§Ù† ÙˆØªØ§Ø±ÙŠØ®
      content += '<h2 style="text-align: center; color: #1976d2; margin: 15px 0;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ø´Ø§Ù…Ù„Ø©</h2>';
      
      // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ
      content += `<div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
        <strong>Ø§Ø®ØªØ± Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ:</strong>
        <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
          <button class="date-range-btn" data-range="today" style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; background: white;">ğŸ“… Ø§Ù„ÙŠÙˆÙ…</button>
          <button class="date-range-btn" data-range="week" style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; background: white;">ğŸ“† Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
          <button class="date-range-btn" data-range="month" style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; background: white;">ğŸ“‹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
          <button class="date-range-btn" data-range="all" style="padding: 8px 15px; border: 2px solid #1976d2; border-radius: 6px; cursor: pointer; background: #1976d2; color: white;">ğŸ”„ Ø§Ù„ÙƒÙ„</button>
          <button id="customDateBtn" style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; background: white;">ğŸ“ ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯</button>
        </div>
        <div id="customDatePicker" style="display: none; margin-top: 10px; padding: 10px; background: white; border-radius: 6px;">
          <label>Ù…Ù†: <input type="date" id="startDate" value="${customStartDate}" max="${todayStr}" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;"></label>
          <label style="margin-right: 10px;">Ø¥Ù„Ù‰: <input type="date" id="endDate" value="${customEndDate}" max="${todayStr}" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;"></label>
          <button style="padding: 5px 15px; background: #43a047; color: white; border: none; border-radius: 4px; cursor: pointer;">ØªØ·Ø¨ÙŠÙ‚</button>
        </div>
        <div id="advDateLabel" style="margin-top:8px; font-size:14px; color:#333;"></div>
      </div>`;
      
      // Ù…Ù„Ø®Øµ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© (KPIs) - Ù…Ø­Ø³Ù‘Ù† ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ
      content += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 18px; margin-bottom: 25px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(102, 126, 234, 0.3)';">
          <div style="font-size: 13px; opacity: 0.9; font-weight: 600; letter-spacing: 0.5px;">ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div>
          <div style="font-size: 36px; font-weight: 900; margin-top: 12px; font-family: 'Arial', sans-serif;">${formatCurrency(totalSum)}</div>
        </div>
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(245, 87, 108, 0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(245, 87, 108, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(245, 87, 108, 0.3)';">
          <div style="font-size: 13px; opacity: 0.9; font-weight: 600; letter-spacing: 0.5px;">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
          <div style="font-size: 36px; font-weight: 900; margin-top: 12px;">${totalCount}</div>
          <div style="font-size: 11px; opacity: 0.85; margin-top: 8px;">Ø¹Ø¯Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</div>
        </div>
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(79, 172, 254, 0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(79, 172, 254, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(79, 172, 254, 0.3)';">
          <div style="font-size: 13px; opacity: 0.9; font-weight: 600; letter-spacing: 0.5px;">âš ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†</div>
          <div style="font-size: 36px; font-weight: 900; margin-top: 12px;">${totalDebtors}</div>
          <div style="font-size: 11px; opacity: 0.85; margin-top: 8px;">Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø°ÙŠÙ† Ø¹Ù„ÙŠÙ‡Ù… Ø¯ÙŠÙˆÙ†</div>
        </div>
        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(67, 233, 123, 0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(67, 233, 123, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(67, 233, 123, 0.3)';">
          <div style="font-size: 13px; opacity: 0.9; font-weight: 600; letter-spacing: 0.5px;">â±ï¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</div>
          <div style="font-size: 36px; font-weight: 900; margin-top: 12px;">${totalHours}</div>
          <div style="font-size: 11px; opacity: 0.85; margin-top: 8px;">Ø³Ø§Ø¹Ø©</div>
        </div>
        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(250, 112, 154, 0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(250, 112, 154, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(250, 112, 154, 0.3)';">
          <div style="font-size: 13px; opacity: 0.9; font-weight: 600; letter-spacing: 0.5px;">ğŸ”” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</div>
          <div style="font-size: 36px; font-weight: 900; margin-top: 12px;">${totalSessions}</div>
          <div style="font-size: 11px; opacity: 0.85; margin-top: 8px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
        </div>
        <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(168, 237, 234, 0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(168, 237, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(168, 237, 234, 0.3)';">
          <div style="font-size: 13px; opacity: 0.8; font-weight: 600; letter-spacing: 0.5px;">ğŸ“ˆ Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
          <div style="font-size: 36px; font-weight: 900; margin-top: 12px;">${formatCurrency(totalCount > 0 ? Math.round(totalSum / totalCount * 100) / 100 : 0)}</div>
          <div style="font-size: 11px; opacity: 0.85; margin-top: 8px;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±ØµÙŠØ¯</div>
        </div>
      </div>`;

      // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
      content += `<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
        <strong>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ:</strong>
        <div style="display:inline-flex; gap:5px; margin-right:15px; vertical-align:middle;">
            <button class="chart-type-btn ${currentChartType==='bar'?'active':''}" data-type="bar">ğŸ“Š Ø£Ø¹Ù…Ø¯Ø©</button>
            <button class="chart-type-btn ${currentChartType==='line'?'active':''}" data-type="line">ğŸ“ˆ Ø®Ø·ÙŠ</button>
            <button class="chart-type-btn ${currentChartType==='pie'?'active':''}" data-type="pie">ğŸ¥§ Ø¯Ø§Ø¦Ø±ÙŠ</button>
            <button class="chart-type-btn ${currentChartType==='doughnut'?'active':''}" data-type="doughnut">ğŸ© Ø¯ÙˆÙ†Ø§Øª</button>
            <button class="chart-type-btn ${currentChartType==='radar'?'active':''}" data-type="radar">ğŸ“¡ Ø±Ø§Ø¯Ø§Ø±</button>
        </div>

        <select id="chartDataType" style="padding: 8px 12px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
          <option value="sum">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</option>
          <option value="avg">Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
          <option value="count">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</option>
          <option value="debtors">Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†</option>
        </select>
        <button onclick="renderAdvCharts()" class="btn" style="padding: 8px 15px; display: inline-block; width: auto;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…</button>
      </div>`;

      // Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      content += `<h3 style="color: #1976d2; margin-top: 20px; font-size: 20px; font-weight: 700;">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <table class="excel-preview-table" style="width: 100%; margin-bottom: 20px;">
          <thead>
            <tr style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white;">
              <th style="font-size: 16px;">Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th style="font-size: 16px;">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</th>
              <th style="font-size: 16px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
              <th style="font-size: 16px;">Ø§Ù„Ù…ØªÙˆØ³Ø·</th>
              <th style="font-size: 16px;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th>
              <th style="font-size: 16px;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
              <th style="font-size: 16px;">Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†</th>
              <th style="font-size: 16px;">Ø§Ù„Ø¬Ù„Ø³Ø§Øª</th>
              <th style="font-size: 16px;">Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
            </tr>
          </thead>
          <tbody>`;
      
      labelsIds.forEach(k => {
        const hrs = Math.round(((byEmp[k].duration_ms||0) / (1000*60*60)) * 10) / 10;
        const minVal = byEmp[k].min_final === 0 && byEmp[k].count === 0 ? 0 : byEmp[k].min_final;
        const isDebtorRow = byEmp[k].debtors > 0;
        content += `<tr style="${isDebtorRow ? 'background: #fff3e0;' : ''}">
          <td style="font-weight: bold; color: #1976d2; font-size: 15px;">${getEmployeeLabel(k)}</td>
          <td style="font-size: 15px; font-weight: 600;">${byEmp[k].count}</td>
          <td style="color: ${byEmp[k].sum_final > 0 ? '#d32f2f' : '#43a047'}; font-weight: bold; font-size: 15px;">${formatCurrency(byEmp[k].sum_final)}</td>
          <td style="font-size: 15px; font-weight: 600;">${formatCurrency(byEmp[k].avg_final)}</td>
          <td style="color: #d32f2f; font-size: 15px; font-weight: 600;">${formatCurrency(byEmp[k].max_final)}</td>
          <td style="color: #43a047; font-size: 15px; font-weight: 600;">${formatCurrency(minVal)}</td>
          <td style="background: ${byEmp[k].debtors > 0 ? '#ffcdd2' : '#c8e6c9'}; font-weight: bold; font-size: 15px; color: #333;">${byEmp[k].debtors}</td>
          <td style="font-size: 15px; font-weight: 600;">${byEmp[k].sessions || 0}</td>
          <td style="font-size: 15px; font-weight: 600;">${hrs}</td>
        </tr>`;
      });
      
      content += '</tbody></table>';

      // Ø±Ø³Ø§Ù„Ø© ÙˆØ¯ÙŠØ© Ø¹Ù†Ø¯Ù…Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
      if (noData) {
        content += `<div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 20px; margin: 15px 0; text-align: center; color: #2e7d32;">
          <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <div style="font-size: 14px; opacity: 0.9;">Ù„Ù… Ù†Ø¬Ø¯ Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª Ø£Ùˆ Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯.</div>
        </div>`;
      } else if (labelsIds.length === 0) {
        content += `<div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 20px; margin: 15px 0; text-align: center; color: #e65100;">
          <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡</div>
          <div style="font-size: 14px; opacity: 0.9;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ¸ÙÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ù…. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.</div>
        </div>`;
      }

      // Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
      content += `<h3 style="color: #1976d2; margin-top: 20px; font-size: 20px; font-weight: 700;">ğŸ“ˆ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <canvas id="advChart1" style="max-width: 100%;"></canvas>
          </div>
          <div>
            <canvas id="advChart2" style="max-width: 100%;"></canvas>
          </div>
        </div>`;

      content += '</div>';
      
      document.getElementById('advStatsContent').innerHTML = content;

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      document.querySelectorAll('.date-range-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.date-range-btn').forEach(b => b.style.borderColor = '#ddd');
          document.querySelectorAll('.date-range-btn').forEach(b => b.style.background = 'white');
          document.querySelectorAll('.date-range-btn').forEach(b => b.style.color = '#333');
          btn.style.borderColor = '#1976d2';
          btn.style.background = '#1976d2';
          btn.style.color = 'white';
          selectedDateRange = btn.dataset.range;
          if (selectedDateRange !== 'custom') {
            document.getElementById('customDatePicker').style.display = 'none';
          }
          updateAdvancedStats();
        });
      });

      // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª
      document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentChartType = btn.dataset.type;
            renderAdvCharts();
        });
      });

      document.getElementById('customDateBtn').addEventListener('click', () => {
        const picker = document.getElementById('customDatePicker');
        picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
        if (picker.style.display === 'block') {
          selectedDateRange = 'custom';
          document.querySelectorAll('.date-range-btn').forEach(b => {
            b.style.borderColor = '#ddd';
            b.style.background = 'white';
            b.style.color = '#333';
          });
          document.getElementById('customDateBtn').style.borderColor = '#1976d2';
          document.getElementById('customDateBtn').style.background = '#1976d2';
          document.getElementById('customDateBtn').style.color = 'white';
        }
      });

      const applyBtn = document.querySelector('#customDatePicker button');
      if (applyBtn) {
        applyBtn.addEventListener('click', () => {
          customStartDate = document.getElementById('startDate').value;
          customEndDate = document.getElementById('endDate').value;
          document.getElementById('customDatePicker').style.display = 'none';
          selectedDateRange = 'custom';
          updateAdvancedStats();
        });
      }

      // Ø±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
      window.renderAdvCharts = () => {
        const chartType = currentChartType;
        const dataType = document.getElementById('chartDataType')?.value || 'sum';
        
        let chartData = totals, label = 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ';
        if (dataType === 'avg') { chartData = avgs; label = 'Ø§Ù„Ù…ØªÙˆØ³Ø·'; }
        else if (dataType === 'count') { chartData = counts; label = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª'; }
        else if (dataType === 'debtors') { chartData = debtors; label = 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†'; }

        // Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø£ÙˆÙ„
        try {
          const ctx1 = document.getElementById('advChart1');
          if (!ctx1) return;
          if (window._advChart1) window._advChart1.destroy();
          
          const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'];
          window._advChart1 = new Chart(ctx1, {
            type: chartType,
            data: { 
              labels,
              datasets: [{ 
                label, 
                data: chartData,
                backgroundColor: colors.slice(0, labels.length),
                borderColor: colors.slice(0, labels.length),
                borderWidth: 2,
                fill: chartType === 'line' ? false : true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: { display: chartType === 'pie' || chartType === 'doughnut', labels: { font: { size: 12 } } },
                title: { display: true, text: label + ' - Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', font: { size: 14, weight: 'bold' } }
              },
              scales: (chartType === 'pie' || chartType === 'doughnut') ? {} : {
                y: { beginAtZero: true, ticks: { font: { size: 11 } } },
                x: { ticks: { font: { size: 11 } } }
              }
            }
          });
        } catch(e) { console.error('Chart 1 error:', e); }

        // Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ - Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        try {
          const ctx2 = document.getElementById('advChart2');
          if (!ctx2) return;
          if (window._advChart2) window._advChart2.destroy();
          
          const colors2 = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7dc6f', '#bb8fce', '#85c1e2'];
          const secondDataType = dataType === 'sum' ? 'count' : 'sum';
          const secondLabel = secondDataType === 'sum' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ' : 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª';
          const secondData = secondDataType === 'sum' ? totals : counts;
          
          window._advChart2 = new Chart(ctx2, {
            type: chartType === 'pie' || chartType === 'doughnut' ? 'bar' : chartType,
            data: {
              labels,
              datasets: [{
                label: secondLabel,
                data: secondData,
                backgroundColor: colors2.slice(0, labels.length),
                borderColor: colors2.slice(0, labels.length),
                borderWidth: 2,
                fill: chartType === 'line' ? false : true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: secondLabel, font: { size: 14, weight: 'bold' } }
              },
              scales: (chartType === 'pie' || chartType === 'doughnut') ? {} : {
                y: { beginAtZero: true, ticks: { font: { size: 11 } } },
                x: { ticks: { font: { size: 11 } } }
              }
            }
          });
        } catch(e) { console.error('Chart 2 error:', e); }
      };

      renderAdvCharts();
    };

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const html = `<div style="padding: 0; direction: rtl;">
      <div class="controls" style="background: white; padding: 15px; border-bottom: 2px solid #1976d2; justify-content: space-between;">
        <h2 style="margin: 0; color: #1976d2;">ğŸ¯ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ø´Ø§Ù…Ù„Ø©</h2>
        <div>
          <button class="btn" onclick="saveStatsPDF('advStatsScreen')" style="width: auto; padding: 10px 20px; margin-left: 10px;">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button>
          <button class="btn btn-secondary" onclick="closeAdvancedStats()" style="width: auto; padding: 10px 20px;">âœ– Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div id="advStatsContent" style="max-height: 65vh; overflow-y: auto;"></div>
    </div>`;

    const screen = document.createElement('div');
    screen.className = 'center-screen';
    screen.id = 'advStatsScreen';
    screen.style.zIndex = 520;
    screen.innerHTML = `<div class="box box-large stats-box" style="width: 98%; max-width: none; height: 98%; max-height: 98vh; overflow-y: auto;">${html}</div>`;
    document.body.appendChild(screen);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    updateAdvancedStats();
  };

  window.closeAdvancedStats = () => { const s = document.getElementById('advStatsScreen'); if (s) s.remove(); };

  // Ø­ÙØ¸ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ€ PDF (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… html2canvas + jsPDF)
  window.saveStatsPDF = async (screenId) => {
    try {
      const screen = document.getElementById(screenId);
      if (!screen) return alert('Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
      const box = screen.querySelector('.box') || screen;
      
      // Ø­ÙØ¸ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø£ØµÙ„ÙŠØ©
      const originalOverflow = box.style.overflow;
      const originalHeight = box.style.height;
      const originalMaxHeight = box.style.maxHeight;

      // ØªÙˆØ³ÙŠØ¹ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„ÙŠØ´Ù…Ù„ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      box.style.overflow = 'visible';
      box.style.height = 'auto';
      box.style.maxHeight = 'none';

      const canvas = await html2canvas(box, { scale: 1.5, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const imgProps = pdf.getImageProperties(imgData);
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save('statistics.pdf');

      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
      box.style.overflow = originalOverflow;
      box.style.height = originalHeight;
      box.style.maxHeight = originalMaxHeight;
    } catch (e) {
      console.error('saveStatsPDF failed', e);
      alert('ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù€ PDF');
    }
  };

  window.togglePasteArea = () => {
    const area = document.getElementById('excelPasteArea');
    area.style.display = area.style.display === 'none' ? 'block' : 'none';
    if(area.style.display === 'block') area.focus();
  };

  // Ø¯Ø§Ù„Ø© ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ø¯ÙŠØ¯
  window.clearGridForNewEntry = () => {
    document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>';
    const pasteArea = document.getElementById('excelPasteArea');
    pasteArea.value = '';
    pasteArea.style.display = 'block';
    pasteArea.focus();
  };

  // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  window.deleteEmployeeDataDB = async () => {
    const emp = document.getElementById('importEmpSelect').value;
    const empName = getEmployeeLabel(emp);
    
    if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ (${empName}) Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) return;
    
    const { error } = await supabase.from('parents').delete().eq('employee', emp);
    
    if (error) {
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message);
    } else {
      alert(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª ${empName} Ø¨Ù†Ø¬Ø§Ø­.`);
      document.getElementById('gridContainer').innerHTML = '<p style="text-align:center; padding:20px; color:red;">ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
      document.getElementById('excelPasteArea').value = '';
    }
  };

  // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø±Ù‚Ù… Ø¹Ø±Ø¨ÙŠ/ÙØ§Ø±Ø³ÙŠ/Ù„ØºÙˆÙŠ Ø¥Ù„Ù‰ Ø±Ù‚Ù… JS ØµØ§Ù„Ø­
  const cleanNumber = (input) => {
    if (input === null || input === undefined) return 0;
    let s = input.toString().trim();

    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/Ø§Ù„ÙØ§Ø±Ø³ÙŠØ© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    const map = {
      'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9',
      'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'
    };
    s = s.replace(/[Ù -Ù©Û°-Û¹]/g, d => map[d] || d);

    // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ© ÙˆÙ…Ø³Ø§ÙØ§Øª Ø®Ø§ØµØ©
    s = s.replace(/[\u200B\u200C\u200E\u200F\u202F\s\u00A0]/g, '');

    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø­Ø§Ø±Ù Ø§Ù„ÙØ§ØµÙ„/Ø£Ù„ÙÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
    s = s.replace(/[\u066C\u060C]/g, ''); // Ø£Ù„ÙÙŠØ© Ø¹Ø±Ø¨ÙŠØ© Ùˆ0C (ØŒ)
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø¹Ø´Ø±ÙŠ Ø§Ù„Ø¹Ø±Ø¨ÙŠ (U+066B) ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù†Ù‚Ø·Ø©
    s = s.replace(/\u066B/g, '.');

    // Ù„Ùˆ Ø§Ù„Ù†Øµ ÙŠØ­ØªÙˆÙŠ ÙƒÙ„Ø§Ù‹ Ù…Ù† '.' Ùˆ','ØŒ Ù†Ù‚Ø±Ø± Ø£ÙŠÙ‡Ù…Ø§ ÙØ§ØµÙ„ Ø¹Ø´Ø±ÙŠ Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±
    if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
      if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
        // Ù†Ù…Ø·: 1.234,56 -> Ø§Ø­Ø°Ù Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ù„Ù ÙˆØ§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨Ø¹Ø´Ø±ÙŠØ©
        s = s.replace(/\./g, '');
        s = s.replace(/,/g, '.');
      } else {
        // Ù†Ù…Ø·: 1,234.56 -> Ø§Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØµÙ„
        s = s.replace(/,/g, '');
      }
    } else if (s.indexOf(',') !== -1 && s.indexOf('.') === -1) {
      // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø·Ø© Ù„ÙƒÙ† ØªÙˆØ¬Ø¯ ÙØ§ØµÙ„Ø© => Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ ÙØ§ØµÙ„ Ø¹Ø´Ø±ÙŠ
      s = s.replace(/,/g, '.');
    } else {
      // Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØµÙ„Ø© Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ø¶Ø­Ø©ØŒ Ø£Ø­Ø°Ù Ø£ÙŠ ÙÙˆØ§ØµÙ„ Ø¢Ù„Ø§Ù Ù…Ø­ØªÙ…Ù„Ø©
      s = s.replace(/,/g, '');
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø­Ø§Ø±Ù ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ© Ø£Ùˆ Ù†Ù‚Ø·Ø© Ø£Ùˆ Ø³Ø§Ù„Ø¨
    s = s.replace(/[^0-9.\-]/g, '');

    const num = parseFloat(s);
    return isNaN(num) ? 0 : num;
  };

  window.loadDataToGrid = async () => {
    const emp = document.getElementById('importEmpSelect').value;
    document.getElementById('gridContainer').innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
    
    const { data, error } = await supabase.from("parents").select("*").eq("employee", emp).order("serial_no");
    
    if(error) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"); return; }
    renderGrid(data);
    document.getElementById('excelPasteArea').style.display = 'none';
  };

  window.convertPasteToGrid = () => {
    const text = document.getElementById('excelPasteArea').value;
    const rows = text.split("\n");
    const data = [];

    rows.forEach(row => {
      if (!row.trim()) return;
      const c = row.split("\t");
      if (isNaN(parseInt(c[0]))) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†

      data.push({
        serial_no: c[0],
        parent_code: c[1],
        parent_name: c[2],
        identity_no: c[3],
        phone: c[4],
        carried_balance: cleanNumber(c[5]),
        term1_balance: cleanNumber(c[6]),
        term2_balance: cleanNumber(c[7]),
        final_balance: cleanNumber(c[8])
      });
    });
    renderGrid(data);
  };

  function renderGrid(data) {
    let html = `<table class="excel-preview-table">
      <thead>
        <tr>
          <th>Ø­Ø°Ù</th><th>Ù…</th><th>Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
          <th>Ø§Ù„Ù…Ø¯ÙˆØ±</th><th>Ù1</th><th>Ù2</th><th>Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
        </tr>
      </thead><tbody>`;
    
    data.forEach((row, index) => {
      html += `<tr>
        <td><button onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;cursor:pointer;">âœ–</button></td>
        <td contenteditable="true">${row.serial_no || ''}</td>
        <td contenteditable="true">${row.parent_code || ''}</td>
        <td contenteditable="true">${row.parent_name || ''}</td>
        <td contenteditable="true">${row.identity_no || ''}</td>
        <td contenteditable="true">${row.phone || ''}</td>
        <td contenteditable="true">${row.carried_balance || 0}</td>
        <td contenteditable="true">${row.term1_balance || 0}</td>
        <td contenteditable="true">${row.term2_balance || 0}</td>
        <td contenteditable="true" style="font-weight:bold;">${row.final_balance || 0}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('gridContainer').innerHTML = html;
  }

  window.saveSettingsAndData = async (shouldClose, btnElement) => {
    // 1. Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„)
    await saveAppSettings();

    // 2. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const emp = document.getElementById('importEmpSelect').value;
    const table = document.querySelector('#gridContainer table tbody');
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¥Ù† ÙˆØ¬Ø¯)
    const newRecords = [];
    if (table && table.querySelectorAll('tr').length > 0) {
      const rows = table.querySelectorAll('tr');
      rows.forEach(tr => {
        const cells = tr.querySelectorAll('td');
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª
        if (cells.length > 1) {
            newRecords.push({
            employee: emp,
            serial_no: parseInt(cells[1].innerText) || 0,
            parent_code: cells[2].innerText,
            parent_name: cells[3].innerText,
            identity_no: cells[4].innerText,
            phone: cells[5].innerText,
            carried_balance: cleanNumber(cells[6].innerText),
            term1_balance: cleanNumber(cells[7].innerText),
            term2_balance: cleanNumber(cells[8].innerText),
            final_balance: cleanNumber(cells[9].innerText)
            });
        }
      });
    }

    // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ ØªØ£ÙƒÙŠØ¯ Ù…Ø²Ø¹Ø¬Ø©)
    const { error: delError } = await supabase.from('parents').delete().eq('employee', emp);
    
    if (delError) {
      console.error(delError);
      alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ' + delError.message);
      return;
    }

    // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (newRecords.length > 0) {
      const { error: insError } = await supabase.from('parents').insert(newRecords);
      if (insError) {
        console.error(insError);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ' + insError.message);
        return;
      }
    }

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø£Ùˆ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    if (shouldClose) {
      closeSettings();
    } else {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„ÙŠØ¹Ø·ÙŠ Ø¥Ø´Ø§Ø±Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¤Ù‚ØªØ©
      if(btnElement) {
        const originalText = btnElement.innerText;
        const originalBg = btnElement.style.background;
        btnElement.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…";
        btnElement.style.background = "#4caf50"; // Ù„ÙˆÙ† Ø£Ø®Ø¶Ø±
        setTimeout(() => {
          btnElement.innerText = originalText;
          btnElement.style.background = originalBg;
        }, 1500);
      }
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      await loadDataToGrid();
    }
  };

  // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ---

  window.openAdminPanel = () => {
    const pass = prompt("ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
    if (pass === "admin123") {
      document.getElementById("adminScreen").style.display = "flex";
      loadAdminData();
    } else if (pass !== null) {
      alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");
    }
  };

  window.closeAdminPanel = () => {
    document.getElementById("adminScreen").style.display = "none";
  };

  window.loadAdminData = async () => {
    const textarea = document.getElementById("adminDataInput");
    textarea.value = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

    const { data, error } = await supabase
      .from("parents")
      .select("*")
      .order("employee")
      .order("serial_no");

    if (error) {
      textarea.value = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„!";
      console.error(error);
      return;
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù†Øµ (TSV)
    // Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…ÙˆØ¸Ù - Ù… - Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„ÙŠ - Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ù‡ÙˆÙŠØ© - Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„Ù…Ø¯ÙˆØ± - Ù1 - Ù2 - Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    let text = "Ø§Ù„Ù…ÙˆØ¸Ù\tÙ…\tØ±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±\tØ§Ù„Ø§Ø³Ù…\tØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©\tØ§Ù„Ø¬ÙˆØ§Ù„\tØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙˆØ±\tØ±ØµÙŠØ¯ Ù1\tØ±ØµÙŠØ¯ Ù2\tØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ\n";
    
    data.forEach(row => {
      text += `${row.employee || ''}\t${row.serial_no || ''}\t${row.parent_code || ''}\t${row.parent_name || ''}\t${row.identity_no || ''}\t${row.phone || ''}\t${row.carried_balance || 0}\t${row.term1_balance || 0}\t${row.term2_balance || 0}\t${row.final_balance || 0}\n`;
    });

    textarea.value = text;
  };

  window.saveAdminDataFull = async () => {
    if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹!")) return;

    const rawText = document.getElementById("adminDataInput").value;
    const rows = rawText.split("\n");
    const newRecords = [];

    // Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© (ØªØ¹Ø§Ø¯Ù„ÙŠØ© Ù…Ø¹ cleanNumber)
    const parseNum = (str) => {
      return cleanNumber(str);
    };

    for (let i = 0; i < rows.length; i++) {
      const line = rows[i].trim();
      if (!line) continue;
      
      const cols = line.split("\t");
      // ØªØ®Ø·ÙŠ Ø³Ø·Ø± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„ÙŠØ³ Ø±Ù‚Ù…Ø§Ù‹)
      if (isNaN(parseInt(cols[1]))) continue;

      newRecords.push({
        employee: cols[0]?.trim() || 'emp1', // Ø§ÙØªØ±Ø§Ø¶ÙŠ
        serial_no: parseInt(cols[1]) || 0,
        parent_code: cols[2] || "",
        parent_name: cols[3] || "",
        identity_no: cols[4] || "",
        phone: cols[5] || "",
        carried_balance: parseNum(cols[6]),
        term1_balance: parseNum(cols[7]),
        term2_balance: parseNum(cols[8]),
        final_balance: parseNum(cols[9])
      });
    }

    // 1. Ø­Ø°Ù Ø§Ù„ÙƒÙ„
    const { error: delError } = await supabase.from("parents").delete().neq('id', -1); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø´Ø±Ø· ØµØ­ÙŠØ­ Ù„Ù„Ø­Ø°Ù
    
    if (delError) {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©! Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£Ù„ØºÙŠØª.");
      console.error(delError);
      return;
    }

    // 2. Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    if (newRecords.length > 0) {
      const { error: insError } = await supabase.from("parents").insert(newRecords);
      if (insError) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!");
        console.error(insError);
      } else {
        alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! (${newRecords.length} Ø³Ø¬Ù„) âœ…`);
        closeAdminPanel();
      }
    } else {
      alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ§Ø±Øº).");
      closeAdminPanel();
    }
  };

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  document.getElementById('importEmpSelect').addEventListener('change', () => {
    loadDataToGrid();
  });

  // Init
  loadSettings();
</script>

</body>
</html>

<!-- Developer credit (top-right small) -->
<style>
  #appFooter { position:fixed; top:8px; right:12px; background:transparent; color:#666; padding:6px 10px; text-align:right; font-weight:600; font-size:12px; border-radius:6px; z-index:400; }
  #appFooter a { color:#1976d2; font-weight:600; text-decoration:none; }
  @media (max-width:600px){ #appFooter { font-size:11px; top:6px; right:8px; } }
</style>
<div id="appFooter">ØªØ·ÙˆÙŠØ± ÙˆØªØµÙ…ÙŠÙ…: <span style="font-weight:700;color:#333;">Ø£. Ø£Ø­Ù…Ø¯ Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù„Ù‡</span> Â· <a href="mailto:designissue@gmail.com">designissue@gmail.com</a></div>
iv>
